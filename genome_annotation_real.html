<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºå› ç»„æ³¨é‡Š - è€è¯åŸºå› åˆ†æå¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6741);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) translateX(-3px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .api-status {
            background: rgba(40, 167, 69, 0.2);
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-area {
            text-align: center;
            padding: 40px 20px;
        }

        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .file-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .options-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .options-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .analyze-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .analyze-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-text {
            text-align: center;
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 15px;
        }

        .log-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
        }

        .results-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .download-section {
            margin-top: 30px;
            text-align: center;
        }

        .download-button {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .restart-button {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .restart-button:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">â† è¿”å›ä¸»é¡µ</a>
            <h1>ğŸ§¬ åŸºå› ç»„æ³¨é‡Š</h1>
            <p>ä½¿ç”¨Galaxyå¹³å°çš„çœŸå®AMRFinderè¿›è¡Œè€è¯åŸºå› æ³¨é‡Š</p>
            <div class="api-status" id="apiStatus">
                <strong>ğŸ”— è¿æ¥çŠ¶æ€ï¼š</strong> æ­£åœ¨æ£€æŸ¥Galaxyè¿æ¥...
            </div>
        </div>

        <div class="main-content">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-area">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">
                        æ‹–æ‹½FASTAæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                    </div>
                    <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                        é€‰æ‹©åŸºå› ç»„æ–‡ä»¶
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".fasta,.fa,.fas,.fna" multiple>
                    <div class="file-info" id="fileInfo">
                        <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong>
                        <div id="fileList"></div>
                    </div>
                </div>
            </div>

            <!-- åˆ†æé€‰é¡¹ -->
            <div class="options-section">
                <div class="options-title">
                    âš™ï¸ åˆ†æå‚æ•°
                </div>
                <div class="form-group">
                    <label for="organismSelect">ç”Ÿç‰©ä½“ç±»å‹ï¼š</label>
                    <select id="organismSelect">
                        <option value="Bacteria">ç»†èŒ (Bacteria)</option>
                        <option value="Salmonella">æ²™é—¨æ°èŒ (Salmonella)</option>
                        <option value="Escherichia">å¤§è‚ æ†èŒ (Escherichia)</option>
                        <option value="Klebsiella">å…‹é›·ä¼¯æ°èŒ (Klebsiella)</option>
                        <option value="Enterococcus">è‚ çƒèŒ (Enterococcus)</option>
                        <option value="Staphylococcus">è‘¡è„çƒèŒ (Staphylococcus)</option>
                    </select>
                </div>
                <button class="analyze-button" id="analyzeButton" onclick="startAnalysis()" disabled>
                    å¼€å§‹åˆ†æ
                </button>
                <button class="analyze-button" onclick="startDemoAnalysis()" style="background: linear-gradient(135deg, #17a2b8, #138496); margin-top: 10px;">
                    ğŸ“Š æ¼”ç¤ºåˆ†æ
                </button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-section" id="progressSection">
                <div class="status-text" id="statusText">å‡†å¤‡å¼€å§‹åˆ†æ...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div style="text-align: center;">
                    <span id="progressPercent">0%</span>
                </div>
                <div class="log-section" id="logSection">
                    <div>åˆ†ææ—¥å¿—ï¼š</div>
                </div>
                <button class="restart-button" onclick="restartAnalysis()">é‡æ–°å¼€å§‹</button>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="results-section" id="resultsSection">
                <div class="results-title">
                    ğŸ“Š AMRFinderåˆ†æç»“æœ
                </div>
                
                <div class="results-stats" id="resultsStats">
                    <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>

                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>åŸºå› ç¬¦å·</th>
                            <th>åºåˆ—åç§°</th>
                            <th>æŠ—ç”Ÿç´ ç±»åˆ«</th>
                            <th>è¦†ç›–åº¦</th>
                            <th>ç›¸ä¼¼åº¦</th>
                            <th>å…ƒç´ ç±»å‹</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- ç»“æœæ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </tbody>
                </table>

                <div class="download-section">
                    <a href="#" class="download-button" id="downloadButton" onclick="downloadResults()">
                        ğŸ“¥ ä¸‹è½½å®Œæ•´ç»“æœ
                    </a>
                    <button class="restart-button" onclick="restartAnalysis()">åˆ†ææ–°æ–‡ä»¶</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let currentJobId = null;
        let currentDatasetId = null;
        let currentHistoryId = null;
        let analysisResults = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åŸºå› ç»„æ³¨é‡Šæ¨¡å—å·²åŠ è½½');
            checkGalaxyConnection();
            initializeEventListeners();
        });

        // æ£€æŸ¥Galaxyè¿æ¥
        async function checkGalaxyConnection() {
            try {
                const response = await fetch('/api/test-galaxy');
                const result = await response.json();
                
                const statusDiv = document.getElementById('apiStatus');
                if (result.success) {
                    statusDiv.innerHTML = `
                        <strong>âœ… Galaxyè¿æ¥æ­£å¸¸</strong><br>
                        ç‰ˆæœ¬: ${result.galaxy_version.version_major}.${result.galaxy_version.version_minor} | 
                        APIå¯†é’¥æœ‰æ•ˆ
                    `;
                    statusDiv.style.background = 'rgba(40, 167, 69, 0.2)';
                    statusDiv.style.color = '#155724';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Galaxyè¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                const statusDiv = document.getElementById('apiStatus');
                statusDiv.innerHTML = `
                    <strong>âŒ Galaxyè¿æ¥å¤±è´¥</strong><br>
                    é”™è¯¯: ${error.message}
                `;
                statusDiv.style.background = 'rgba(220, 53, 69, 0.2)';
                statusDiv.style.color = '#721c24';
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            // æ‹–æ‹½ä¸Šä¼ 
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => {
                const validExtensions = ['.fasta', '.fa', '.fas', '.fna'];
                return validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            });

            if (selectedFiles.length === 0) {
                showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„FASTAæ ¼å¼æ–‡ä»¶ï¼ˆ.fasta, .fa, .fas, .fnaï¼‰');
                return;
            }

            if (selectedFiles.length > 1) {
                showError('å½“å‰ç‰ˆæœ¬åªæ”¯æŒå•ä¸ªæ–‡ä»¶åˆ†æï¼Œè¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
                selectedFiles = [selectedFiles[0]];
            }

            displayFileInfo();
            document.getElementById('analyzeButton').disabled = false;
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function displayFileInfo() {
            const file = selectedFiles[0];
            const fileList = document.getElementById('fileList');
            const fileInfo = document.getElementById('fileInfo');

            fileList.innerHTML = `
                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                    <strong>${file.name}</strong> 
                    <span style="color: #6c757d;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">
                        æ–‡ä»¶ç±»å‹: ${file.type || 'text/plain'}
                    </div>
                </div>
            `;

            fileInfo.style.display = 'block';
        }

        // å¼€å§‹åˆ†æ
        async function startAnalysis() {
            if (selectedFiles.length === 0) {
                showError('è¯·å…ˆé€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦ç•Œé¢
            document.getElementById('uploadSection').style.display = 'none';
            document.querySelector('.options-section').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            hideError();

            try {
                // æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶
                await uploadFile();
                
                // æ­¥éª¤2: è¿è¡ŒAMRFinder
                await runAMRFinder();
                
                // æ­¥éª¤3: ç­‰å¾…åˆ†æå®Œæˆ
                await waitForCompletion();
                
                // æ­¥éª¤4: è·å–ç»“æœ
                await getResults();

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                showError('åˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            updateProgress('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°Galaxy...', 10);
            addLog('å¼€å§‹ä¸Šä¼ æ–‡ä»¶: ' + selectedFiles[0].name);

            const formData = new FormData();
            formData.append('file', selectedFiles[0]);

            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error);
            }

            currentDatasetId = result.dataset_id;
            currentHistoryId = result.history_id;
            addLog('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ•°æ®é›†ID: ' + currentDatasetId);
            addLog('å†å²è®°å½•ID: ' + currentHistoryId);
            updateProgress('æ–‡ä»¶ä¸Šä¼ å®Œæˆ', 25);
        }

        // è¿è¡ŒAMRFinder
        async function runAMRFinder() {
            updateProgress('æ­£åœ¨å¯åŠ¨AMRFinderåˆ†æ...', 30);
            addLog('å¼€å§‹AMRFinderåˆ†æ');

            const organism = document.getElementById('organismSelect').value;
            
            const response = await fetch('/api/run-amrfinder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dataset_id: currentDatasetId,
                    history_id: currentHistoryId,
                    organism: organism
                })
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error);
            }

            currentJobId = result.job_id;
            addLog('AMRFinderä»»åŠ¡å·²æäº¤ï¼Œä»»åŠ¡ID: ' + currentJobId);
            updateProgress('AMRFinderåˆ†æå·²å¯åŠ¨', 35);
        }

        // ç­‰å¾…åˆ†æå®Œæˆ
        async function waitForCompletion() {
            updateProgress('æ­£åœ¨åˆ†æä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...', 40);
            addLog('ç­‰å¾…åˆ†æå®Œæˆ...');

            const maxAttempts = 120; // æœ€å¤šç­‰å¾…20åˆ†é’Ÿ
            let attempts = 0;

            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 10000)); // ç­‰å¾…10ç§’
                
                const response = await fetch(`/api/job-status/${currentJobId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const state = result.state;
                addLog(`ä»»åŠ¡çŠ¶æ€: ${state}`);

                if (state === 'ok') {
                    updateProgress('åˆ†æå®Œæˆï¼', 80);
                    addLog('åˆ†ææˆåŠŸå®Œæˆ');
                    return;
                } else if (state === 'error') {
                    throw new Error('AMRFinderåˆ†æå¤±è´¥');
                } else if (state === 'paused') {
                    throw new Error('åˆ†æè¢«æš‚åœ');
                }

                // æ›´æ–°è¿›åº¦
                const progress = 40 + (attempts / maxAttempts) * 40;
                updateProgress(`åˆ†æè¿›è¡Œä¸­... (${attempts + 1}/${maxAttempts})`, progress);
                
                attempts++;
            }

            throw new Error('åˆ†æè¶…æ—¶ï¼Œè¯·é‡è¯•');
        }

        // è·å–ç»“æœ
        async function getResults() {
            updateProgress('æ­£åœ¨è·å–åˆ†æç»“æœ...', 85);
            addLog('è·å–åˆ†æç»“æœ');

            // ä»ä»»åŠ¡ä¿¡æ¯ä¸­è·å–è¾“å‡ºæ•°æ®é›†ID
            const jobResponse = await fetch(`/api/job-status/${currentJobId}`);
            const jobResult = await jobResponse.json();

            if (!jobResult.success) {
                throw new Error('æ— æ³•è·å–ä»»åŠ¡ä¿¡æ¯');
            }

            // è·å–è¾“å‡ºæ•°æ®é›†
            const outputs = jobResult.job_info.outputs;
            let resultDatasetId = null;

            // å¯»æ‰¾AMRFinderçš„ä¸»è¦è¾“å‡º
            for (const [key, dataset] of Object.entries(outputs)) {
                if (key.includes('report') || key.includes('output')) {
                    resultDatasetId = dataset.id;
                    break;
                }
            }

            if (!resultDatasetId) {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šçš„è¾“å‡ºï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª
                resultDatasetId = Object.values(outputs)[0].id;
            }

            addLog('è·å–ç»“æœæ•°æ®é›†ID: ' + resultDatasetId);

            // ä¸‹è½½ç»“æœå†…å®¹
            const response = await fetch(`/api/dataset/${resultDatasetId}`);
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error);
            }

            updateProgress('åˆ†æå®Œæˆï¼', 100);
            addLog('ç»“æœè·å–æˆåŠŸ');

            // è§£æå¹¶æ˜¾ç¤ºç»“æœ
            parseAndDisplayResults(result.content);

            // æ˜¾ç¤ºç»“æœç•Œé¢
            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
            }, 1000);
        }

        // è§£æå¹¶æ˜¾ç¤ºç»“æœ
        function parseAndDisplayResults(tsvContent) {
            const lines = tsvContent.trim().split('\n');
            
            if (lines.length < 2) {
                throw new Error('åˆ†æç»“æœä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
            }

            // è§£æTSVæ ‡é¢˜è¡Œ
            const headers = lines[0].split('\t');
            const geneSymbolIndex = headers.findIndex(h => h.includes('Gene symbol'));
            const sequenceNameIndex = headers.findIndex(h => h.includes('Sequence name'));
            const subclassIndex = headers.findIndex(h => h.includes('Subclass'));
            const coverageIndex = headers.findIndex(h => h.includes('Coverage'));
            const identityIndex = headers.findIndex(h => h.includes('Identity'));
            const elementTypeIndex = headers.findIndex(h => h.includes('Element type'));

            const results = [];
            
            // è§£ææ•°æ®è¡Œ
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split('\t');
                
                if (columns.length >= headers.length) {
                    const result = {
                        geneSymbol: columns[geneSymbolIndex] || 'N/A',
                        sequenceName: columns[sequenceNameIndex] || 'N/A',
                        subclass: columns[subclassIndex] || 'N/A',
                        coverage: parseFloat(columns[coverageIndex]) || 0,
                        identity: parseFloat(columns[identityIndex]) || 0,
                        elementType: columns[elementTypeIndex] || 'N/A'
                    };
                    
                    // è¿‡æ»¤æ‰æ— æ•ˆè®°å½•
                    if (result.geneSymbol !== 'N/A' && result.geneSymbol !== 'NA') {
                        results.push(result);
                    }
                }
            }

            analysisResults = {
                totalGenes: results.length,
                amrGenes: results.filter(r => r.elementType === 'AMR').length,
                antibioticClasses: [...new Set(results.map(r => r.subclass))].filter(s => s !== 'N/A').length,
                averageIdentity: results.length > 0 ? results.reduce((sum, r) => sum + r.identity, 0) / results.length : 0,
                results: results,
                rawContent: tsvContent
            };

            displayStats();
            displayResultsTable();
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function displayStats() {
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.totalGenes}</div>
                    <div class="stat-label">æ£€æµ‹åˆ°çš„åŸºå› </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.amrGenes}</div>
                    <div class="stat-label">è€è¯åŸºå› </div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.antibioticClasses}</div>
                    <div class="stat-label">æŠ—ç”Ÿç´ ç±»åˆ«</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.averageIdentity.toFixed(1)}%</div>
                    <div class="stat-label">å¹³å‡ç›¸ä¼¼åº¦</div>
                </div>
            `;
            document.getElementById('resultsStats').innerHTML = statsHTML;
        }

        // æ˜¾ç¤ºç»“æœè¡¨æ ¼
        function displayResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            analysisResults.results.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.geneSymbol}</strong></td>
                    <td>${result.sequenceName}</td>
                    <td><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">${result.subclass}</span></td>
                    <td>${result.coverage.toFixed(1)}%</td>
                    <td>${result.identity.toFixed(2)}%</td>
                    <td>${result.elementType}</td>
                `;
            });
        }

        // ä¸‹è½½ç»“æœ
        function downloadResults() {
            if (!analysisResults) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„ç»“æœ');
                return;
            }

            const timestamp = new Date().toISOString().split('T')[0];
            
            // åˆ›å»ºå®Œæ•´çš„åˆ†ææŠ¥å‘Š
            const fullReport = generateFullAnalysisReport();
            
            // ä¸‹è½½é€‰é¡¹
            const downloadOptions = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">é€‰æ‹©ä¸‹è½½æ ¼å¼</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button onclick="downloadTSV('${timestamp}')" style="padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ğŸ“„ ä¸‹è½½åŸå§‹TSVæ•°æ®
                            </button>
                            <button onclick="downloadClinicalReport('${timestamp}')" style="padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ğŸ¥ ä¸‹è½½ä¸´åºŠåˆ†ææŠ¥å‘Š
                            </button>
                            <button onclick="downloadCompleteReport('${timestamp}')" style="padding: 12px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ğŸ“Š ä¸‹è½½å®Œæ•´åˆ†ææŠ¥å‘Š
                            </button>
                            <button onclick="closeDownloadDialog()" style="padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', downloadOptions);
        }

        // ä¸‹è½½TSVæ ¼å¼
        function downloadTSV(timestamp) {
            const blob = new Blob([analysisResults.rawContent], { type: 'text/tab-separated-values' });
            downloadFile(blob, `amrfinder_results_${timestamp}.tsv`);
            closeDownloadDialog();
        }

        // ä¸‹è½½ä¸´åºŠæŠ¥å‘Š
        function downloadClinicalReport(timestamp) {
            const clinicalReport = generateClinicalReportText();
            const blob = new Blob([clinicalReport], { type: 'text/plain;charset=utf-8' });
            downloadFile(blob, `clinical_analysis_report_${timestamp}.txt`);
            closeDownloadDialog();
        }

        // ä¸‹è½½å®Œæ•´æŠ¥å‘Š
        function downloadCompleteReport(timestamp) {
            const completeReport = generateFullAnalysisReport();
            const blob = new Blob([completeReport], { type: 'text/plain;charset=utf-8' });
            downloadFile(blob, `complete_amr_analysis_${timestamp}.txt`);
            closeDownloadDialog();
        }

        // é€šç”¨ä¸‹è½½å‡½æ•°
        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // å…³é—­ä¸‹è½½å¯¹è¯æ¡†
        function closeDownloadDialog() {
            const dialog = document.querySelector('div[style*="position: fixed"]');
            if (dialog) {
                dialog.remove();
            }
        }

        // ç”Ÿæˆä¸´åºŠæŠ¥å‘Šæ–‡æœ¬
        function generateClinicalReportText() {
            if (!analysisResults) return '';

            const sampleInfo = analysisResults.sampleInfo;
            const results = analysisResults.results;
            
            // åˆ†ææŠ—ç”Ÿç´ è€è¯æƒ…å†µ
            const resistanceProfile = {};
            results.forEach(gene => {
                if (gene.elementType === 'AMR') {
                    const antibiotic = gene.subclass;
                    if (!resistanceProfile[antibiotic]) {
                        resistanceProfile[antibiotic] = [];
                    }
                    resistanceProfile[antibiotic].push(gene.geneSymbol);
                }
            });

            const report = `
è€è¯åŸºå› åˆ†æä¸´åºŠæŠ¥å‘Š
==================

æ ·æœ¬ä¿¡æ¯
--------
æ ·æœ¬ç¼–å·: ${sampleInfo.sampleId}
èŒç§: ${sampleInfo.organism}
é‡‡æ ·æ—¥æœŸ: ${sampleInfo.date}
åˆ†ææ—¶é—´: ${new Date(sampleInfo.analysisTime).toLocaleString()}

åˆ†æç»“æœæ¦‚è¦
----------
æ£€æµ‹åˆ°è€è¯åŸºå› æ•°: ${analysisResults.amrGenes}
æŠ—ç”Ÿç´ ç±»åˆ«æ•°: ${analysisResults.antibioticClasses}
å¹³å‡åºåˆ—ç›¸ä¼¼åº¦: ${analysisResults.averageIdentity.toFixed(1)}%

è€è¯è°±åˆ†æ
----------
${Object.entries(resistanceProfile).map(([antibiotic, genes]) => 
    `${antibiotic}:\n  ç›¸å…³åŸºå› : ${genes.join(', ')}`
).join('\n\n')}

ä¸´åºŠç”¨è¯å»ºè®®
----------
ğŸš« é¿å…ä½¿ç”¨çš„æŠ—ç”Ÿç´ :
â€¢ BETA-LACTAMç±» (æ£€æµ‹åˆ°blaSHV-11, blaTEM, blaCTX-M-65)
â€¢ CARBAPENEMç±» (æ£€æµ‹åˆ°ompK36_D135DGD)
â€¢ QUINOLONEç±» (æ£€æµ‹åˆ°parC_S80I)
â€¢ TETRACYCLINEç±» (æ£€æµ‹åˆ°tet(A))
â€¢ FOSFOMYCIN (æ£€æµ‹åˆ°fosA, fosA3)

âœ… æ¨èä½¿ç”¨çš„æŠ—ç”Ÿç´ :
â€¢ AMIKACIN (é¦–é€‰)
â€¢ TIGECYCLINE (é¦–é€‰)
â€¢ CEFTAZIDIME-AVIBACTAM (å¤‡é€‰)
â€¢ MEROPENEM-VABORBACTAM (å¤‡é€‰)

âš ï¸ ä¸´åºŠæ³¨æ„äº‹é¡¹:
1. è¯¥èŒæ ªæ˜¾ç¤ºå¤šé‡è€è¯ç‰¹å¾ï¼Œå»ºè®®è¿›è¡Œè¯æ•è¯•éªŒç¡®è®¤
2. æ£€æµ‹åˆ°ç¢³é’éœ‰çƒ¯ç±»è€è¯åŸºå› ï¼Œé¿å…ä½¿ç”¨è¯¥ç±»æŠ—ç”Ÿç´ 
3. æ¨èè”åˆç”¨è¯æ²»ç–—ä¸¥é‡æ„ŸæŸ“
4. åŠ å¼ºæ„ŸæŸ“æ§åˆ¶æªæ–½ï¼Œé˜²æ­¢è€è¯èŒä¼ æ’­
5. å®šæœŸç›‘æµ‹æ²»ç–—æ•ˆæœå’Œç»†èŒå­¦æ¸…é™¤æƒ…å†µ

æŠ¥å‘Šç”Ÿæˆ: è€è¯åŸºå› åˆ†æå¹³å°
æŠ€æœ¯æ”¯æŒ: AMRFinderæ•°æ®åº“
`;

            return report;
        }

        // ç”Ÿæˆå®Œæ•´åˆ†ææŠ¥å‘Š
        function generateFullAnalysisReport() {
            if (!analysisResults) return '';

            const clinicalReport = generateClinicalReportText();
            const technicalDetails = `

æŠ€æœ¯è¯¦æƒ…
========

æ£€æµ‹åŸºå› è¯¦è¡¨
----------
${analysisResults.results.map((gene, index) => 
    `${index + 1}. ${gene.geneSymbol}
   æè¿°: ${gene.sequenceName}
   æŠ—ç”Ÿç´ ç±»åˆ«: ${gene.subclass}
   è¦†ç›–åº¦: ${gene.coverage.toFixed(2)}%
   ç›¸ä¼¼åº¦: ${gene.identity.toFixed(2)}%
   å…ƒç´ ç±»å‹: ${gene.elementType}
`).join('\n')}

åˆ†æå‚æ•°
--------
æ•°æ®åº“ç‰ˆæœ¬: AMRFinderPlus v3.11.26
åˆ†ææ–¹æ³•: åºåˆ—æ¯”å¯¹ + HMMæ¨¡å‹
è´¨é‡æ§åˆ¶: è¦†ç›–åº¦ â‰¥ 60%, ç›¸ä¼¼åº¦ â‰¥ 90%
å‚è€ƒæ•°æ®åº“: NCBI AMRFinderPlus Database

å…è´£å£°æ˜
--------
æœ¬æŠ¥å‘Šä»…ä¾›ç ”ç©¶å’Œä¸´åºŠå‚è€ƒä½¿ç”¨ã€‚å…·ä½“ç”¨è¯è¯·éµå¾ªä¸´åºŠåŒ»å¸ˆæŒ‡å¯¼å’Œè¯æ•è¯•éªŒç»“æœã€‚
å¹³å°ä¸å¯¹å› ä½¿ç”¨æœ¬æŠ¥å‘Šè€Œäº§ç”Ÿçš„ä»»ä½•åæœæ‰¿æ‹…è´£ä»»ã€‚

æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
å¹³å°ç‰ˆæœ¬: v2.0.0
`;

            return clinicalReport + technicalDetails;
        }

        // é‡æ–°å¼€å§‹åˆ†æ
        function restartAnalysis() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            selectedFiles = [];
            currentJobId = null;
            currentDatasetId = null;
            currentHistoryId = null;
            analysisResults = null;

            // é‡ç½®ç•Œé¢
            document.getElementById('uploadSection').style.display = 'block';
            document.querySelector('.options-section').style.display = 'block';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // æ¸…ç©ºæ˜¾ç¤º
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('analyzeButton').disabled = true;
            document.getElementById('logSection').innerHTML = '<div>åˆ†ææ—¥å¿—ï¼š</div>';
            
            hideError();
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(statusText, percentage) {
            document.getElementById('statusText').textContent = statusText;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = Math.round(percentage) + '%';
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logSection = document.getElementById('logSection');
            const timestamp = new Date().toLocaleTimeString();
            logSection.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logSection.scrollTop = logSection.scrollHeight;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—é”™è¯¯
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // æ¼”ç¤ºåˆ†æåŠŸèƒ½
        async function startDemoAnalysis() {
            console.log('å¼€å§‹æ¼”ç¤ºåˆ†æ');
            
            // æ˜¾ç¤ºè¿›åº¦ç•Œé¢
            document.getElementById('uploadSection').style.display = 'none';
            document.querySelector('.options-section').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            hideError();

            try {
                // æ­¥éª¤1: æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©
                updateProgress('æ­£åœ¨åŠ è½½æ¼”ç¤ºæ•°æ®...', 10);
                addLog('é€‰æ‹©æ¼”ç¤ºæ ·æœ¬: 2020-05-12-E1-76 (å…‹é›·ä¼¯æ°èŒ)');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æ­¥éª¤2: æ¨¡æ‹Ÿä¸Šä¼ 
                updateProgress('æ­£åœ¨å¤„ç†åŸºå› ç»„æ–‡ä»¶...', 25);
                addLog('æ–‡ä»¶å¤§å°: 2.3 MB');
                addLog('åºåˆ—æ•°: 156 contigs');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // æ­¥éª¤3: æ¨¡æ‹ŸAMRFinderåˆ†æ
                updateProgress('æ­£åœ¨è¿è¡ŒAMRFinderåˆ†æ...', 40);
                addLog('ä½¿ç”¨æ•°æ®åº“: AMRFinderPlus v3.11.26');
                addLog('åˆ†æç±»å‹: å…‹é›·ä¼¯æ°èŒ (Klebsiella)');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // æ­¥éª¤4: æ¨¡æ‹Ÿåˆ†æè¿›åº¦
                for (let i = 40; i <= 80; i += 10) {
                    updateProgress(`åˆ†æè¿›è¡Œä¸­... (${i}%)`, i);
                    addLog(`å¤„ç† contig ${Math.floor((i-40)/10 * 30 + 1)}/156`);
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                // æ­¥éª¤5: å®Œæˆåˆ†æ
                updateProgress('åˆ†æå®Œæˆï¼Œæ­£åœ¨ç”ŸæˆæŠ¥å‘Š...', 90);
                addLog('æ£€æµ‹åˆ° 15 ä¸ªè€è¯åŸºå› ');
                addLog('æ¶‰åŠ 8 ä¸ªæŠ—ç”Ÿç´ ç±»åˆ«');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress('åˆ†æå®Œæˆï¼', 100);
                addLog('æŠ¥å‘Šç”ŸæˆæˆåŠŸ');
                
                // ç”Ÿæˆæ¼”ç¤ºç»“æœ
                generateDemoResults();
                
                // æ˜¾ç¤ºç»“æœç•Œé¢
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                }, 1000);
                
            } catch (error) {
                console.error('æ¼”ç¤ºåˆ†æå¤±è´¥:', error);
                showError('æ¼”ç¤ºåˆ†æå¤±è´¥: ' + error.message);
            }
        }

        // ç”Ÿæˆæ¼”ç¤ºç»“æœ
        function generateDemoResults() {
            // åŸºäºçœŸå®æ•°æ®çš„æ¼”ç¤ºç»“æœ
            const demoResults = [
                {
                    geneSymbol: 'aadA2',
                    sequenceName: 'ANT(3\'\')-Ia family aminoglycoside nucleotidyltransferase AadA2',
                    subclass: 'STREPTOMYCIN',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'rmtB1',
                    sequenceName: '16S rRNA (guanine(1405)-N(7))-methyltransferase RmtB1',
                    subclass: 'AMINOGLYCOSIDE',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'catA2',
                    sequenceName: 'type A-2 chloramphenicol O-acetyltransferase CatII',
                    subclass: 'CHLORAMPHENICOL',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'blaCTX-M-65',
                    sequenceName: 'extended-spectrum class A beta-lactamase CTX-M-65',
                    subclass: 'CEPHALOSPORIN',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'fosA3',
                    sequenceName: 'fosfomycin resistance glutathione transferase FosA3',
                    subclass: 'FOSFOMYCIN',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'sul1',
                    sequenceName: 'sulfonamide-resistant dihydropteroate synthase Sul1',
                    subclass: 'SULFONAMIDE',
                    coverage: 66.67,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'qacEdelta1',
                    sequenceName: 'quaternary ammonium compound efflux SMR transporter QacE delta 1',
                    subclass: 'QUATERNARY AMMONIUM',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'STRESS'
                },
                {
                    geneSymbol: 'blaTEM',
                    sequenceName: 'TEM family class A beta-lactamase',
                    subclass: 'BETA-LACTAM',
                    coverage: 66.43,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'parC_S80I',
                    sequenceName: 'Klebsiella pneumoniae quinolone resistant ParC',
                    subclass: 'QUINOLONE',
                    coverage: 98.84,
                    identity: 99.41,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'fosA',
                    sequenceName: 'FosA5 family fosfomycin resistance glutathione transferase',
                    subclass: 'FOSFOMYCIN',
                    coverage: 100.00,
                    identity: 98.56,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'dfrA1',
                    sequenceName: 'trimethoprim-resistant dihydrofolate reductase DfrA1',
                    subclass: 'TRIMETHOPRIM',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'tet(A)',
                    sequenceName: 'tetracycline efflux MFS transporter Tet(A)',
                    subclass: 'TETRACYCLINE',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'pmrB_R256G',
                    sequenceName: 'Klebsiella pneumoniae colistin resistant PmrB',
                    subclass: 'COLISTIN',
                    coverage: 100.00,
                    identity: 99.45,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'ompK36_D135DGD',
                    sequenceName: 'Klebsiella pneumoniae carbapenem resistant OmpK36',
                    subclass: 'CARBAPENEM',
                    coverage: 100.00,
                    identity: 92.29,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'blaSHV-11',
                    sequenceName: 'broad-spectrum class A beta-lactamase SHV-11',
                    subclass: 'BETA-LACTAM',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                }
            ];

            // è®¾ç½®å…¨å±€ç»“æœå˜é‡
            analysisResults = {
                totalGenes: demoResults.length,
                amrGenes: demoResults.filter(r => r.elementType === 'AMR').length,
                antibioticClasses: [...new Set(demoResults.map(r => r.subclass))].length,
                averageIdentity: demoResults.reduce((sum, r) => sum + r.identity, 0) / demoResults.length,
                results: demoResults,
                rawContent: generateDemoTSV(demoResults),
                sampleInfo: {
                    sampleId: '2020-05-12-E1-76',
                    organism: 'Klebsiella pneumoniae',
                    date: '2020-05-12',
                    analysisTime: new Date().toISOString()
                }
            };

            displayStats();
            displayResultsTable();
            generateClinicalReport();
        }

        // ç”Ÿæˆæ¼”ç¤ºTSVå†…å®¹
        function generateDemoTSV(results) {
            let tsvContent = 'Protein identifier\tContig id\tStart\tStop\tStrand\tGene symbol\tSequence name\tScope\tElement type\tElement subtype\tClass\tSubclass\tMethod\tTarget length\tReference sequence length\t% Coverage of reference sequence\t% Identity to reference sequence\tAlignment length\tAccession of closest sequence\tName of closest sequence\tHMM id\tHMM description\n';
            
            results.forEach((result, index) => {
                tsvContent += `NA\tNODE_${index + 1}_length_${Math.floor(Math.random() * 100000) + 1000}_cov_${(Math.random() * 200 + 100).toFixed(2)}\t${Math.floor(Math.random() * 10000)}\t${Math.floor(Math.random() * 10000) + 1000}\t+\t${result.geneSymbol}\t${result.sequenceName}\tcore\t${result.elementType}\t${result.elementType}\t${result.subclass.split('/')[0]}\t${result.subclass}\tEXACTX\t${Math.floor(Math.random() * 500) + 100}\t${Math.floor(Math.random() * 500) + 100}\t${result.coverage.toFixed(2)}\t${result.identity.toFixed(2)}\t${Math.floor(Math.random() * 500) + 100}\tWP_${String(Math.floor(Math.random() * 999999999)).padStart(9, '0')}.1\t${result.sequenceName}\tNA\tNA\n`;
            });
            
            return tsvContent;
        }

        // ç”Ÿæˆä¸´åºŠæŠ¥å‘Š
        function generateClinicalReport() {
            if (!analysisResults || !analysisResults.sampleInfo) return;

            const results = analysisResults.results;
            const sampleInfo = analysisResults.sampleInfo;
            
            // åˆ†ææŠ—ç”Ÿç´ è€è¯æƒ…å†µ
            const resistanceProfile = {};
            const riskLevels = {};
            
            results.forEach(gene => {
                if (gene.elementType === 'AMR') {
                    const antibiotic = gene.subclass;
                    if (!resistanceProfile[antibiotic]) {
                        resistanceProfile[antibiotic] = [];
                    }
                    resistanceProfile[antibiotic].push(gene.geneSymbol);
                    
                    // è¯„ä¼°é£é™©ç­‰çº§
                    let risk = 'Medium';
                    if (gene.identity >= 99 && gene.coverage >= 95) {
                        risk = 'High';
                    } else if (gene.identity < 95 || gene.coverage < 70) {
                        risk = 'Low';
                    }
                    riskLevels[antibiotic] = risk;
                }
            });

            // ç”Ÿæˆæ¨èå’Œé¿å…çš„æŠ—ç”Ÿç´ åˆ—è¡¨
            const highRiskAntibiotics = Object.entries(riskLevels)
                .filter(([, risk]) => risk === 'High')
                .map(([antibiotic]) => antibiotic);
            
            const mediumRiskAntibiotics = Object.entries(riskLevels)
                .filter(([, risk]) => risk === 'Medium')
                .map(([antibiotic]) => antibiotic);

            // æ¨èçš„æŠ—ç”Ÿç´ ï¼ˆä¸åœ¨è€è¯åˆ—è¡¨ä¸­çš„ï¼‰
            const allAntibiotics = [
                'MEROPENEM', 'IMIPENEM', 'ERTAPENEM', 'DORIPENEM',
                'AMIKACIN', 'GENTAMICIN', 'TOBRAMYCIN',
                'CIPROFLOXACIN', 'LEVOFLOXACIN', 'MOXIFLOXACIN',
                'TIGECYCLINE', 'COLISTIN', 'POLYMYXIN B',
                'CEFTAZIDIME-AVIBACTAM', 'MEROPENEM-VABORBACTAM'
            ];
            
            const resistantAntibiotics = Object.keys(resistanceProfile).map(a => a.toUpperCase());
            const recommendedAntibiotics = allAntibiotics.filter(a => 
                !resistantAntibiotics.some(ra => a.includes(ra.split('/')[0]) || ra.includes(a))
            );

            // åœ¨ç»“æœéƒ¨åˆ†æ·»åŠ ä¸´åºŠåˆ†ææŠ¥å‘Š
            const resultsSection = document.getElementById('resultsSection');
            const clinicalReport = document.createElement('div');
            clinicalReport.style.cssText = `
                margin-top: 30px;
                padding: 25px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 15px;
                border-left: 5px solid #dc3545;
            `;
            
            clinicalReport.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    ğŸ¥ ä¸´åºŠåˆ†ææŠ¥å‘Š
                </h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">ğŸš« é¿å…ä½¿ç”¨çš„æŠ—ç”Ÿç´ </h4>
                        <div style="margin-bottom: 10px;"><strong>é«˜é£é™© (é¿å…ä½¿ç”¨):</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #dc3545;">
                            ${highRiskAntibiotics.map(ab => `<li>${ab} - æ£€æµ‹åˆ°ç›¸å…³è€è¯åŸºå› </li>`).join('')}
                        </ul>
                        <div style="margin-bottom: 10px;"><strong>ä¸­ç­‰é£é™© (è°¨æ…ä½¿ç”¨):</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #fd7e14;">
                            ${mediumRiskAntibiotics.map(ab => `<li>${ab} - éœ€è¦è¯æ•è¯•éªŒç¡®è®¤</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #28a745; margin-bottom: 15px;">âœ… æ¨èä½¿ç”¨çš„æŠ—ç”Ÿç´ </h4>
                        <div style="margin-bottom: 10px;"><strong>é¦–é€‰è¯ç‰©:</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #28a745;">
                            ${recommendedAntibiotics.slice(0, 5).map(ab => `<li>${ab}</li>`).join('')}
                        </ul>
                        <div style="margin-bottom: 10px;"><strong>å¤‡é€‰è¯ç‰©:</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #17a2b8;">
                            ${recommendedAntibiotics.slice(5, 8).map(ab => `<li>${ab}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ ä¸´åºŠå»ºè®®</h4>
                    <ul style="margin: 0 0 0 20px; color: #856404;">
                        <li>è¯¥èŒæ ªæ˜¾ç¤ºå¤šé‡è€è¯ç‰¹å¾ï¼Œå»ºè®®è¿›è¡Œè¯æ•è¯•éªŒç¡®è®¤</li>
                        <li>æ£€æµ‹åˆ°ç¢³é’éœ‰çƒ¯ç±»è€è¯åŸºå› ï¼Œé¿å…ä½¿ç”¨è¯¥ç±»æŠ—ç”Ÿç´ </li>
                        <li>æ¨èè”åˆç”¨è¯æ²»ç–—ä¸¥é‡æ„ŸæŸ“</li>
                        <li>åŠ å¼ºæ„ŸæŸ“æ§åˆ¶æªæ–½ï¼Œé˜²æ­¢è€è¯èŒä¼ æ’­</li>
                        <li>å®šæœŸç›‘æµ‹æ²»ç–—æ•ˆæœå’Œç»†èŒå­¦æ¸…é™¤æƒ…å†µ</li>
                    </ul>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(23, 162, 184, 0.1); border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <h4 style="color: #0c5460; margin-bottom: 10px;">ğŸ“Š æ ·æœ¬ä¿¡æ¯</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; color: #0c5460;">
                        <div><strong>æ ·æœ¬ç¼–å·:</strong> ${sampleInfo.sampleId}</div>
                        <div><strong>èŒç§:</strong> ${sampleInfo.organism}</div>
                        <div><strong>é‡‡æ ·æ—¥æœŸ:</strong> ${sampleInfo.date}</div>
                        <div><strong>åˆ†ææ—¶é—´:</strong> ${new Date(sampleInfo.analysisTime).toLocaleString()}</div>
                        <div><strong>è€è¯åŸºå› æ•°:</strong> ${analysisResults.amrGenes}</div>
                        <div><strong>å¹³å‡ç›¸ä¼¼åº¦:</strong> ${analysisResults.averageIdentity.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            resultsSection.appendChild(clinicalReport);
        }
    </script>
</body>
</html>
