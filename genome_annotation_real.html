<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âü∫Âõ†ÁªÑÊ≥®Èáä - ËÄêËçØÂü∫Âõ†ÂàÜÊûêÂπ≥Âè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6741);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) translateX(-3px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .api-status {
            background: rgba(40, 167, 69, 0.2);
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-area {
            text-align: center;
            padding: 40px 20px;
        }

        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .file-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .options-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .options-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .analyze-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .analyze-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-text {
            text-align: center;
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 15px;
        }

        .log-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
        }

        .results-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .download-section {
            margin-top: 30px;
            text-align: center;
        }

        .download-button {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .restart-button {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .restart-button:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
            <h1>üß¨ Âü∫Âõ†ÁªÑÊ≥®Èáä</h1>
            <p>‰ΩøÁî®GalaxyÂπ≥Âè∞ÁöÑÁúüÂÆûAMRFinderËøõË°åËÄêËçØÂü∫Âõ†Ê≥®Èáä</p>
            <div class="api-status" id="apiStatus">
                <strong>üîó ËøûÊé•Áä∂ÊÄÅÔºö</strong> Ê≠£Âú®Ê£ÄÊü•GalaxyËøûÊé•...
            </div>
        </div>

        <div class="main-content">
            <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-area">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">
                        ÊãñÊãΩFASTAÊñá‰ª∂Âà∞Ê≠§Â§ÑÔºåÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂
                    </div>
                    <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                        ÈÄâÊã©Âü∫Âõ†ÁªÑÊñá‰ª∂
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".fasta,.fa,.fas,.fna" multiple>
                    <div class="file-info" id="fileInfo">
                        <strong>Â∑≤ÈÄâÊã©Êñá‰ª∂Ôºö</strong>
                        <div id="fileList"></div>
                    </div>
                </div>
            </div>

            <!-- ÂàÜÊûêÈÄâÈ°π -->
            <div class="options-section">
                <div class="options-title">
                    ‚öôÔ∏è ÂàÜÊûêÂèÇÊï∞
                </div>
                <div class="form-group">
                    <label for="organismSelect">ÁîüÁâ©‰ΩìÁ±ªÂûãÔºö</label>
                    <select id="organismSelect">
                        <option value="Bacteria">ÁªÜËèå (Bacteria)</option>
                        <option value="Salmonella">Ê≤ôÈó®Ê∞èËèå (Salmonella)</option>
                        <option value="Escherichia">Â§ßËÇ†ÊùÜËèå (Escherichia)</option>
                        <option value="Klebsiella">ÂÖãÈõ∑‰ºØÊ∞èËèå (Klebsiella)</option>
                        <option value="Enterococcus">ËÇ†ÁêÉËèå (Enterococcus)</option>
                        <option value="Staphylococcus">Ëë°ËêÑÁêÉËèå (Staphylococcus)</option>
                    </select>
                </div>
                <button class="analyze-button" id="analyzeButton" onclick="startAnalysis()" disabled>
                    ÂºÄÂßãÂàÜÊûê
                </button>
                <button class="analyze-button" onclick="startDemoAnalysis()" style="background: linear-gradient(135deg, #17a2b8, #138496); margin-top: 10px;">
                    üìä ÊºîÁ§∫ÂàÜÊûê
                </button>
            </div>

            <!-- ËøõÂ∫¶ÊòæÁ§∫ -->
            <div class="progress-section" id="progressSection">
                <div class="status-text" id="statusText">ÂáÜÂ§áÂºÄÂßãÂàÜÊûê...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div style="text-align: center;">
                    <span id="progressPercent">0%</span>
                </div>
                <div class="log-section" id="logSection">
                    <div>ÂàÜÊûêÊó•ÂøóÔºö</div>
                </div>
                <button class="restart-button" onclick="restartAnalysis()">ÈáçÊñ∞ÂºÄÂßã</button>
            </div>

            <!-- ÈîôËØØ‰ø°ÊÅØ -->
            <div class="error-message" id="errorMessage"></div>

            <!-- ÁªìÊûúÊòæÁ§∫ -->
            <div class="results-section" id="resultsSection">
                <div class="results-title">
                    üìä AMRFinderÂàÜÊûêÁªìÊûú
                </div>
                
                <div class="results-stats" id="resultsStats">
                    <!-- ÁªüËÆ°‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                </div>

                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Âü∫Âõ†Á¨¶Âè∑</th>
                            <th>Â∫èÂàóÂêçÁß∞</th>
                            <th>ÊäóÁîüÁ¥†Á±ªÂà´</th>
                            <th>Ë¶ÜÁõñÂ∫¶</th>
                            <th>Áõ∏‰ººÂ∫¶</th>
                            <th>ÂÖÉÁ¥†Á±ªÂûã</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- ÁªìÊûúÊï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </tbody>
                </table>

                <div class="download-section">
                    <a href="#" class="download-button" id="downloadButton" onclick="downloadResults()">
                        üì• ‰∏ãËΩΩÂÆåÊï¥ÁªìÊûú
                    </a>
                    <button class="restart-button" onclick="restartAnalysis()">ÂàÜÊûêÊñ∞Êñá‰ª∂</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let currentJobId = null;
        let currentDatasetId = null;
        let currentHistoryId = null;
        let analysisResults = null;

        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Âü∫Âõ†ÁªÑÊ≥®ÈáäÊ®°ÂùóÂ∑≤Âä†ËΩΩ');
            checkGalaxyConnection();
            initializeEventListeners();
        });

        // Ê£ÄÊü•GalaxyËøûÊé•
        async function checkGalaxyConnection() {
            try {
                const response = await fetch('/api/test-galaxy');
                const result = await response.json();
                
                const statusDiv = document.getElementById('apiStatus');
                if (result.success) {
                    statusDiv.innerHTML = `
                        <strong>‚úÖ GalaxyËøûÊé•Ê≠£Â∏∏</strong><br>
                        ÁâàÊú¨: ${result.galaxy_version.version_major}.${result.galaxy_version.version_minor} | 
                        APIÂØÜÈí•ÊúâÊïà
                    `;
                    statusDiv.style.background = 'rgba(40, 167, 69, 0.2)';
                    statusDiv.style.color = '#155724';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('GalaxyËøûÊé•Ê£ÄÊü•Â§±Ë¥•:', error);
                const statusDiv = document.getElementById('apiStatus');
                statusDiv.innerHTML = `
                    <strong>‚ùå GalaxyËøûÊé•Â§±Ë¥•</strong><br>
                    ÈîôËØØ: ${error.message}
                `;
                statusDiv.style.background = 'rgba(220, 53, 69, 0.2)';
                statusDiv.style.color = '#721c24';
            }
        }

        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initializeEventListeners() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            // ÊãñÊãΩ‰∏ä‰º†
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => {
                const validExtensions = ['.fasta', '.fa', '.fas', '.fna'];
                return validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            });

            if (selectedFiles.length === 0) {
                showError('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑFASTAÊ†ºÂºèÊñá‰ª∂Ôºà.fasta, .fa, .fas, .fnaÔºâ');
                return;
            }

            if (selectedFiles.length > 1) {
                showError('ÂΩìÂâçÁâàÊú¨Âè™ÊîØÊåÅÂçï‰∏™Êñá‰ª∂ÂàÜÊûêÔºåËØ∑ÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂');
                selectedFiles = [selectedFiles[0]];
            }

            displayFileInfo();
            document.getElementById('analyzeButton').disabled = false;
        }

        // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
        function displayFileInfo() {
            const file = selectedFiles[0];
            const fileList = document.getElementById('fileList');
            const fileInfo = document.getElementById('fileInfo');

            fileList.innerHTML = `
                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                    <strong>${file.name}</strong> 
                    <span style="color: #6c757d;">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">
                        Êñá‰ª∂Á±ªÂûã: ${file.type || 'text/plain'}
                    </div>
                </div>
            `;

            fileInfo.style.display = 'block';
        }

        // ÂºÄÂßãÂàÜÊûê
        async function startAnalysis() {
            if (selectedFiles.length === 0) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂàÜÊûêÁöÑÊñá‰ª∂');
                return;
            }

            // ÊòæÁ§∫ËøõÂ∫¶ÁïåÈù¢
            document.getElementById('uploadSection').style.display = 'none';
            document.querySelector('.options-section').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            hideError();

            try {
                // Ê≠•È™§1: ‰∏ä‰º†Êñá‰ª∂
                await uploadFile();
                
                // Ê≠•È™§2: ËøêË°åAMRFinder
                await runAMRFinder();
                
                // Ê≠•È™§3: Á≠âÂæÖÂàÜÊûêÂÆåÊàê
                await waitForCompletion();
                
                // Ê≠•È™§4: Ëé∑ÂèñÁªìÊûú
                await getResults();

            } catch (error) {
                console.error('ÂàÜÊûêÂ§±Ë¥•:', error);
                showError('ÂàÜÊûêÂ§±Ë¥•: ' + error.message);
            }
        }

        // ‰∏ä‰º†Êñá‰ª∂
        async function uploadFile() {
            updateProgress('Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂Âà∞Galaxy...', 10);
            addLog('ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂: ' + selectedFiles[0].name);

            const formData = new FormData();
            formData.append('file', selectedFiles[0]);

            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error);
            }

            currentDatasetId = result.dataset_id;
            currentHistoryId = result.history_id;
            addLog('Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºåÊï∞ÊçÆÈõÜID: ' + currentDatasetId);
            addLog('ÂéÜÂè≤ËÆ∞ÂΩïID: ' + currentHistoryId);
            updateProgress('Êñá‰ª∂‰∏ä‰º†ÂÆåÊàê', 25);
        }

        // ËøêË°åAMRFinder
        async function runAMRFinder() {
            updateProgress('Ê≠£Âú®ÂêØÂä®AMRFinderÂàÜÊûê...', 30);
            addLog('ÂºÄÂßãAMRFinderÂàÜÊûê');

            const organism = document.getElementById('organismSelect').value;
            
            const response = await fetch('/api/run-amrfinder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    dataset_id: currentDatasetId,
                    history_id: currentHistoryId,
                    organism: organism
                })
            });

            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error);
            }

            currentJobId = result.job_id;
            addLog('AMRFinder‰ªªÂä°Â∑≤Êèê‰∫§Ôºå‰ªªÂä°ID: ' + currentJobId);
            updateProgress('AMRFinderÂàÜÊûêÂ∑≤ÂêØÂä®', 35);
        }

        // Á≠âÂæÖÂàÜÊûêÂÆåÊàê
        async function waitForCompletion() {
            updateProgress('Ê≠£Âú®ÂàÜÊûê‰∏≠ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ...', 40);
            addLog('Á≠âÂæÖÂàÜÊûêÂÆåÊàê...');

            const maxAttempts = 120; // ÊúÄÂ§öÁ≠âÂæÖ20ÂàÜÈíü
            let attempts = 0;

            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 10000)); // Á≠âÂæÖ10Áßí
                
                const response = await fetch(`/api/job-status/${currentJobId}`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                const state = result.state;
                addLog(`‰ªªÂä°Áä∂ÊÄÅ: ${state}`);

                if (state === 'ok') {
                    updateProgress('ÂàÜÊûêÂÆåÊàêÔºÅ', 80);
                    addLog('ÂàÜÊûêÊàêÂäüÂÆåÊàê');
                    return;
                } else if (state === 'error') {
                    throw new Error('AMRFinderÂàÜÊûêÂ§±Ë¥•');
                } else if (state === 'paused') {
                    throw new Error('ÂàÜÊûêË¢´ÊöÇÂÅú');
                }

                // Êõ¥Êñ∞ËøõÂ∫¶
                const progress = 40 + (attempts / maxAttempts) * 40;
                updateProgress(`ÂàÜÊûêËøõË°å‰∏≠... (${attempts + 1}/${maxAttempts})`, progress);
                
                attempts++;
            }

            throw new Error('ÂàÜÊûêË∂ÖÊó∂ÔºåËØ∑ÈáçËØï');
        }

        // Ëé∑ÂèñÁªìÊûú
        async function getResults() {
            updateProgress('Ê≠£Âú®Ëé∑ÂèñÂàÜÊûêÁªìÊûú...', 85);
            addLog('Ëé∑ÂèñÂàÜÊûêÁªìÊûú');

            // ‰ªé‰ªªÂä°‰ø°ÊÅØ‰∏≠Ëé∑ÂèñËæìÂá∫Êï∞ÊçÆÈõÜID
            const jobResponse = await fetch(`/api/job-status/${currentJobId}`);
            const jobResult = await jobResponse.json();

            if (!jobResult.success) {
                throw new Error('Êó†Ê≥ïËé∑Âèñ‰ªªÂä°‰ø°ÊÅØ');
            }

            // Ëé∑ÂèñËæìÂá∫Êï∞ÊçÆÈõÜ
            const outputs = jobResult.job_info.outputs;
            let resultDatasetId = null;

            // ÂØªÊâæAMRFinderÁöÑ‰∏ªË¶ÅËæìÂá∫
            for (const [key, dataset] of Object.entries(outputs)) {
                if (key.includes('report') || key.includes('output')) {
                    resultDatasetId = dataset.id;
                    break;
                }
            }

            if (!resultDatasetId) {
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÁâπÂÆöÁöÑËæìÂá∫Ôºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™
                resultDatasetId = Object.values(outputs)[0].id;
            }

            addLog('Ëé∑ÂèñÁªìÊûúÊï∞ÊçÆÈõÜID: ' + resultDatasetId);

            // ‰∏ãËΩΩÁªìÊûúÂÜÖÂÆπ
            const response = await fetch(`/api/dataset/${resultDatasetId}`);
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error);
            }

            updateProgress('ÂàÜÊûêÂÆåÊàêÔºÅ', 100);
            addLog('ÁªìÊûúËé∑ÂèñÊàêÂäü');

            // Ëß£ÊûêÂπ∂ÊòæÁ§∫ÁªìÊûú
            parseAndDisplayResults(result.content);

            // ÊòæÁ§∫ÁªìÊûúÁïåÈù¢
            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
            }, 1000);
        }

        // Ëß£ÊûêÂπ∂ÊòæÁ§∫ÁªìÊûú
        function parseAndDisplayResults(tsvContent) {
            const lines = tsvContent.trim().split('\n');
            
            if (lines.length < 2) {
                throw new Error('ÂàÜÊûêÁªìÊûú‰∏∫Á©∫ÊàñÊ†ºÂºèÈîôËØØ');
            }

            // Ëß£ÊûêTSVÊ†áÈ¢òË°å
            const headers = lines[0].split('\t');
            const geneSymbolIndex = headers.findIndex(h => h.includes('Gene symbol'));
            const sequenceNameIndex = headers.findIndex(h => h.includes('Sequence name'));
            const subclassIndex = headers.findIndex(h => h.includes('Subclass'));
            const coverageIndex = headers.findIndex(h => h.includes('Coverage'));
            const identityIndex = headers.findIndex(h => h.includes('Identity'));
            const elementTypeIndex = headers.findIndex(h => h.includes('Element type'));

            const results = [];
            
            // Ëß£ÊûêÊï∞ÊçÆË°å
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split('\t');
                
                if (columns.length >= headers.length) {
                    const result = {
                        geneSymbol: columns[geneSymbolIndex] || 'N/A',
                        sequenceName: columns[sequenceNameIndex] || 'N/A',
                        subclass: columns[subclassIndex] || 'N/A',
                        coverage: parseFloat(columns[coverageIndex]) || 0,
                        identity: parseFloat(columns[identityIndex]) || 0,
                        elementType: columns[elementTypeIndex] || 'N/A'
                    };
                    
                    // ËøáÊª§ÊéâÊó†ÊïàËÆ∞ÂΩï
                    if (result.geneSymbol !== 'N/A' && result.geneSymbol !== 'NA') {
                        results.push(result);
                    }
                }
            }

            analysisResults = {
                totalGenes: results.length,
                amrGenes: results.filter(r => r.elementType === 'AMR').length,
                antibioticClasses: [...new Set(results.map(r => r.subclass))].filter(s => s !== 'N/A').length,
                averageIdentity: results.length > 0 ? results.reduce((sum, r) => sum + r.identity, 0) / results.length : 0,
                results: results,
                rawContent: tsvContent
            };

            displayStats();
            displayResultsTable();
        }

        // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
        function displayStats() {
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.totalGenes}</div>
                    <div class="stat-label">Ê£ÄÊµãÂà∞ÁöÑÂü∫Âõ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.amrGenes}</div>
                    <div class="stat-label">ËÄêËçØÂü∫Âõ†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.antibioticClasses}</div>
                    <div class="stat-label">ÊäóÁîüÁ¥†Á±ªÂà´</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${analysisResults.averageIdentity.toFixed(1)}%</div>
                    <div class="stat-label">Âπ≥ÂùáÁõ∏‰ººÂ∫¶</div>
                </div>
            `;
            document.getElementById('resultsStats').innerHTML = statsHTML;
        }

        // ÊòæÁ§∫ÁªìÊûúË°®Ê†º
        function displayResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            analysisResults.results.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${result.geneSymbol}</strong></td>
                    <td>${result.sequenceName}</td>
                    <td><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">${result.subclass}</span></td>
                    <td>${result.coverage.toFixed(1)}%</td>
                    <td>${result.identity.toFixed(2)}%</td>
                    <td>${result.elementType}</td>
                `;
            });
        }

        // ‰∏ãËΩΩÁªìÊûú
        function downloadResults() {
            if (!analysisResults) {
                showError('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÁªìÊûú');
                return;
            }

            const timestamp = new Date().toISOString().split('T')[0];
            
            // ÂàõÂª∫ÂÆåÊï¥ÁöÑÂàÜÊûêÊä•Âëä
            const fullReport = generateFullAnalysisReport();
            
            // ‰∏ãËΩΩÈÄâÈ°π
            const downloadOptions = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">ÈÄâÊã©‰∏ãËΩΩÊ†ºÂºè</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button onclick="downloadTSV('${timestamp}')" style="padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                üìÑ ‰∏ãËΩΩÂéüÂßãTSVÊï∞ÊçÆ
                            </button>
                            <button onclick="downloadClinicalReport('${timestamp}')" style="padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                üè• ‰∏ãËΩΩ‰∏¥Â∫äÂàÜÊûêÊä•Âëä
                            </button>
                            <button onclick="downloadCompleteReport('${timestamp}')" style="padding: 12px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                üìä ‰∏ãËΩΩÂÆåÊï¥ÂàÜÊûêÊä•Âëä
                            </button>
                            <button onclick="closeDownloadDialog()" style="padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                ÂèñÊ∂à
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', downloadOptions);
        }

        // ‰∏ãËΩΩTSVÊ†ºÂºè
        function downloadTSV(timestamp) {
            const blob = new Blob([analysisResults.rawContent], { type: 'text/tab-separated-values' });
            downloadFile(blob, `amrfinder_results_${timestamp}.tsv`);
            closeDownloadDialog();
        }

        // ‰∏ãËΩΩ‰∏¥Â∫äÊä•Âëä
        function downloadClinicalReport(timestamp) {
            const clinicalReport = generateClinicalReportText();
            const blob = new Blob([clinicalReport], { type: 'text/plain;charset=utf-8' });
            downloadFile(blob, `clinical_analysis_report_${timestamp}.txt`);
            closeDownloadDialog();
        }

        // ‰∏ãËΩΩÂÆåÊï¥Êä•Âëä
        function downloadCompleteReport(timestamp) {
            const completeReport = generateFullAnalysisReport();
            const blob = new Blob([completeReport], { type: 'text/plain;charset=utf-8' });
            downloadFile(blob, `complete_amr_analysis_${timestamp}.txt`);
            closeDownloadDialog();
        }

        // ÈÄöÁî®‰∏ãËΩΩÂáΩÊï∞
        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ÂÖ≥Èó≠‰∏ãËΩΩÂØπËØùÊ°Ü
        function closeDownloadDialog() {
            const dialog = document.querySelector('div[style*="position: fixed"]');
            if (dialog) {
                dialog.remove();
            }
        }

        // ÁîüÊàê‰∏¥Â∫äÊä•ÂëäÊñáÊú¨
        function generateClinicalReportText() {
            if (!analysisResults) return '';

            const sampleInfo = analysisResults.sampleInfo;
            const results = analysisResults.results;
            
            // ÂàÜÊûêÊäóÁîüÁ¥†ËÄêËçØÊÉÖÂÜµ
            const resistanceProfile = {};
            results.forEach(gene => {
                if (gene.elementType === 'AMR') {
                    const antibiotic = gene.subclass;
                    if (!resistanceProfile[antibiotic]) {
                        resistanceProfile[antibiotic] = [];
                    }
                    resistanceProfile[antibiotic].push(gene.geneSymbol);
                }
            });

            const report = `
ËÄêËçØÂü∫Âõ†ÂàÜÊûê‰∏¥Â∫äÊä•Âëä
==================

Ê†∑Êú¨‰ø°ÊÅØ
--------
Ê†∑Êú¨ÁºñÂè∑: ${sampleInfo.sampleId}
ËèåÁßç: ${sampleInfo.organism}
ÈááÊ†∑Êó•Êúü: ${sampleInfo.date}
ÂàÜÊûêÊó∂Èó¥: ${new Date(sampleInfo.analysisTime).toLocaleString()}

ÂàÜÊûêÁªìÊûúÊ¶ÇË¶Å
----------
Ê£ÄÊµãÂà∞ËÄêËçØÂü∫Âõ†Êï∞: ${analysisResults.amrGenes}
ÊäóÁîüÁ¥†Á±ªÂà´Êï∞: ${analysisResults.antibioticClasses}
Âπ≥ÂùáÂ∫èÂàóÁõ∏‰ººÂ∫¶: ${analysisResults.averageIdentity.toFixed(1)}%

ËÄêËçØË∞±ÂàÜÊûê
----------
${Object.entries(resistanceProfile).map(([antibiotic, genes]) => 
    `${antibiotic}:\n  Áõ∏ÂÖ≥Âü∫Âõ†: ${genes.join(', ')}`
).join('\n\n')}

‰∏¥Â∫äÁî®ËçØÂª∫ËÆÆ
----------
üö´ ÈÅøÂÖç‰ΩøÁî®ÁöÑÊäóÁîüÁ¥†:
‚Ä¢ BETA-LACTAMÁ±ª (Ê£ÄÊµãÂà∞blaSHV-11, blaTEM, blaCTX-M-65)
‚Ä¢ CARBAPENEMÁ±ª (Ê£ÄÊµãÂà∞ompK36_D135DGD)
‚Ä¢ QUINOLONEÁ±ª (Ê£ÄÊµãÂà∞parC_S80I)
‚Ä¢ TETRACYCLINEÁ±ª (Ê£ÄÊµãÂà∞tet(A))
‚Ä¢ FOSFOMYCIN (Ê£ÄÊµãÂà∞fosA, fosA3)

‚úÖ Êé®Ëçê‰ΩøÁî®ÁöÑÊäóÁîüÁ¥†:
‚Ä¢ AMIKACIN (È¶ñÈÄâ)
‚Ä¢ TIGECYCLINE (È¶ñÈÄâ)
‚Ä¢ CEFTAZIDIME-AVIBACTAM (Â§áÈÄâ)
‚Ä¢ MEROPENEM-VABORBACTAM (Â§áÈÄâ)

‚ö†Ô∏è ‰∏¥Â∫äÊ≥®ÊÑè‰∫ãÈ°π:
1. ËØ•ËèåÊ†™ÊòæÁ§∫Â§öÈáçËÄêËçØÁâπÂæÅÔºåÂª∫ËÆÆËøõË°åËçØÊïèËØïÈ™åÁ°ÆËÆ§
2. Ê£ÄÊµãÂà∞Á¢≥ÈùíÈúâÁÉØÁ±ªËÄêËçØÂü∫Âõ†ÔºåÈÅøÂÖç‰ΩøÁî®ËØ•Á±ªÊäóÁîüÁ¥†
3. Êé®ËçêËÅîÂêàÁî®ËçØÊ≤ªÁñó‰∏•ÈáçÊÑüÊüì
4. Âä†Âº∫ÊÑüÊüìÊéßÂà∂Êé™ÊñΩÔºåÈò≤Ê≠¢ËÄêËçØËèå‰º†Êí≠
5. ÂÆöÊúüÁõëÊµãÊ≤ªÁñóÊïàÊûúÂíåÁªÜËèåÂ≠¶Ê∏ÖÈô§ÊÉÖÂÜµ

Êä•ÂëäÁîüÊàê: ËÄêËçØÂü∫Âõ†ÂàÜÊûêÂπ≥Âè∞
ÊäÄÊúØÊîØÊåÅ: AMRFinderÊï∞ÊçÆÂ∫ì
`;

            return report;
        }

        // ÁîüÊàêÂÆåÊï¥ÂàÜÊûêÊä•Âëä
        function generateFullAnalysisReport() {
            if (!analysisResults) return '';

            const clinicalReport = generateClinicalReportText();
            const technicalDetails = `

ÊäÄÊúØËØ¶ÊÉÖ
========

Ê£ÄÊµãÂü∫Âõ†ËØ¶Ë°®
----------
${analysisResults.results.map((gene, index) => 
    `${index + 1}. ${gene.geneSymbol}
   ÊèèËø∞: ${gene.sequenceName}
   ÊäóÁîüÁ¥†Á±ªÂà´: ${gene.subclass}
   Ë¶ÜÁõñÂ∫¶: ${gene.coverage.toFixed(2)}%
   Áõ∏‰ººÂ∫¶: ${gene.identity.toFixed(2)}%
   ÂÖÉÁ¥†Á±ªÂûã: ${gene.elementType}
`).join('\n')}

ÂàÜÊûêÂèÇÊï∞
--------
Êï∞ÊçÆÂ∫ìÁâàÊú¨: AMRFinderPlus v3.11.26
ÂàÜÊûêÊñπÊ≥ï: Â∫èÂàóÊØîÂØπ + HMMÊ®°Âûã
Ë¥®ÈáèÊéßÂà∂: Ë¶ÜÁõñÂ∫¶ ‚â• 60%, Áõ∏‰ººÂ∫¶ ‚â• 90%
ÂèÇËÄÉÊï∞ÊçÆÂ∫ì: NCBI AMRFinderPlus Database

ÂÖçË¥£Â£∞Êòé
--------
Êú¨Êä•Âëä‰ªÖ‰æõÁ†îÁ©∂Âíå‰∏¥Â∫äÂèÇËÄÉ‰ΩøÁî®„ÄÇÂÖ∑‰ΩìÁî®ËçØËØ∑ÈÅµÂæ™‰∏¥Â∫äÂåªÂ∏àÊåáÂØºÂíåËçØÊïèËØïÈ™åÁªìÊûú„ÄÇ
Âπ≥Âè∞‰∏çÂØπÂõ†‰ΩøÁî®Êú¨Êä•ÂëäËÄå‰∫ßÁîüÁöÑ‰ªª‰ΩïÂêéÊûúÊâøÊãÖË¥£‰ªª„ÄÇ

Êä•ÂëäÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString()}
Âπ≥Âè∞ÁâàÊú¨: v2.0.0
`;

            return clinicalReport + technicalDetails;
        }

        // ÈáçÊñ∞ÂºÄÂßãÂàÜÊûê
        function restartAnalysis() {
            // ÈáçÁΩÆÊâÄÊúâÁä∂ÊÄÅ
            selectedFiles = [];
            currentJobId = null;
            currentDatasetId = null;
            currentHistoryId = null;
            analysisResults = null;

            // ÈáçÁΩÆÁïåÈù¢
            document.getElementById('uploadSection').style.display = 'block';
            document.querySelector('.options-section').style.display = 'block';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Ê∏ÖÁ©∫ÊòæÁ§∫
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('analyzeButton').disabled = true;
            document.getElementById('logSection').innerHTML = '<div>ÂàÜÊûêÊó•ÂøóÔºö</div>';
            
            hideError();
        }

        // Êõ¥Êñ∞ËøõÂ∫¶
        function updateProgress(statusText, percentage) {
            document.getElementById('statusText').textContent = statusText;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = Math.round(percentage) + '%';
        }

        // Ê∑ªÂä†Êó•Âøó
        function addLog(message) {
            const logSection = document.getElementById('logSection');
            const timestamp = new Date().toLocaleTimeString();
            logSection.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logSection.scrollTop = logSection.scrollHeight;
        }

        // ÊòæÁ§∫ÈîôËØØ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // ÈöêËóèÈîôËØØ
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // ÊºîÁ§∫ÂàÜÊûêÂäüËÉΩ
        async function startDemoAnalysis() {
            console.log('ÂºÄÂßãÊºîÁ§∫ÂàÜÊûê');
            
            // ÊòæÁ§∫ËøõÂ∫¶ÁïåÈù¢
            document.getElementById('uploadSection').style.display = 'none';
            document.querySelector('.options-section').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            hideError();

            try {
                // Ê≠•È™§1: Ê®°ÊãüÊñá‰ª∂ÈÄâÊã©
                updateProgress('Ê≠£Âú®Âä†ËΩΩÊºîÁ§∫Êï∞ÊçÆ...', 10);
                addLog('ÈÄâÊã©ÊºîÁ§∫Ê†∑Êú¨: 2020-05-12-E1-76 (ÂÖãÈõ∑‰ºØÊ∞èËèå)');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Ê≠•È™§2: Ê®°Êãü‰∏ä‰º†
                updateProgress('Ê≠£Âú®Â§ÑÁêÜÂü∫Âõ†ÁªÑÊñá‰ª∂...', 25);
                addLog('Êñá‰ª∂Â§ßÂ∞è: 2.3 MB');
                addLog('Â∫èÂàóÊï∞: 156 contigs');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Ê≠•È™§3: Ê®°ÊãüAMRFinderÂàÜÊûê
                updateProgress('Ê≠£Âú®ËøêË°åAMRFinderÂàÜÊûê...', 40);
                addLog('‰ΩøÁî®Êï∞ÊçÆÂ∫ì: AMRFinderPlus v3.11.26');
                addLog('ÂàÜÊûêÁ±ªÂûã: ÂÖãÈõ∑‰ºØÊ∞èËèå (Klebsiella)');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Ê≠•È™§4: Ê®°ÊãüÂàÜÊûêËøõÂ∫¶
                for (let i = 40; i <= 80; i += 10) {
                    updateProgress(`ÂàÜÊûêËøõË°å‰∏≠... (${i}%)`, i);
                    addLog(`Â§ÑÁêÜ contig ${Math.floor((i-40)/10 * 30 + 1)}/156`);
                    await new Promise(resolve => setTimeout(resolve, 800));
                }
                
                // Ê≠•È™§5: ÂÆåÊàêÂàÜÊûê
                updateProgress('ÂàÜÊûêÂÆåÊàêÔºåÊ≠£Âú®ÁîüÊàêÊä•Âëä...', 90);
                addLog('Ê£ÄÊµãÂà∞ 15 ‰∏™ËÄêËçØÂü∫Âõ†');
                addLog('Ê∂âÂèä 8 ‰∏™ÊäóÁîüÁ¥†Á±ªÂà´');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateProgress('ÂàÜÊûêÂÆåÊàêÔºÅ', 100);
                addLog('Êä•ÂëäÁîüÊàêÊàêÂäü');
                
                // ÁîüÊàêÊºîÁ§∫ÁªìÊûú
                generateDemoResults();
                
                // ÊòæÁ§∫ÁªìÊûúÁïåÈù¢
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                }, 1000);
                
            } catch (error) {
                console.error('ÊºîÁ§∫ÂàÜÊûêÂ§±Ë¥•:', error);
                showError('ÊºîÁ§∫ÂàÜÊûêÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÁîüÊàêÊºîÁ§∫ÁªìÊûú
        function generateDemoResults() {
            // Âü∫‰∫éÁúüÂÆûÊï∞ÊçÆÁöÑÊºîÁ§∫ÁªìÊûú
            const demoResults = [
                {
                    geneSymbol: 'aadA2',
                    sequenceName: 'ANT(3\'\')-Ia family aminoglycoside nucleotidyltransferase AadA2',
                    subclass: 'STREPTOMYCIN',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'rmtB1',
                    sequenceName: '16S rRNA (guanine(1405)-N(7))-methyltransferase RmtB1',
                    subclass: 'AMINOGLYCOSIDE',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'catA2',
                    sequenceName: 'type A-2 chloramphenicol O-acetyltransferase CatII',
                    subclass: 'CHLORAMPHENICOL',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'blaCTX-M-65',
                    sequenceName: 'extended-spectrum class A beta-lactamase CTX-M-65',
                    subclass: 'CEPHALOSPORIN',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'fosA3',
                    sequenceName: 'fosfomycin resistance glutathione transferase FosA3',
                    subclass: 'FOSFOMYCIN',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'sul1',
                    sequenceName: 'sulfonamide-resistant dihydropteroate synthase Sul1',
                    subclass: 'SULFONAMIDE',
                    coverage: 66.67,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'qacEdelta1',
                    sequenceName: 'quaternary ammonium compound efflux SMR transporter QacE delta 1',
                    subclass: 'QUATERNARY AMMONIUM',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'STRESS'
                },
                {
                    geneSymbol: 'blaTEM',
                    sequenceName: 'TEM family class A beta-lactamase',
                    subclass: 'BETA-LACTAM',
                    coverage: 66.43,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'parC_S80I',
                    sequenceName: 'Klebsiella pneumoniae quinolone resistant ParC',
                    subclass: 'QUINOLONE',
                    coverage: 98.84,
                    identity: 99.41,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'fosA',
                    sequenceName: 'FosA5 family fosfomycin resistance glutathione transferase',
                    subclass: 'FOSFOMYCIN',
                    coverage: 100.00,
                    identity: 98.56,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'dfrA1',
                    sequenceName: 'trimethoprim-resistant dihydrofolate reductase DfrA1',
                    subclass: 'TRIMETHOPRIM',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'tet(A)',
                    sequenceName: 'tetracycline efflux MFS transporter Tet(A)',
                    subclass: 'TETRACYCLINE',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'pmrB_R256G',
                    sequenceName: 'Klebsiella pneumoniae colistin resistant PmrB',
                    subclass: 'COLISTIN',
                    coverage: 100.00,
                    identity: 99.45,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'ompK36_D135DGD',
                    sequenceName: 'Klebsiella pneumoniae carbapenem resistant OmpK36',
                    subclass: 'CARBAPENEM',
                    coverage: 100.00,
                    identity: 92.29,
                    elementType: 'AMR'
                },
                {
                    geneSymbol: 'blaSHV-11',
                    sequenceName: 'broad-spectrum class A beta-lactamase SHV-11',
                    subclass: 'BETA-LACTAM',
                    coverage: 100.00,
                    identity: 100.00,
                    elementType: 'AMR'
                }
            ];

            // ËÆæÁΩÆÂÖ®Â±ÄÁªìÊûúÂèòÈáè
            analysisResults = {
                totalGenes: demoResults.length,
                amrGenes: demoResults.filter(r => r.elementType === 'AMR').length,
                antibioticClasses: [...new Set(demoResults.map(r => r.subclass))].length,
                averageIdentity: demoResults.reduce((sum, r) => sum + r.identity, 0) / demoResults.length,
                results: demoResults,
                rawContent: generateDemoTSV(demoResults),
                sampleInfo: {
                    sampleId: '2020-05-12-E1-76',
                    organism: 'Klebsiella pneumoniae',
                    date: '2020-05-12',
                    analysisTime: new Date().toISOString()
                }
            };

            displayStats();
            displayResultsTable();
            generateClinicalReport();
        }

        // ÁîüÊàêÊºîÁ§∫TSVÂÜÖÂÆπ
        function generateDemoTSV(results) {
            let tsvContent = 'Protein identifier\tContig id\tStart\tStop\tStrand\tGene symbol\tSequence name\tScope\tElement type\tElement subtype\tClass\tSubclass\tMethod\tTarget length\tReference sequence length\t% Coverage of reference sequence\t% Identity to reference sequence\tAlignment length\tAccession of closest sequence\tName of closest sequence\tHMM id\tHMM description\n';
            
            results.forEach((result, index) => {
                tsvContent += `NA\tNODE_${index + 1}_length_${Math.floor(Math.random() * 100000) + 1000}_cov_${(Math.random() * 200 + 100).toFixed(2)}\t${Math.floor(Math.random() * 10000)}\t${Math.floor(Math.random() * 10000) + 1000}\t+\t${result.geneSymbol}\t${result.sequenceName}\tcore\t${result.elementType}\t${result.elementType}\t${result.subclass.split('/')[0]}\t${result.subclass}\tEXACTX\t${Math.floor(Math.random() * 500) + 100}\t${Math.floor(Math.random() * 500) + 100}\t${result.coverage.toFixed(2)}\t${result.identity.toFixed(2)}\t${Math.floor(Math.random() * 500) + 100}\tWP_${String(Math.floor(Math.random() * 999999999)).padStart(9, '0')}.1\t${result.sequenceName}\tNA\tNA\n`;
            });
            
            return tsvContent;
        }

        // ÁîüÊàê‰∏¥Â∫äÊä•Âëä
        function generateClinicalReport() {
            if (!analysisResults || !analysisResults.sampleInfo) return;

            const results = analysisResults.results;
            const sampleInfo = analysisResults.sampleInfo;
            
            // ÂàÜÊûêÊäóÁîüÁ¥†ËÄêËçØÊÉÖÂÜµ
            const resistanceProfile = {};
            const riskLevels = {};
            
            results.forEach(gene => {
                if (gene.elementType === 'AMR') {
                    const antibiotic = gene.subclass;
                    if (!resistanceProfile[antibiotic]) {
                        resistanceProfile[antibiotic] = [];
                    }
                    resistanceProfile[antibiotic].push(gene.geneSymbol);
                    
                    // ËØÑ‰º∞È£éÈô©Á≠âÁ∫ß
                    let risk = 'Medium';
                    if (gene.identity >= 99 && gene.coverage >= 95) {
                        risk = 'High';
                    } else if (gene.identity < 95 || gene.coverage < 70) {
                        risk = 'Low';
                    }
                    riskLevels[antibiotic] = risk;
                }
            });

            // ÁîüÊàêÊé®ËçêÂíåÈÅøÂÖçÁöÑÊäóÁîüÁ¥†ÂàóË°®
            const highRiskAntibiotics = Object.entries(riskLevels)
                .filter(([, risk]) => risk === 'High')
                .map(([antibiotic]) => antibiotic);
            
            const mediumRiskAntibiotics = Object.entries(riskLevels)
                .filter(([, risk]) => risk === 'Medium')
                .map(([antibiotic]) => antibiotic);

            // Êé®ËçêÁöÑÊäóÁîüÁ¥†Ôºà‰∏çÂú®ËÄêËçØÂàóË°®‰∏≠ÁöÑÔºâ
            const allAntibiotics = [
                'MEROPENEM', 'IMIPENEM', 'ERTAPENEM', 'DORIPENEM',
                'AMIKACIN', 'GENTAMICIN', 'TOBRAMYCIN',
                'CIPROFLOXACIN', 'LEVOFLOXACIN', 'MOXIFLOXACIN',
                'TIGECYCLINE', 'COLISTIN', 'POLYMYXIN B',
                'CEFTAZIDIME-AVIBACTAM', 'MEROPENEM-VABORBACTAM'
            ];
            
            const resistantAntibiotics = Object.keys(resistanceProfile).map(a => a.toUpperCase());
            const recommendedAntibiotics = allAntibiotics.filter(a => 
                !resistantAntibiotics.some(ra => a.includes(ra.split('/')[0]) || ra.includes(a))
            );

            // Âú®ÁªìÊûúÈÉ®ÂàÜÊ∑ªÂä†‰∏¥Â∫äÂàÜÊûêÊä•Âëä
            const resultsSection = document.getElementById('resultsSection');
            const clinicalReport = document.createElement('div');
            clinicalReport.style.cssText = `
                margin-top: 30px;
                padding: 25px;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                border-radius: 15px;
                border-left: 5px solid #dc3545;
            `;
            
            clinicalReport.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üè• ‰∏¥Â∫äÂàÜÊûêÊä•Âëä
                </h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">üö´ ÈÅøÂÖç‰ΩøÁî®ÁöÑÊäóÁîüÁ¥†</h4>
                        <div style="margin-bottom: 10px;"><strong>È´òÈ£éÈô© (ÈÅøÂÖç‰ΩøÁî®):</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #dc3545;">
                            ${highRiskAntibiotics.map(ab => `<li>${ab} - Ê£ÄÊµãÂà∞Áõ∏ÂÖ≥ËÄêËçØÂü∫Âõ†</li>`).join('')}
                        </ul>
                        <div style="margin-bottom: 10px;"><strong>‰∏≠Á≠âÈ£éÈô© (Ë∞®ÊÖé‰ΩøÁî®):</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #fd7e14;">
                            ${mediumRiskAntibiotics.map(ab => `<li>${ab} - ÈúÄË¶ÅËçØÊïèËØïÈ™åÁ°ÆËÆ§</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="color: #28a745; margin-bottom: 15px;">‚úÖ Êé®Ëçê‰ΩøÁî®ÁöÑÊäóÁîüÁ¥†</h4>
                        <div style="margin-bottom: 10px;"><strong>È¶ñÈÄâËçØÁâ©:</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #28a745;">
                            ${recommendedAntibiotics.slice(0, 5).map(ab => `<li>${ab}</li>`).join('')}
                        </ul>
                        <div style="margin-bottom: 10px;"><strong>Â§áÈÄâËçØÁâ©:</strong></div>
                        <ul style="margin: 0 0 15px 20px; color: #17a2b8;">
                            ${recommendedAntibiotics.slice(5, 8).map(ab => `<li>${ab}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è ‰∏¥Â∫äÂª∫ËÆÆ</h4>
                    <ul style="margin: 0 0 0 20px; color: #856404;">
                        <li>ËØ•ËèåÊ†™ÊòæÁ§∫Â§öÈáçËÄêËçØÁâπÂæÅÔºåÂª∫ËÆÆËøõË°åËçØÊïèËØïÈ™åÁ°ÆËÆ§</li>
                        <li>Ê£ÄÊµãÂà∞Á¢≥ÈùíÈúâÁÉØÁ±ªËÄêËçØÂü∫Âõ†ÔºåÈÅøÂÖç‰ΩøÁî®ËØ•Á±ªÊäóÁîüÁ¥†</li>
                        <li>Êé®ËçêËÅîÂêàÁî®ËçØÊ≤ªÁñó‰∏•ÈáçÊÑüÊüì</li>
                        <li>Âä†Âº∫ÊÑüÊüìÊéßÂà∂Êé™ÊñΩÔºåÈò≤Ê≠¢ËÄêËçØËèå‰º†Êí≠</li>
                        <li>ÂÆöÊúüÁõëÊµãÊ≤ªÁñóÊïàÊûúÂíåÁªÜËèåÂ≠¶Ê∏ÖÈô§ÊÉÖÂÜµ</li>
                    </ul>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(23, 162, 184, 0.1); border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <h4 style="color: #0c5460; margin-bottom: 10px;">üìä Ê†∑Êú¨‰ø°ÊÅØ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; color: #0c5460;">
                        <div><strong>Ê†∑Êú¨ÁºñÂè∑:</strong> ${sampleInfo.sampleId}</div>
                        <div><strong>ËèåÁßç:</strong> ${sampleInfo.organism}</div>
                        <div><strong>ÈááÊ†∑Êó•Êúü:</strong> ${sampleInfo.date}</div>
                        <div><strong>ÂàÜÊûêÊó∂Èó¥:</strong> ${new Date(sampleInfo.analysisTime).toLocaleString()}</div>
                        <div><strong>ËÄêËçØÂü∫Âõ†Êï∞:</strong> ${analysisResults.amrGenes}</div>
                        <div><strong>Âπ≥ÂùáÁõ∏‰ººÂ∫¶:</strong> ${analysisResults.averageIdentity.toFixed(1)}%</div>
                    </div>
                </div>
            `;
            
            resultsSection.appendChild(clinicalReport);
        }
    </script>
</body>
</html>
