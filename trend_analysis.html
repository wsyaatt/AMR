<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè¡Œè¶‹åŠ¿åˆ†æ - è€è¯åŸºå› åˆ†æå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .back-button {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) translateX(-5px);
        }

        @media (max-width: 768px) {
            .back-button {
                position: static;
                transform: none;
                display: inline-block;
                margin-bottom: 20px;
            }
            
            .back-button:hover {
                transform: none;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 500;
            color: #555;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">â† è¿”å›ä¸»é¡µ</a>
            <h1>ğŸ“Š æµè¡Œè¶‹åŠ¿åˆ†æ</h1>
            <p>åŸºäºAMRFinderæ•°æ®çš„æŠ—ç”Ÿç´ è€è¯åŸºå› å’Œè¡¨å‹æœˆåº¦æµè¡Œè¶‹åŠ¿åˆ†æ</p>
        </div>

        <div id="loading" class="loading">
            <p>è¯·é€‰æ‹©æ‚¨çš„AMRFinderæ•°æ®æ–‡ä»¶å¤¹è¿›è¡Œåˆ†æ</p>
            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                ğŸ“ é€‰æ‹©AMRFinderæ–‡ä»¶å¤¹
            </button>
            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ” æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©
            </button>
            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                ğŸ“‚ å¼ºåˆ¶åŠ è½½æ‰€æœ‰æ–‡ä»¶
            </button>
            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">é€‰æ‹©åŒ…å«528ä¸ªTSVæ–‡ä»¶çš„amrfinder_delæ–‡ä»¶å¤¹</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSamples">0</div>
                    <div class="stat-label">æ€»æ ·æœ¬æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalGenes">0</div>
                    <div class="stat-label">è€è¯åŸºå› ç§ç±»</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalAntibiotics">0</div>
                    <div class="stat-label">æŠ—ç”Ÿç´ ç±»å‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="timeSpan">0</div>
                    <div class="stat-label">ç›‘æµ‹æœˆæ•°</div>
                </div>
            </div>

            <div class="chart-grid">
                <!-- æœˆåº¦è¯¦æƒ…æŸ¥çœ‹å™¨ -->
                <div class="chart-container">
                    <h3 class="chart-title">ğŸ“… æœˆåº¦æµè¡Œæƒ…å†µè¯¦æƒ…</h3>
                                <div class="controls">
                <div class="control-group">
                    <label>é€‰æ‹©æœˆä»½:</label>
                    <select id="monthSelector" style="min-width: 150px;">
                        <option value="">è¯·é€‰æ‹©æœˆä»½</option>
                    </select>
                </div>
                <div class="control-group">
                    <button onclick="toggleExportSection()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;">
                        ğŸ“‹ æ•°æ®å¯¼å‡º
                    </button>
                </div>
            </div>
                    <div id="monthlyDetails" style="display: none;">
                        <div class="two-column" style="margin-top: 20px;">
                            <div class="alert-card" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #856404; margin: 0 0 10px 0;">âš ï¸ é«˜æµè¡Œè€è¯åŸºå› </h4>
                                <div id="highRiskGenes"></div>
                            </div>
                            <div class="alert-card" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #721c24; margin: 0 0 10px 0;">ğŸš« é¿å…ä½¿ç”¨çš„æŠ—ç”Ÿç´ </h4>
                                <div id="avoidAntibiotics"></div>
                            </div>
                        </div>
                        <div class="two-column" style="margin-top: 20px;">
                            <div class="chart-wrapper" style="height: 300px;">
                                <canvas id="monthlyGeneChart"></canvas>
                            </div>
                            <div class="chart-wrapper" style="height: 300px;">
                                <canvas id="monthlyAntibioticChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">æœˆåº¦è€è¯åŸºå› æµè¡Œè¶‹åŠ¿</h3>
                    <div class="controls">
                        <div class="control-group">
                            <label>é€‰æ‹©åŸºå› :</label>
                            <select id="geneFilter" multiple style="min-width: 200px;">
                                <option value="all">æ˜¾ç¤ºæ‰€æœ‰åŸºå› </option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>æ˜¾ç¤ºå‰:</label>
                            <select id="topGenesCount">
                                <option value="10">10ä¸ª</option>
                                <option value="20" selected>20ä¸ª</option>
                                <option value="50">50ä¸ª</option>
                                <option value="all">å…¨éƒ¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="geneChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">æœˆåº¦æŠ—ç”Ÿç´ è€è¯è¡¨å‹æµè¡Œè¶‹åŠ¿</h3>
                    <div class="controls">
                        <div class="control-group">
                            <label>é€‰æ‹©æŠ—ç”Ÿç´ :</label>
                            <select id="antibioticFilter" multiple style="min-width: 200px;">
                                <option value="all">æ˜¾ç¤ºæ‰€æœ‰æŠ—ç”Ÿç´ </option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>æ˜¾ç¤ºå‰:</label>
                            <select id="topAntibioticsCount">
                                <option value="10" selected>10ä¸ª</option>
                                <option value="20">20ä¸ª</option>
                                <option value="all">å…¨éƒ¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="antibioticChart"></canvas>
                    </div>
                </div>

                <div class="two-column">
                    <div class="chart-container">
                        <h3 class="chart-title">åŸºå› -æŠ—ç”Ÿç´ å…³è”çƒ­åŠ›å›¾</h3>
                        <div class="chart-wrapper">
                            <canvas id="heatmapChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">æœˆåº¦æ ·æœ¬æ•°é‡ç»Ÿè®¡</h3>
                        <div class="chart-wrapper">
                            <canvas id="sampleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®å¯¼å‡ºå’ŒæŠ¥å‘Šç”Ÿæˆ -->
        <div id="exportSection" class="chart-container" style="display: none;">
            <h3 class="chart-title">ğŸ“‹ æ•°æ®å¯¼å‡ºä¸æŠ¥å‘Šç”Ÿæˆ</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px;">ğŸ“Š æ•°æ®å¯¼å‡º</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="exportData('csv')" style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ“„ å¯¼å‡ºCSVæ•°æ®
                        </button>
                        <button onclick="exportData('excel')" style="padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ“Š å¯¼å‡ºExcelæŠ¥è¡¨
                        </button>
                        <button onclick="exportData('json')" style="padding: 10px; background: #6f42c1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ“‹ å¯¼å‡ºJSONæ•°æ®
                        </button>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px;">ğŸ“‘ æŠ¥å‘Šç”Ÿæˆ</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="generateReport('summary')" style="padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ“ ç”Ÿæˆåˆ†ææ‘˜è¦
                        </button>
                        <button onclick="generateReport('detailed')" style="padding: 10px; background: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ“Š ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
                        </button>
                        <button onclick="generateReport('medical')" style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ¥ ç”ŸæˆåŒ»ç–—å»ºè®®
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="toggleExportSection()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 20px; cursor: pointer;">
                    éšè—å¯¼å‡ºé¢æ¿
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let allData = [];
        let monthlyData = {};
        let geneChart, antibioticChart, heatmapChart, sampleChart;

        // é¢œè‰²ç”Ÿæˆå™¨
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137.508) % 360;
                colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
            return colors;
        }

        // è§£ææ–‡ä»¶åè·å–æ—¥æœŸå’ŒèŒæ ªä¿¡æ¯
        function parseFileName(fileName) {
            const match = fileName.match(/^(\d{4}-\d{2}-\d{2})-(.+)\.tsv$/);
            if (match) {
                return {
                    date: match[1],
                    strain: match[2],
                    month: match[1].substring(0, 7) // YYYY-MMæ ¼å¼
                };
            }
            return null;
        }

        // è¯»å–çœŸå®çš„TSVæ–‡ä»¶æ•°æ®
        async function loadRealData() {
            const data = [];
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;

            return new Promise((resolve, reject) => {
                fileInput.addEventListener('change', async (event) => {
                    console.log('æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘ï¼Œæ€»æ–‡ä»¶æ•°:', event.target.files.length);
                    
                    // åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶è¿›è¡Œè°ƒè¯•
                    const allFiles = Array.from(event.target.files);
                    console.log('æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨:', allFiles.map(f => f.name).slice(0, 10));
                    
                    // æ›´è¯¦ç»†çš„æ–‡ä»¶æ‰©å±•åæ£€æŸ¥
                    console.log('æ–‡ä»¶æ‰©å±•ååˆ†æ:');
                    const extensionMap = {};
                    allFiles.forEach(file => {
                        const name = file.name.toLowerCase();
                        const parts = name.split('.');
                        const ext = parts.length > 1 ? '.' + parts[parts.length - 1] : 'æ— æ‰©å±•å';
                        extensionMap[ext] = (extensionMap[ext] || 0) + 1;
                    });
                    console.log('æ‰©å±•åç»Ÿè®¡:', extensionMap);
                    
                    // æ”¯æŒå¤šç§TSVæ ¼å¼æ£€æŸ¥
                    const files = allFiles.filter(file => {
                        const name = file.name.toLowerCase();
                        return name.endsWith('.tsv') || 
                               name.endsWith('.TSV') || 
                               name.includes('.tsv') ||
                               (name.includes('tsv') && name.includes('-'));
                    });
                    console.log('TSVæ–‡ä»¶æ•°:', files.length);
                    console.log('TSVæ–‡ä»¶ç¤ºä¾‹:', files.slice(0, 5).map(f => f.name));
                    
                    if (files.length === 0) {
                        console.error('æœªæ‰¾åˆ°TSVæ–‡ä»¶ï¼Œæ‰€æœ‰æ–‡ä»¶:', allFiles.map(f => f.name).slice(0, 20));
                        reject(new Error(`æœªæ‰¾åˆ°TSVæ–‡ä»¶ã€‚å…±é€‰æ‹©äº† ${allFiles.length} ä¸ªæ–‡ä»¶ï¼Œä½†æ²¡æœ‰.tsvæ‰©å±•åçš„æ–‡ä»¶ã€‚è¯·ç¡®ä¿é€‰æ‹©äº†åŒ…å«TSVæ–‡ä»¶çš„æ­£ç¡®æ–‡ä»¶å¤¹ã€‚`));
                        return;
                    }

                    console.log(`æ‰¾åˆ° ${files.length} ä¸ªTSVæ–‡ä»¶`);
                    let processedFiles = 0;
                    let validFiles = 0;
                    let filteredGenesCount = 0; // ç»Ÿè®¡è¢«è¿‡æ»¤çš„åŸºå› æ•°é‡ï¼ˆoqxå’ŒfosAï¼‰
                    const totalFiles = files.length;

                    for (const file of files) {
                        try {
                            const fileInfo = parseFileName(file.name);
                            if (!fileInfo) {
                                console.warn(`è·³è¿‡æ–‡ä»¶åæ ¼å¼ä¸æ­£ç¡®çš„æ–‡ä»¶: ${file.name}`);
                                processedFiles++;
                                continue;
                            }

                            const text = await file.text();
                            const lines = text.split('\n');
                            
                            // ç”¨äºå½“å‰æ–‡ä»¶çš„å»é‡
                            const fileGenes = new Set();
                            const fileAntibiotics = new Set();
                            const fileCombinations = new Set();
                            
                            // è·³è¿‡æ ‡é¢˜è¡Œ
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const columns = line.split('\t');
                                if (columns.length >= 12) {
                                    const geneSymbol = columns[5]; // Gene symbolåˆ—
                                    const subclass = columns[11];  // Subclassåˆ—
                                    
                                    if (geneSymbol && subclass && geneSymbol !== 'NA' && subclass !== 'NA') {
                                        // è®°å½•æ‰€æœ‰åŸºå› ï¼ŒåŒ…æ‹¬oqxå’ŒfosAï¼ˆç”¨äºå®Œæ•´åˆ†æï¼‰
                                        // ä½†å¯ä»¥æ ‡è®°è¿™äº›åŸºå› ç”¨äºç‰¹æ®Šå¤„ç†
                                        if (geneSymbol.toLowerCase().includes('oqx') || 
                                            geneSymbol.toLowerCase().includes('fosa')) {
                                            filteredGenesCount++;
                                            // ä¸å†è·³è¿‡è¿™äº›åŸºå› ï¼Œè€Œæ˜¯åŒ…å«åœ¨åˆ†æä¸­
                                        }
                                        
                                        // æ·»åŠ åˆ°å½“å‰æ–‡ä»¶çš„é›†åˆä¸­ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
                                        fileGenes.add(geneSymbol);
                                        fileAntibiotics.add(subclass);
                                        fileCombinations.add(`${geneSymbol}|||${subclass}`);
                                    }
                                }
                            }
                            
                            // å°†å»é‡åçš„æ•°æ®æ·»åŠ åˆ°æ€»æ•°æ®ä¸­
                            let genesFoundInFile = 0;
                            fileCombinations.forEach(combination => {
                                // ä½¿ç”¨å®‰å…¨çš„åˆ†éš”ç¬¦åˆ†å‰²
                                const [gene, antibiotic] = combination.split('|||');
                                
                                data.push({
                                    fileName: file.name,
                                    date: fileInfo.date,
                                    month: fileInfo.month,
                                    strain: fileInfo.strain,
                                    gene: gene,
                                    antibiotic: antibiotic
                                });
                                genesFoundInFile++;
                            });
                            
                            if (genesFoundInFile > 0) {
                                validFiles++;
                            }
                            
                            processedFiles++;
                            // æ›´æ–°è¿›åº¦
                            const progress = Math.round((processedFiles / totalFiles) * 100);
                            document.getElementById('loading').innerHTML = `
                                <p>æ­£åœ¨å¤„ç†æ–‡ä»¶: ${processedFiles}/${totalFiles} (${progress}%)</p>
                                <p>å·²æ‰¾åˆ° ${validFiles} ä¸ªæœ‰æ•ˆæ–‡ä»¶ï¼Œå…± ${data.length} æ¡åŸºå› è®°å½•</p>
                                <p>åŒ…å« ${filteredGenesCount} æ¡oqx/fosAåŸºå› è®°å½•</p>
                            `;
                            
                        } catch (error) {
                            console.warn(`å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™:`, error);
                            processedFiles++;
                        }
                    }

                    console.log(`å¤„ç†å®Œæˆ: ${validFiles} ä¸ªæœ‰æ•ˆæ–‡ä»¶ï¼Œå…± ${data.length} æ¡åŸºå› è®°å½•ï¼ŒåŒ…å« ${filteredGenesCount} æ¡oqx/fosAåŸºå› è®°å½•`);
                    
                    if (data.length === 0) {
                        reject(new Error(`å¤„ç†äº† ${processedFiles} ä¸ªæ–‡ä»¶ï¼Œä½†æœªæ‰¾åˆ°æœ‰æ•ˆçš„åŸºå› æ•°æ®ã€‚è¯·æ£€æŸ¥TSVæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`));
                    } else {
                        resolve(data);
                    }
                });

                fileInput.click();
            });
        }

        // ç”Ÿæˆæ›´å¤šæ¼”ç¤ºæ•°æ®æ¥æ¨¡æ‹ŸçœŸå®çš„528ä¸ªæ–‡ä»¶
        function generateMoreDemoData() {
            const genePool = [
                'fosA', 'oqxA', 'oqxB', 'oqxB25', 'blaSHV-11', 'blaTEM-1', 'blaCTX-M-14', 
                'blaKPC-2', 'tet(A)', 'tet(C)', 'tet(D)', 'catA1', 'sul1', 'sul2', 
                'aph(6)-Id', 'aph(3\')-Ia', 'aac(6\')-Ib3', 'aac(3)-IId', 'qnrB52', 
                'mph(A)', 'dfrA5', 'dfrA12', 'aadA2', 'qacE', 'ramR_A19V', 'parC_S80I',
                'gyrA_D87A', 'gyrA_S83F', 'ompK35_E132K', 'cmlA1'
            ];
            
            const antibioticPool = [
                'FOSFOMYCIN', 'PHENICOL/QUINOLONE', 'BETA-LACTAM', 'CEPHALOSPORIN', 
                'CARBAPENEM', 'TETRACYCLINE', 'CHLORAMPHENICOL', 'SULFONAMIDE', 
                'STREPTOMYCIN', 'KANAMYCIN', 'AMIKACIN/KANAMYCIN/TOBRAMYCIN', 
                'GENTAMICIN', 'QUINOLONE', 'MACROLIDE', 'TRIMETHOPRIM', 
                'QUATERNARY AMMONIUM', 'TIGECYCLINE', 'AZITHROMYCIN/ERYTHROMYCIN/SPIRAMYCIN/TELITHROMYCIN'
            ];

            const geneAntibioticMap = {
                'fosA': 'FOSFOMYCIN',
                'oqxA': 'PHENICOL/QUINOLONE',
                'oqxB': 'PHENICOL/QUINOLONE',
                'oqxB25': 'PHENICOL/QUINOLONE',
                'blaSHV-11': 'BETA-LACTAM',
                'blaTEM-1': 'BETA-LACTAM',
                'blaCTX-M-14': 'CEPHALOSPORIN',
                'blaKPC-2': 'CARBAPENEM',
                'tet(A)': 'TETRACYCLINE',
                'tet(C)': 'TETRACYCLINE',
                'tet(D)': 'TETRACYCLINE',
                'catA1': 'CHLORAMPHENICOL',
                'sul1': 'SULFONAMIDE',
                'sul2': 'SULFONAMIDE',
                'aph(6)-Id': 'STREPTOMYCIN',
                'aph(3\')-Ia': 'KANAMYCIN',
                'aac(6\')-Ib3': 'AMIKACIN/KANAMYCIN/TOBRAMYCIN',
                'aac(3)-IId': 'GENTAMICIN',
                'qnrB52': 'QUINOLONE',
                'mph(A)': 'MACROLIDE',
                'dfrA5': 'TRIMETHOPRIM',
                'dfrA12': 'TRIMETHOPRIM',
                'aadA2': 'STREPTOMYCIN',
                'qacE': 'QUATERNARY AMMONIUM',
                'ramR_A19V': 'TIGECYCLINE',
                'parC_S80I': 'QUINOLONE',
                'gyrA_D87A': 'QUINOLONE',
                'gyrA_S83F': 'QUINOLONE',
                'ompK35_E132K': 'CARBAPENEM',
                'cmlA1': 'CHLORAMPHENICOL'
            };

            const strainPrefixes = ['E1', 'C1', 'C4', 'C5', 'C6'];
            const generatedFiles = [];
            
            // ç”Ÿæˆæ€»å…±528ä¸ªæ ·æœ¬ï¼Œåˆ†å¸ƒåœ¨2016-2023å¹´æœŸé—´
            const totalSamples = 528;
            const totalMonths = 8 * 12; // 2016-2023å¹´å…±96ä¸ªæœˆ
            let samplesGenerated = 0;
            
            // ä¸ºæ¯ä¸ªæœˆåˆ†é…æ ·æœ¬æ•°é‡ï¼Œæœ‰äº›æœˆä»½å¯èƒ½æ²¡æœ‰æ ·æœ¬
            const monthlyDistribution = [];
            for (let year = 2016; year <= 2023; year++) {
                for (let month = 1; month <= 12; month++) {
                    // éšæœºå†³å®šè¿™ä¸ªæœˆæ˜¯å¦æœ‰æ ·æœ¬ï¼ˆ80%æ¦‚ç‡æœ‰æ ·æœ¬ï¼‰
                    if (Math.random() < 0.8 && samplesGenerated < totalSamples) {
                        // éšæœºåˆ†é…1-12ä¸ªæ ·æœ¬ç»™è¿™ä¸ªæœˆ
                        const maxSamples = Math.min(12, totalSamples - samplesGenerated);
                        const samplesThisMonth = Math.floor(Math.random() * maxSamples) + 1;
                        monthlyDistribution.push({
                            year: year,
                            month: month,
                            samples: samplesThisMonth
                        });
                        samplesGenerated += samplesThisMonth;
                    } else {
                        // è¿™ä¸ªæœˆæ²¡æœ‰æ ·æœ¬
                        monthlyDistribution.push({
                            year: year,
                            month: month,
                            samples: 0
                        });
                    }
                }
            }
            
            // å¦‚æœè¿˜æ²¡è¾¾åˆ°528ä¸ªæ ·æœ¬ï¼Œéšæœºç»™ä¸€äº›æœˆä»½å¢åŠ æ ·æœ¬
            while (samplesGenerated < totalSamples) {
                const randomMonth = monthlyDistribution[Math.floor(Math.random() * monthlyDistribution.length)];
                if (randomMonth.samples > 0 && randomMonth.samples < 15) {
                    randomMonth.samples++;
                    samplesGenerated++;
                }
            }
            
            // æ ¹æ®åˆ†é…ç”Ÿæˆæ ·æœ¬æ–‡ä»¶
            monthlyDistribution.forEach(monthData => {
                for (let sample = 0; sample < monthData.samples; sample++) {
                    const day = Math.floor(Math.random() * 28) + 1;
                    const strainPrefix = strainPrefixes[Math.floor(Math.random() * strainPrefixes.length)];
                    const strainNumber = Math.floor(Math.random() * 200) + 1;
                    
                    const fileName = `${monthData.year}-${monthData.month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}-${strainPrefix}-${strainNumber}.tsv`;
                    
                    // æ¯ä¸ªæ ·æœ¬éšæœºåŒ…å«3-8ä¸ªåŸºå› 
                    const numGenes = Math.floor(Math.random() * 6) + 3;
                    const selectedGenes = [];
                    const usedGenes = new Set();
                    
                    for (let g = 0; g < numGenes; g++) {
                        let gene;
                        do {
                            gene = genePool[Math.floor(Math.random() * genePool.length)];
                        } while (usedGenes.has(gene));
                        
                        usedGenes.add(gene);
                        selectedGenes.push({
                            gene: gene,
                            antibiotic: geneAntibioticMap[gene]
                        });
                    }
                    
                    generatedFiles.push({
                        name: fileName,
                        genes: selectedGenes
                    });
                }
            });
            
            return generatedFiles;
        }

        // ä½¿ç”¨å†…ç½®æ•°æ®ä½œä¸ºæ¼”ç¤ºï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©æ–‡ä»¶å¤¹ï¼‰
        async function loadDemoData() {
            // ç”Ÿæˆå¤§é‡æ¼”ç¤ºæ•°æ®æ¥æ¨¡æ‹ŸçœŸå®çš„528ä¸ªæ–‡ä»¶
            const demoFiles = generateMoreDemoData();
            console.log(`ç”Ÿæˆäº† ${demoFiles.length} ä¸ªæ¼”ç¤ºæ–‡ä»¶`);
            
            const data = [];
            demoFiles.forEach(fileData => {
                const fileInfo = parseFileName(fileData.name);
                if (fileInfo) {
                    fileData.genes.forEach(geneInfo => {
                        data.push({
                            fileName: fileData.name,
                            date: fileInfo.date,
                            month: fileInfo.month,
                            strain: fileInfo.strain,
                            gene: geneInfo.gene,
                            antibiotic: geneInfo.antibiotic
                        });
                    });
                }
            });

            return data;
        }

        // ä¸»æ•°æ®åŠ è½½å‡½æ•°
        async function loadData() {
            // é¦–å…ˆå°è¯•ä½¿ç”¨æ¼”ç¤ºæ•°æ®
            try {
                return await loadDemoData();
            } catch (error) {
                console.error('åŠ è½½æ¼”ç¤ºæ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // å¤„ç†æœˆåº¦æ•°æ®
        function processMonthlyData(data) {
            const monthly = {};
            
            // è·å–æ‰€æœ‰æœˆä»½èŒƒå›´
            const allMonths = [...new Set(data.map(d => d.month))].sort();
            const startMonth = allMonths[0];
            const endMonth = allMonths[allMonths.length - 1];
            
            // ç”Ÿæˆå®Œæ•´çš„æœˆä»½åˆ—è¡¨
            const completeMonths = [];
            let current = new Date(startMonth + '-01');
            const end = new Date(endMonth + '-01');
            
            while (current <= end) {
                const monthStr = current.toISOString().substring(0, 7);
                completeMonths.push(monthStr);
                current.setMonth(current.getMonth() + 1);
            }
            
            // åˆå§‹åŒ–æ‰€æœ‰æœˆä»½
            completeMonths.forEach(month => {
                monthly[month] = {
                    samples: new Set(),
                    genesPerSample: {}, // è®°å½•æ¯ä¸ªæ ·æœ¬çš„åŸºå› 
                    antibioticsPerSample: {}, // è®°å½•æ¯ä¸ªæ ·æœ¬çš„æŠ—ç”Ÿç´ 
                    genes: {},
                    antibiotics: {},
                    totalSamples: 0
                };
            });
            
            // å¡«å……æ•°æ® - æŒ‰æ ·æœ¬å»é‡ç»Ÿè®¡
            data.forEach(record => {
                const month = record.month;
                if (monthly[month]) {
                    monthly[month].samples.add(record.fileName);
                    
                    // ä¸ºæ¯ä¸ªæ ·æœ¬è®°å½•åŸºå› å’ŒæŠ—ç”Ÿç´ ï¼ˆå·²å»é‡ï¼‰
                    if (!monthly[month].genesPerSample[record.fileName]) {
                        monthly[month].genesPerSample[record.fileName] = new Set();
                    }
                    if (!monthly[month].antibioticsPerSample[record.fileName]) {
                        monthly[month].antibioticsPerSample[record.fileName] = new Set();
                    }
                    
                    monthly[month].genesPerSample[record.fileName].add(record.gene);
                    monthly[month].antibioticsPerSample[record.fileName].add(record.antibiotic);
                }
            });
            
            // ç»Ÿè®¡æ¯ä¸ªåŸºå› å’ŒæŠ—ç”Ÿç´ åœ¨å¤šå°‘ä¸ªæ ·æœ¬ä¸­å‡ºç°
            Object.keys(monthly).forEach(month => {
                monthly[month].totalSamples = monthly[month].samples.size;
                
                // ç»Ÿè®¡åŸºå› å‡ºç°åœ¨å¤šå°‘ä¸ªæ ·æœ¬ä¸­
                Object.values(monthly[month].genesPerSample).forEach(geneSet => {
                    geneSet.forEach(gene => {
                        if (!monthly[month].genes[gene]) {
                            monthly[month].genes[gene] = 0;
                        }
                        monthly[month].genes[gene]++;
                    });
                });
                
                // ç»Ÿè®¡æŠ—ç”Ÿç´ å‡ºç°åœ¨å¤šå°‘ä¸ªæ ·æœ¬ä¸­
                Object.values(monthly[month].antibioticsPerSample).forEach(antibioticSet => {
                    antibioticSet.forEach(antibiotic => {
                        if (!monthly[month].antibiotics[antibiotic]) {
                            monthly[month].antibiotics[antibiotic] = 0;
                        }
                        monthly[month].antibiotics[antibiotic]++;
                    });
                });
            });
            
            return monthly;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(data, monthlyData) {
            const totalSamples = new Set(data.map(d => d.fileName)).size;
            const totalGenes = new Set(data.map(d => d.gene)).size;
            const totalAntibiotics = new Set(data.map(d => d.antibiotic)).size;
            const timeSpan = Object.keys(monthlyData).length;
            
            document.getElementById('totalSamples').textContent = totalSamples;
            document.getElementById('totalGenes').textContent = totalGenes;
            document.getElementById('totalAntibiotics').textContent = totalAntibiotics;
            document.getElementById('timeSpan').textContent = timeSpan;
        }

        // æ›´æ–°åŸºå› è¿‡æ»¤å™¨é€‰é¡¹
        function updateGeneFilter(data) {
            const geneSelect = document.getElementById('geneFilter');
            const allGenes = [...new Set(data.map(d => d.gene))].sort();
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™"æ˜¾ç¤ºæ‰€æœ‰åŸºå› "é€‰é¡¹
            geneSelect.innerHTML = '<option value="all">æ˜¾ç¤ºæ‰€æœ‰åŸºå› </option>';
            
            allGenes.forEach(gene => {
                const option = document.createElement('option');
                option.value = gene;
                option.textContent = gene;
                geneSelect.appendChild(option);
            });
        }

        // åˆ›å»ºåŸºå› æµè¡Œè¶‹åŠ¿å›¾
        function createGeneChart(monthlyData) {
            const ctx = document.getElementById('geneChart').getContext('2d');
            
            // è·å–é€‰æ‹©çš„åŸºå› è¿‡æ»¤å™¨
            const geneFilter = document.getElementById('geneFilter').value;
            const topCount = document.getElementById('topGenesCount').value;
            
            // è·å–æ‰€æœ‰åŸºå› å¹¶æŒ‰æ€»å‡ºç°æ¬¡æ•°æ’åº
            const geneStats = {};
            Object.values(monthlyData).forEach(month => {
                Object.entries(month.genes).forEach(([gene, count]) => {
                    geneStats[gene] = (geneStats[gene] || 0) + count;
                });
            });
            
            let sortedGenes = Object.entries(geneStats)
                .sort((a, b) => b[1] - a[1])
                .map(([gene]) => gene);
            
            // åº”ç”¨åŸºå› è¿‡æ»¤å™¨
            if (geneFilter !== 'all') {
                const selectedGenes = Array.from(document.getElementById('geneFilter').selectedOptions)
                    .map(option => option.value)
                    .filter(value => value !== 'all');
                if (selectedGenes.length > 0) {
                    sortedGenes = sortedGenes.filter(gene => selectedGenes.includes(gene));
                }
            }
            
            // åº”ç”¨æ•°é‡é™åˆ¶
            if (topCount !== 'all') {
                sortedGenes = sortedGenes.slice(0, parseInt(topCount));
            }
            
            const months = Object.keys(monthlyData).sort();
            const colors = generateColors(sortedGenes.length);
            
            const datasets = sortedGenes.map((gene, index) => ({
                label: gene,
                data: months.map(month => {
                    const count = monthlyData[month].genes[gene] || 0;
                    const totalSamples = monthlyData[month].totalSamples || 1;
                    return totalSamples > 0 ? parseFloat(((count / totalSamples) * 100).toFixed(1)) : 0;
                }),
                borderColor: colors[index],
                backgroundColor: colors[index].replace('0.8', '0.3'),
                fill: false,
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6
            }));
            
            if (geneChart) {
                geneChart.destroy();
            }
            
            geneChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'è€è¯åŸºå› æœˆåº¦æµè¡Œç‡ (%)',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return 'æœˆä»½: ' + context[0].label;
                                },
                                label: function(context) {
                                    const month = context.label;
                                    const gene = context.dataset.label;
                                    const rate = context.parsed.y;
                                    const count = monthlyData[month].genes[gene] || 0;
                                    const total = monthlyData[month].totalSamples;
                                    return `${gene}: ${rate}% (${count}/${total})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æµè¡Œç‡ (%)',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆä»½',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // æ›´æ–°æŠ—ç”Ÿç´ è¿‡æ»¤å™¨é€‰é¡¹
        function updateAntibioticFilter(data) {
            const antibioticSelect = document.getElementById('antibioticFilter');
            const allAntibiotics = [...new Set(data.map(d => d.antibiotic))].sort();
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™"æ˜¾ç¤ºæ‰€æœ‰æŠ—ç”Ÿç´ "é€‰é¡¹
            antibioticSelect.innerHTML = '<option value="all">æ˜¾ç¤ºæ‰€æœ‰æŠ—ç”Ÿç´ </option>';
            
            allAntibiotics.forEach(antibiotic => {
                const option = document.createElement('option');
                option.value = antibiotic;
                option.textContent = antibiotic;
                antibioticSelect.appendChild(option);
            });
        }

        // åˆ›å»ºæŠ—ç”Ÿç´ æµè¡Œè¶‹åŠ¿å›¾
        function createAntibioticChart(monthlyData) {
            const ctx = document.getElementById('antibioticChart').getContext('2d');
            
            // è·å–é€‰æ‹©çš„æŠ—ç”Ÿç´ è¿‡æ»¤å™¨
            const antibioticFilter = document.getElementById('antibioticFilter').value;
            const topCount = document.getElementById('topAntibioticsCount').value;
            
            // è·å–æ‰€æœ‰æŠ—ç”Ÿç´ å¹¶æŒ‰æ€»å‡ºç°æ¬¡æ•°æ’åº
            const antibioticStats = {};
            Object.values(monthlyData).forEach(month => {
                Object.entries(month.antibiotics).forEach(([antibiotic, count]) => {
                    antibioticStats[antibiotic] = (antibioticStats[antibiotic] || 0) + count;
                });
            });
            
            let sortedAntibiotics = Object.entries(antibioticStats)
                .sort((a, b) => b[1] - a[1])
                .map(([antibiotic]) => antibiotic);
            
            // åº”ç”¨æŠ—ç”Ÿç´ è¿‡æ»¤å™¨
            if (antibioticFilter !== 'all') {
                const selectedAntibiotics = Array.from(document.getElementById('antibioticFilter').selectedOptions)
                    .map(option => option.value)
                    .filter(value => value !== 'all');
                if (selectedAntibiotics.length > 0) {
                    sortedAntibiotics = sortedAntibiotics.filter(antibiotic => selectedAntibiotics.includes(antibiotic));
                }
            }
            
            // åº”ç”¨æ•°é‡é™åˆ¶
            if (topCount !== 'all') {
                sortedAntibiotics = sortedAntibiotics.slice(0, parseInt(topCount));
            }
            
            const months = Object.keys(monthlyData).sort();
            const colors = generateColors(sortedAntibiotics.length);
            
            const datasets = sortedAntibiotics.map((antibiotic, index) => ({
                label: antibiotic,
                data: months.map(month => {
                    const count = monthlyData[month].antibiotics[antibiotic] || 0;
                    const totalSamples = monthlyData[month].totalSamples || 1;
                    return totalSamples > 0 ? parseFloat(((count / totalSamples) * 100).toFixed(1)) : 0;
                }),
                borderColor: colors[index],
                backgroundColor: colors[index].replace('0.8', '0.3'),
                fill: false,
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6
            }));
            
            if (antibioticChart) {
                antibioticChart.destroy();
            }
            
            antibioticChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æŠ—ç”Ÿç´ è€è¯è¡¨å‹æœˆåº¦æµè¡Œç‡ (%)',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return 'æœˆä»½: ' + context[0].label;
                                },
                                label: function(context) {
                                    const month = context.label;
                                    const antibiotic = context.dataset.label;
                                    const rate = context.parsed.y;
                                    const count = monthlyData[month].antibiotics[antibiotic] || 0;
                                    const total = monthlyData[month].totalSamples;
                                    return `${antibiotic}: ${rate}% (${count}/${total})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æµè¡Œç‡ (%)',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆä»½',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // åˆ›å»ºæ ·æœ¬æ•°é‡ç»Ÿè®¡å›¾
        function createSampleChart(monthlyData) {
            const ctx = document.getElementById('sampleChart').getContext('2d');
            
            const months = Object.keys(monthlyData).sort();
            const sampleCounts = months.map(month => monthlyData[month].totalSamples);
            
            if (sampleChart) {
                sampleChart.destroy();
            }
            
            sampleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'æ ·æœ¬æ•°é‡',
                        data: sampleCounts,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ ·æœ¬æ•°é‡'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æœˆä»½'
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºçƒ­åŠ›å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function createHeatmapChart(data) {
            const ctx = document.getElementById('heatmapChart').getContext('2d');
            
            // è®¡ç®—åŸºå› -æŠ—ç”Ÿç´ å…³è”
            const associations = {};
            data.forEach(record => {
                const key = `${record.gene}-${record.antibiotic}`;
                associations[key] = (associations[key] || 0) + 1;
            });
            
            // è·å–å‰10ä¸ªæœ€å¸¸è§çš„å…³è”
            const topAssociations = Object.entries(associations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (heatmapChart) {
                heatmapChart.destroy();
            }
            
            heatmapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topAssociations.map(([key]) => key.replace('-', ' â†’ ')),
                    datasets: [{
                        label: 'å‡ºç°æ¬¡æ•°',
                        data: topAssociations.map(([, count]) => count),
                        backgroundColor: generateColors(topAssociations.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å‡ºç°æ¬¡æ•°'
                            }
                        }
                    }
                }
            });
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function showAnalysis(data) {
            allData = data;
            monthlyData = processMonthlyData(data);
            
            // æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹
            updateGeneFilter(data);
            updateAntibioticFilter(data);
            updateMonthSelector(monthlyData);
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats(data, monthlyData);
            
            // åˆ›å»ºå›¾è¡¨
            createGeneChart(monthlyData);
            createAntibioticChart(monthlyData);
            createSampleChart(monthlyData);
            createHeatmapChart(data);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // æ˜¾ç¤ºä»ªè¡¨æ¿
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // æ›´æ–°æœˆä»½é€‰æ‹©å™¨
        function updateMonthSelector(monthlyData) {
            const monthSelector = document.getElementById('monthSelector');
            const months = Object.keys(monthlyData).sort();
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            monthSelector.innerHTML = '<option value="">è¯·é€‰æ‹©æœˆä»½</option>';
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                const sampleCount = monthlyData[month].totalSamples;
                option.textContent = `${month} (${sampleCount}ä¸ªæ ·æœ¬)`;
                monthSelector.appendChild(option);
            });
        }

        // æ˜¾ç¤ºæœˆåº¦è¯¦æƒ…
        function showMonthlyDetails(month) {
            if (!month || !monthlyData[month]) {
                document.getElementById('monthlyDetails').style.display = 'none';
                return;
            }

            const monthData = monthlyData[month];
            document.getElementById('monthlyDetails').style.display = 'block';

            // æ˜¾ç¤ºé«˜é£é™©åŸºå› 
            const geneEntries = Object.entries(monthData.genes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let highRiskGenesHtml = '';
            if (geneEntries.length > 0) {
                geneEntries.forEach(([gene, count]) => {
                    const rate = ((count / monthData.totalSamples) * 100).toFixed(1);
                    highRiskGenesHtml += `<div style="margin: 5px 0;"><strong>${gene}</strong>: ${rate}% (${count}/${monthData.totalSamples})</div>`;
                });
            } else {
                highRiskGenesHtml = '<div style="color: #28a745;">æœ¬æœˆæ— è€è¯åŸºå› æ£€å‡º</div>';
            }
            document.getElementById('highRiskGenes').innerHTML = highRiskGenesHtml;

            // æ˜¾ç¤ºéœ€è¦é¿å…çš„æŠ—ç”Ÿç´ 
            const antibioticEntries = Object.entries(monthData.antibiotics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let avoidAntibioticsHtml = '';
            if (antibioticEntries.length > 0) {
                avoidAntibioticsHtml += '<div style="margin-bottom: 10px; font-size: 14px; color: #721c24;"><strong>å»ºè®®é¿å…ä½¿ç”¨ä»¥ä¸‹æŠ—ç”Ÿç´ ï¼š</strong></div>';
                antibioticEntries.forEach(([antibiotic, count]) => {
                    const rate = ((count / monthData.totalSamples) * 100).toFixed(1);
                    let riskLevel = 'ä¸­ç­‰é£é™©';
                    let riskColor = '#ffc107';
                    if (rate >= 70) {
                        riskLevel = 'é«˜é£é™©';
                        riskColor = '#dc3545';
                    } else if (rate >= 40) {
                        riskLevel = 'ä¸­é«˜é£é™©';
                        riskColor = '#fd7e14';
                    } else if (rate < 20) {
                        riskLevel = 'ä½é£é™©';
                        riskColor = '#28a745';
                    }
                    avoidAntibioticsHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${antibiotic}</strong>
                                <span style="color: ${riskColor}; font-weight: bold;">${riskLevel}</span>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">è€è¯ç‡: ${rate}% (${count}/${monthData.totalSamples}ä¸ªæ ·æœ¬)</div>
                        </div>
                    `;
                });
            } else {
                avoidAntibioticsHtml = '<div style="color: #28a745;">æœ¬æœˆæ— æŠ—ç”Ÿç´ è€è¯æ£€å‡º</div>';
            }
            document.getElementById('avoidAntibiotics').innerHTML = avoidAntibioticsHtml;

            // åˆ›å»ºæœˆåº¦åŸºå› å›¾è¡¨
            createMonthlyGeneChart(month, monthData);
            createMonthlyAntibioticChart(month, monthData);
        }

        // åˆ›å»ºæœˆåº¦åŸºå› å›¾è¡¨
        function createMonthlyGeneChart(month, monthData) {
            const ctx = document.getElementById('monthlyGeneChart').getContext('2d');
            
            const geneEntries = Object.entries(monthData.genes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (window.monthlyGeneChart) {
                window.monthlyGeneChart.destroy();
            }
            
            window.monthlyGeneChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: geneEntries.map(([gene]) => gene),
                    datasets: [{
                        data: geneEntries.map(([, count]) => count),
                        backgroundColor: generateColors(geneEntries.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${month} è€è¯åŸºå› åˆ†å¸ƒ`
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // åˆ›å»ºæœˆåº¦æŠ—ç”Ÿç´ å›¾è¡¨
        function createMonthlyAntibioticChart(month, monthData) {
            const ctx = document.getElementById('monthlyAntibioticChart').getContext('2d');
            
            const antibioticEntries = Object.entries(monthData.antibiotics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            if (window.monthlyAntibioticChart) {
                window.monthlyAntibioticChart.destroy();
            }
            
            window.monthlyAntibioticChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: antibioticEntries.map(([antibiotic]) => antibiotic),
                    datasets: [{
                        label: 'è€è¯ç‡ (%)',
                        data: antibioticEntries.map(([, count]) => 
                            ((count / monthData.totalSamples) * 100).toFixed(1)
                        ),
                        backgroundColor: antibioticEntries.map(([, count]) => {
                            const rate = (count / monthData.totalSamples) * 100;
                            if (rate >= 70) return '#dc3545';
                            if (rate >= 40) return '#fd7e14';
                            if (rate >= 20) return '#ffc107';
                            return '#28a745';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${month} æŠ—ç”Ÿç´ è€è¯ç‡`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'è€è¯ç‡ (%)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æœˆä»½é€‰æ‹©å™¨äº‹ä»¶
            document.getElementById('monthSelector').addEventListener('change', (e) => {
                showMonthlyDetails(e.target.value);
            });
            
            // åŸºå› å›¾è¡¨æ§ä»¶äº‹ä»¶
            document.getElementById('geneFilter').addEventListener('change', () => {
                createGeneChart(monthlyData);
            });
            
            document.getElementById('topGenesCount').addEventListener('change', () => {
                createGeneChart(monthlyData);
            });
            
            // æŠ—ç”Ÿç´ å›¾è¡¨æ§ä»¶äº‹ä»¶
            document.getElementById('antibioticFilter').addEventListener('change', () => {
                createAntibioticChart(monthlyData);
            });
            
            document.getElementById('topAntibioticsCount').addEventListener('change', () => {
                createAntibioticChart(monthlyData);
            });
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function initApp() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                
                // è®¾ç½®æµ‹è¯•æŒ‰é’®äº‹ä»¶
                document.getElementById('testFolderSelection').addEventListener('click', async () => {
                    try {
                        document.getElementById('loading').innerHTML = '<p>æ­£åœ¨æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½...</p>';
                        await testFolderSelection();
                    } catch (error) {
                        console.error('æµ‹è¯•å¤±è´¥:', error);
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = 'æµ‹è¯•å¤±è´¥: ' + error.message;
                    }
                });
                
                // è®¾ç½®å¼ºåˆ¶åŠ è½½æŒ‰é’®äº‹ä»¶
                document.getElementById('loadAllFiles').addEventListener('click', async () => {
                    try {
                        document.getElementById('loading').innerHTML = '<p>æ­£åœ¨å¼ºåˆ¶è¯»å–æ‰€æœ‰æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>';
                        const realData = await loadAllFiles();
                        if (realData.length > 0) {
                            allData = realData;
                            processData();
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('dashboard').style.display = 'block';
                        } else {
                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
                        }
                    } catch (error) {
                        console.error('åŠ è½½å¤±è´¥:', error);
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
                        
                        // é‡ç½®ç•Œé¢
                        document.getElementById('loading').innerHTML = `
                            <p>è¯·é€‰æ‹©æ‚¨çš„AMRFinderæ•°æ®æ–‡ä»¶å¤¹è¿›è¡Œåˆ†æ</p>
                            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                ğŸ“ é€‰æ‹©AMRFinderæ–‡ä»¶å¤¹
                            </button>
                            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                ğŸ” æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©
                            </button>
                            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                ğŸ“‚ å¼ºåˆ¶åŠ è½½æ‰€æœ‰æ–‡ä»¶
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">é€‰æ‹©åŒ…å«528ä¸ªTSVæ–‡ä»¶çš„amrfinder_delæ–‡ä»¶å¤¹</p>
                        `;
                        // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
                        setTimeout(() => {
                            const loadButton = document.getElementById('loadRealData');
                            const testButton = document.getElementById('testFolderSelection');
                            const allButton = document.getElementById('loadAllFiles');
                            
                            if (loadButton) {
                                loadButton.addEventListener('click', arguments.callee);
                            }
                            
                            if (testButton) {
                                testButton.addEventListener('click', async () => {
                                    try {
                                        document.getElementById('loading').innerHTML = '<p>æ­£åœ¨æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½...</p>';
                                        await testFolderSelection();
                                    } catch (error) {
                                        console.error('æµ‹è¯•å¤±è´¥:', error);
                                        document.getElementById('error').style.display = 'block';
                                        document.getElementById('error').textContent = 'æµ‹è¯•å¤±è´¥: ' + error.message;
                                    }
                                });
                            }
                            
                            if (allButton) {
                                allButton.addEventListener('click', arguments.callee);
                            }
                        }, 100);
                    }
                });
                
                // è®¾ç½®æŒ‰é’®äº‹ä»¶
                document.getElementById('loadRealData').addEventListener('click', async () => {
                    try {
                        document.getElementById('loading').innerHTML = '<p>æ­£åœ¨è¯»å–TSVæ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>';
                        const realData = await loadRealData();
                        if (realData.length > 0) {
                            allData = realData;
                            showAnalysis(allData);
                        } else {
                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„TSVæ•°æ®ï¼Œè¯·ç¡®ä¿é€‰æ‹©äº†åŒ…å«TSVæ–‡ä»¶çš„æ–‡ä»¶å¤¹');
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message + 'ã€‚è¯·é‡æ–°é€‰æ‹©æ­£ç¡®çš„æ–‡ä»¶å¤¹ã€‚';
                        // é‡ç½®åŠ è½½ç•Œé¢
                        document.getElementById('loading').innerHTML = `
                            <p>è¯·é€‰æ‹©æ‚¨çš„AMRFinderæ•°æ®æ–‡ä»¶å¤¹è¿›è¡Œåˆ†æ</p>
                            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                ğŸ“ é€‰æ‹©AMRFinderæ–‡ä»¶å¤¹
                            </button>
                            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                ğŸ” æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©
                            </button>
                            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                ğŸ“‚ å¼ºåˆ¶åŠ è½½æ‰€æœ‰æ–‡ä»¶
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">é€‰æ‹©åŒ…å«528ä¸ªTSVæ–‡ä»¶çš„amrfinder_delæ–‡ä»¶å¤¹</p>
                        `;
                        // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
                        setTimeout(() => {
                            const loadButton = document.getElementById('loadRealData');
                            const testButton = document.getElementById('testFolderSelection');
                            const allButton = document.getElementById('loadAllFiles');
                            
                            if (loadButton) {
                                loadButton.addEventListener('click', arguments.callee);
                            }
                            
                            if (testButton) {
                                testButton.addEventListener('click', async () => {
                                    try {
                                        document.getElementById('loading').innerHTML = '<p>æ­£åœ¨æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½...</p>';
                                        await testFolderSelection();
                                    } catch (error) {
                                        console.error('æµ‹è¯•å¤±è´¥:', error);
                                        document.getElementById('error').style.display = 'block';
                                        document.getElementById('error').textContent = 'æµ‹è¯•å¤±è´¥: ' + error.message;
                                    }
                                });
                            }
                            
                            if (allButton) {
                                allButton.addEventListener('click', async () => {
                                    try {
                                        document.getElementById('loading').innerHTML = '<p>æ­£åœ¨å¼ºåˆ¶è¯»å–æ‰€æœ‰æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>';
                                        const realData = await loadAllFiles();
                                        if (realData.length > 0) {
                                            allData = realData;
                                            processData();
                                            document.getElementById('loading').style.display = 'none';
                                            document.getElementById('dashboard').style.display = 'block';
                                        } else {
                                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
                                        }
                                    } catch (error) {
                                        console.error('åŠ è½½å¤±è´¥:', error);
                                        document.getElementById('error').style.display = 'block';
                                        document.getElementById('error').textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
                                    }
                                });
                            }
                        }, 100);
                    }
                });
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
            }
        }

        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function exportData(format) {
            if (!allData || allData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportCSV(timestamp);
                    break;
                case 'excel':
                    alert('Excelå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·ä½¿ç”¨CSVæ ¼å¼');
                    break;
                case 'json':
                    exportJSON(timestamp);
                    break;
            }
        }
        
        // å¯¼å‡ºCSVæ ¼å¼
        function exportCSV(timestamp) {
            let csvContent = 'Date,Month,Strain,Gene,Antibiotic\n';
            
            allData.forEach(record => {
                csvContent += `${record.date},${record.month},${record.strain},${record.gene},${record.antibiotic}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `amr_trend_analysis_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // å¯¼å‡ºJSONæ ¼å¼
        function exportJSON(timestamp) {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalSamples: new Set(allData.map(d => d.fileName)).size,
                    totalGenes: new Set(allData.map(d => d.gene)).size,
                    totalAntibiotics: new Set(allData.map(d => d.antibiotic)).size,
                    timeSpan: Object.keys(monthlyData).length
                },
                rawData: allData,
                monthlyStatistics: monthlyData
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `amr_analysis_complete_${timestamp}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ç”ŸæˆæŠ¥å‘Š
        function generateReport(type) {
            if (!allData || allData.length === 0) {
                alert('æ²¡æœ‰å¯åˆ†æçš„æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œåˆ†æ');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            
            switch(type) {
                case 'summary':
                    generateSummaryReport(timestamp);
                    break;
                case 'detailed':
                    generateDetailedReport(timestamp);
                    break;
                case 'medical':
                    generateMedicalReport(timestamp);
                    break;
            }
        }
        
        // ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        function generateSummaryReport(timestamp) {
            const totalSamples = new Set(allData.map(d => d.fileName)).size;
            const totalGenes = new Set(allData.map(d => d.gene)).size;
            const totalAntibiotics = new Set(allData.map(d => d.antibiotic)).size;
            const timeSpan = Object.keys(monthlyData).length;
            
            // è·å–æœ€å¸¸è§çš„åŸºå› å’ŒæŠ—ç”Ÿç´ 
            const geneFreq = {};
            const antibioticFreq = {};
            
            allData.forEach(record => {
                geneFreq[record.gene] = (geneFreq[record.gene] || 0) + 1;
                antibioticFreq[record.antibiotic] = (antibioticFreq[record.antibiotic] || 0) + 1;
            });
            
            const topGenes = Object.entries(geneFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topAntibiotics = Object.entries(antibioticFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const report = `
è€è¯åŸºå› æµè¡Œè¶‹åŠ¿åˆ†ææ‘˜è¦æŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
åˆ†ææ—¶é—´æ®µ: ${timeSpan}ä¸ªæœˆ

=== åŸºæœ¬ç»Ÿè®¡ ===
â€¢ æ€»æ ·æœ¬æ•°: ${totalSamples}
â€¢ è€è¯åŸºå› ç§ç±»: ${totalGenes}
â€¢ æŠ—ç”Ÿç´ ç±»å‹: ${totalAntibiotics}
â€¢ ç›‘æµ‹æ—¶é•¿: ${timeSpan}ä¸ªæœˆ

=== ä¸»è¦å‘ç° ===
â€¢ æœ€å¸¸è§çš„è€è¯åŸºå› :
${topGenes.map(([gene, count]) => `  - ${gene}: ${count}æ¬¡æ£€å‡º`).join('\n')}

â€¢ æœ€å¸¸è§çš„æŠ—ç”Ÿç´ è€è¯:
${topAntibiotics.map(([antibiotic, count]) => `  - ${antibiotic}: ${count}æ¬¡æ£€å‡º`).join('\n')}

=== å»ºè®® ===
â€¢ é‡ç‚¹ç›‘æ§é«˜é¢‘è€è¯åŸºå› 
â€¢ è°¨æ…ä½¿ç”¨é«˜è€è¯ç‡æŠ—ç”Ÿç´ 
â€¢ æŒç»­ç›‘æµ‹è€è¯è¶‹åŠ¿å˜åŒ–

æŠ¥å‘Šç”Ÿæˆ: è€è¯åŸºå› åˆ†æå¹³å°
`;
            
            downloadTextFile(report, `amr_summary_report_${timestamp}.txt`);
        }
        
        // ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        function generateDetailedReport(timestamp) {
            const report = `
è€è¯åŸºå› æµè¡Œè¶‹åŠ¿è¯¦ç»†åˆ†ææŠ¥å‘Š
=================================

ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
æ•°æ®æ¥æº: AMRFinderåˆ†æç»“æœ
åˆ†ææ ·æœ¬: ${new Set(allData.map(d => d.fileName)).size}ä¸ª

1. æ•°æ®æ¦‚è§ˆ
-----------
æ€»åŸºå› è®°å½•æ•°: ${allData.length}
ç‹¬ç‰¹åŸºå› ç§ç±»: ${new Set(allData.map(d => d.gene)).size}
æŠ—ç”Ÿç´ ç±»åˆ«: ${new Set(allData.map(d => d.antibiotic)).size}
ç›‘æµ‹æ—¶é—´è·¨åº¦: ${Object.keys(monthlyData).length}ä¸ªæœˆ

2. æœˆåº¦ç»Ÿè®¡è¯¦æƒ…
--------------
${Object.entries(monthlyData).map(([month, data]) => 
    `${month}: ${data.totalSamples}ä¸ªæ ·æœ¬, ${Object.keys(data.genes).length}ç§åŸºå› `
).join('\n')}

3. åŸºå› åˆ†å¸ƒåˆ†æ
--------------
${Object.entries(
    allData.reduce((acc, record) => {
        acc[record.gene] = (acc[record.gene] || 0) + 1;
        return acc;
    }, {})
).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([gene, count]) => 
    `${gene}: ${count}æ¬¡ (${((count/allData.length)*100).toFixed(1)}%)`
).join('\n')}

4. æŠ—ç”Ÿç´ è€è¯åˆ†æ
---------------
${Object.entries(
    allData.reduce((acc, record) => {
        acc[record.antibiotic] = (acc[record.antibiotic] || 0) + 1;
        return acc;
    }, {})
).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([antibiotic, count]) => 
    `${antibiotic}: ${count}æ¬¡ (${((count/allData.length)*100).toFixed(1)}%)`
).join('\n')}

æŠ¥å‘Šç”Ÿæˆ: è€è¯åŸºå› åˆ†æå¹³å°
ç‰ˆæœ¬: 2.0.0
`;
            
            downloadTextFile(report, `amr_detailed_report_${timestamp}.txt`);
        }
        
        // ç”ŸæˆåŒ»ç–—å»ºè®®æŠ¥å‘Š
        function generateMedicalReport(timestamp) {
            // åˆ†æé«˜é£é™©æŠ—ç”Ÿç´ 
            const antibioticFreq = {};
            allData.forEach(record => {
                antibioticFreq[record.antibiotic] = (antibioticFreq[record.antibiotic] || 0) + 1;
            });
            
            const highRiskAntibiotics = Object.entries(antibioticFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const report = `
è€è¯åŸºå› åˆ†æåŒ»ç–—å»ºè®®æŠ¥å‘Š
====================

ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
åŸºäºæ•°æ®: ${allData.length}æ¡åŸºå› è®°å½•åˆ†æ

ğŸš¨ é«˜é£é™©æŠ—ç”Ÿç´ ä½¿ç”¨å»ºè®®
---------------------
ä»¥ä¸‹æŠ—ç”Ÿç´ ç±»åˆ«æ£€å‡ºé«˜è€è¯ç‡ï¼Œå»ºè®®è°¨æ…ä½¿ç”¨ï¼š

${highRiskAntibiotics.map(([antibiotic, count], index) => {
    const percentage = ((count/allData.length)*100).toFixed(1);
    let riskLevel = 'ä¸­ç­‰é£é™©';
    if (percentage > 15) riskLevel = 'é«˜é£é™©';
    else if (percentage < 5) riskLevel = 'ä½é£é™©';
    
    return `${index + 1}. ${antibiotic}
   æ£€å‡ºç‡: ${percentage}%
   é£é™©ç­‰çº§: ${riskLevel}
   å»ºè®®: ${percentage > 15 ? 'é¿å…é¦–é€‰ä½¿ç”¨ï¼Œéœ€è¦è¯æ•è¯•éªŒæŒ‡å¯¼' : 
          percentage > 5 ? 'è°¨æ…ä½¿ç”¨ï¼Œå»ºè®®è¯æ•è¯•éªŒ' : 'å¯è€ƒè™‘ä½¿ç”¨'}`;
}).join('\n\n')}

ğŸ’Š ä¸´åºŠç”¨è¯å»ºè®®
--------------
1. ç»éªŒæ€§æ²»ç–—åº”é¿å…ä½¿ç”¨é«˜è€è¯ç‡æŠ—ç”Ÿç´ 
2. é‡ç—‡æ„ŸæŸ“å»ºè®®è”åˆç”¨è¯
3. å®šæœŸç›‘æµ‹æœ¬åœ°è€è¯æµè¡Œæƒ…å†µ
4. åŠ å¼ºæŠ—ç”Ÿç´ ç®¡ç†å’Œæ„Ÿæ§æªæ–½

ğŸ“Š ç›‘æµ‹å»ºè®®
----------
1. æŒç»­ç›‘æµ‹è€è¯è¶‹åŠ¿å˜åŒ–
2. é‡ç‚¹å…³æ³¨æ–°å‘è€è¯åŸºå› 
3. å»ºç«‹æœ¬åœ°è€è¯æ•°æ®åº“
4. å®šæœŸæ›´æ–°æ²»ç–—æŒ‡å—

âš ï¸ å…è´£å£°æ˜
----------
æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œå…·ä½“ç”¨è¯è¯·éµå¾ªä¸´åºŠåŒ»å¸ˆæŒ‡å¯¼å’Œè¯æ•è¯•éªŒç»“æœã€‚

æŠ¥å‘Šç”Ÿæˆ: è€è¯åŸºå› åˆ†æå¹³å°
æŠ€æœ¯æ”¯æŒ: AMRFinderæ•°æ®åº“
`;
            
            downloadTextFile(report, `amr_medical_advice_${timestamp}.txt`);
        }
        
        // ä¸‹è½½æ–‡æœ¬æ–‡ä»¶
        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // å¼ºåˆ¶åŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆå¿½ç•¥æ‰©å±•åæ£€æŸ¥ï¼‰
        async function loadAllFiles() {
            const data = [];
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;

            return new Promise((resolve, reject) => {
                fileInput.addEventListener('change', async (event) => {
                    const allFiles = Array.from(event.target.files);
                    console.log(`å¼ºåˆ¶åŠ è½½æ¨¡å¼: æ‰¾åˆ° ${allFiles.length} ä¸ªæ–‡ä»¶`);
                    
                    // å°è¯•å¤„ç†æ‰€æœ‰æ–‡ä»¶ï¼Œä¸ç®¡æ‰©å±•å
                    let processedFiles = 0;
                    let validFiles = 0;
                    let filteredGenesCount = 0;
                    const totalFiles = allFiles.length;

                    for (const file of allFiles) {
                        try {
                            // åªå¤„ç†çœ‹èµ·æ¥åƒTSVæ–‡ä»¶çš„æ–‡ä»¶ï¼ˆåŒ…å«æ—¥æœŸæ ¼å¼çš„æ–‡ä»¶åï¼‰
                            const fileInfo = parseFileName(file.name);
                            if (!fileInfo && !file.name.match(/\d{4}-\d{2}-\d{2}/)) {
                                processedFiles++;
                                continue;
                            }

                            const text = await file.text();
                            const lines = text.split('\n');
                            
                            // æ£€æŸ¥æ˜¯å¦åƒTSVæ–‡ä»¶ï¼ˆæœ‰åˆ¶è¡¨ç¬¦åˆ†éš”çš„åˆ—ï¼‰
                            let hasTabSeparatedData = false;
                            for (let i = 0; i < Math.min(5, lines.length); i++) {
                                if (lines[i].includes('\t') && lines[i].split('\t').length > 5) {
                                    hasTabSeparatedData = true;
                                    break;
                                }
                            }
                            
                            if (!hasTabSeparatedData) {
                                processedFiles++;
                                continue;
                            }
                            
                            // ç”¨äºå½“å‰æ–‡ä»¶çš„å»é‡
                            const fileGenes = new Set();
                            const fileAntibiotics = new Set();
                            const fileCombinations = new Set();
                            
                            // è·³è¿‡æ ‡é¢˜è¡Œ
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const columns = line.split('\t');
                                if (columns.length >= 12) {
                                    const geneSymbol = columns[5]; // Gene symbolåˆ—
                                    const subclass = columns[11];  // Subclassåˆ—
                                    
                                    if (geneSymbol && subclass && geneSymbol !== 'NA' && subclass !== 'NA') {
                                        // è®°å½•æ‰€æœ‰åŸºå› ï¼ŒåŒ…æ‹¬oqxå’ŒfosAï¼ˆç”¨äºå®Œæ•´åˆ†æï¼‰
                                        if (geneSymbol.toLowerCase().includes('oqx') || 
                                            geneSymbol.toLowerCase().includes('fosa')) {
                                            filteredGenesCount++;
                                        }
                                        
                                        // æ·»åŠ åˆ°å½“å‰æ–‡ä»¶çš„é›†åˆä¸­ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
                                        fileGenes.add(geneSymbol);
                                        fileAntibiotics.add(subclass);
                                        fileCombinations.add(`${geneSymbol}|||${subclass}`);
                                    }
                                }
                            }
                            
                            // å°†å»é‡åçš„æ•°æ®æ·»åŠ åˆ°æ€»æ•°æ®ä¸­
                            let genesFoundInFile = 0;
                            const fileInfoToUse = fileInfo || {
                                date: file.name.match(/(\d{4}-\d{2}-\d{2})/)?.[1] || '2023-01-01',
                                strain: file.name.replace(/\.\w+$/, '').replace(/^\d{4}-\d{2}-\d{2}-?/, '') || 'unknown',
                                month: (file.name.match(/(\d{4}-\d{2})/)?.[1] || '2023-01') // YYYY-MMæ ¼å¼
                            };
                            
                            fileCombinations.forEach(combination => {
                                const [geneSymbol, subclass] = combination.split('|||');
                                data.push({
                                    fileName: file.name,
                                    date: fileInfoToUse.date,
                                    month: fileInfoToUse.month,
                                    strain: fileInfoToUse.strain,
                                    geneSymbol: geneSymbol,
                                    subclass: subclass
                                });
                                genesFoundInFile++;
                            });
                            
                            if (genesFoundInFile > 0) {
                                validFiles++;
                            }
                            
                            processedFiles++;
                            // æ›´æ–°è¿›åº¦
                            const progress = Math.round((processedFiles / totalFiles) * 100);
                            document.getElementById('loading').innerHTML = `
                                <p>æ­£åœ¨å¼ºåˆ¶å¤„ç†æ–‡ä»¶: ${processedFiles}/${totalFiles} (${progress}%)</p>
                                <p>å·²æ‰¾åˆ° ${validFiles} ä¸ªæœ‰æ•ˆæ–‡ä»¶ï¼Œå…± ${data.length} æ¡åŸºå› è®°å½•</p>
                                <p>åŒ…å« ${filteredGenesCount} æ¡oqx/fosAåŸºå› è®°å½•</p>
                            `;
                            
                        } catch (error) {
                            console.warn(`å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™:`, error);
                            processedFiles++;
                        }
                    }

                    console.log(`å¼ºåˆ¶åŠ è½½å®Œæˆ: ${validFiles} ä¸ªæœ‰æ•ˆæ–‡ä»¶ï¼Œå…± ${data.length} æ¡åŸºå› è®°å½•ï¼ŒåŒ…å« ${filteredGenesCount} æ¡oqx/fosAåŸºå› è®°å½•`);
                    
                    if (data.length === 0) {
                        reject(new Error(`å¤„ç†äº† ${processedFiles} ä¸ªæ–‡ä»¶ï¼Œä½†æœªæ‰¾åˆ°æœ‰æ•ˆçš„åŸºå› æ•°æ®ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`));
                    } else {
                        resolve(data);
                    }
                });

                fileInput.click();
            });
        }
        
        // æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½
        async function testFolderSelection() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;

            return new Promise((resolve, reject) => {
                fileInput.addEventListener('change', async (event) => {
                    try {
                        const allFiles = Array.from(event.target.files);
                        
                        // è¯¦ç»†çš„æ‰©å±•ååˆ†æ
                        const extensionMap = {};
                        allFiles.forEach(file => {
                            const name = file.name.toLowerCase();
                            const parts = name.split('.');
                            const ext = parts.length > 1 ? '.' + parts[parts.length - 1] : 'æ— æ‰©å±•å';
                            extensionMap[ext] = (extensionMap[ext] || 0) + 1;
                        });
                        
                        // ä½¿ç”¨åŒæ ·çš„TSVæ£€æµ‹é€»è¾‘
                        const tsvFiles = allFiles.filter(file => {
                            const name = file.name.toLowerCase();
                            return name.endsWith('.tsv') || 
                                   name.endsWith('.TSV') || 
                                   name.includes('.tsv') ||
                                   (name.includes('tsv') && name.includes('-'));
                        });
                        
                        console.log('æµ‹è¯•ç»“æœ:');
                        console.log('- æ€»æ–‡ä»¶æ•°:', allFiles.length);
                        console.log('- TSVæ–‡ä»¶æ•°:', tsvFiles.length);
                        console.log('- å‰10ä¸ªæ–‡ä»¶:', allFiles.slice(0, 10).map(f => f.name));
                        console.log('- å‰10ä¸ªTSVæ–‡ä»¶:', tsvFiles.slice(0, 10).map(f => f.name));
                        
                        let message = `æµ‹è¯•å®Œæˆï¼\n\n`;
                        message += `ğŸ“ æ€»æ–‡ä»¶æ•°: ${allFiles.length}\n`;
                        message += `ğŸ“„ TSVæ–‡ä»¶æ•°: ${tsvFiles.length}\n\n`;
                        message += `ğŸ“Š æ–‡ä»¶æ‰©å±•åç»Ÿè®¡:\n`;
                        Object.entries(extensionMap).forEach(([ext, count]) => {
                            message += `  ${ext}: ${count}ä¸ª\n`;
                        });
                        message += `\n`;
                        
                        if (tsvFiles.length > 0) {
                            message += `âœ… æ–‡ä»¶å¤¹é€‰æ‹©åŠŸèƒ½æ­£å¸¸ï¼\n`;
                            message += `å‰å‡ ä¸ªTSVæ–‡ä»¶:\n`;
                            message += tsvFiles.slice(0, 5).map(f => `â€¢ ${f.name}`).join('\n');
                            
                            if (tsvFiles.length > 5) {
                                message += `\n... è¿˜æœ‰ ${tsvFiles.length - 5} ä¸ªæ–‡ä»¶`;
                            }
                        } else {
                            message += `âŒ æœªæ‰¾åˆ°TSVæ–‡ä»¶\n`;
                            message += `è¯·ç¡®ä¿é€‰æ‹©äº†æ­£ç¡®çš„æ–‡ä»¶å¤¹ã€‚\n\n`;
                            message += `æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ç±»å‹:\n`;
                            const extensions = [...new Set(allFiles.map(f => {
                                const ext = f.name.split('.').pop();
                                return ext ? `.${ext}` : 'æ— æ‰©å±•å';
                            }))];
                            message += extensions.slice(0, 10).join(', ');
                        }
                        
                        alert(message);
                        
                        // é‡ç½®åŠ è½½ç•Œé¢
                        document.getElementById('loading').innerHTML = `
                            <p>è¯·é€‰æ‹©æ‚¨çš„AMRFinderæ•°æ®æ–‡ä»¶å¤¹è¿›è¡Œåˆ†æ</p>
                            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                ğŸ“ é€‰æ‹©AMRFinderæ–‡ä»¶å¤¹
                            </button>
                            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                ğŸ” æµ‹è¯•æ–‡ä»¶å¤¹é€‰æ‹©
                            </button>
                            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                ğŸ“‚ å¼ºåˆ¶åŠ è½½æ‰€æœ‰æ–‡ä»¶
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">é€‰æ‹©åŒ…å«528ä¸ªTSVæ–‡ä»¶çš„amrfinder_delæ–‡ä»¶å¤¹</p>
                        `;
                        
                        resolve(tsvFiles.length);
                        
                    } catch (error) {
                        reject(error);
                    }
                });

                fileInput.click();
            });
        }
        
        // åˆ‡æ¢å¯¼å‡ºé¢æ¿æ˜¾ç¤º
        function toggleExportSection() {
            const exportSection = document.getElementById('exportSection');
            if (exportSection.style.display === 'none') {
                exportSection.style.display = 'block';
                exportSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                exportSection.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
