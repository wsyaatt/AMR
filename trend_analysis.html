<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流行趋势分析 - 耐药基因分析平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .back-button {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) translateX(-5px);
        }

        @media (max-width: 768px) {
            .back-button {
                position: static;
                transform: none;
                display: inline-block;
                margin-bottom: 20px;
            }
            
            .back-button:hover {
                transform: none;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 500;
            color: #555;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #333;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">← 返回主页</a>
            <h1>📊 流行趋势分析</h1>
            <p>基于AMRFinder数据的抗生素耐药基因和表型月度流行趋势分析</p>
        </div>

        <div id="loading" class="loading">
            <p>请选择您的AMRFinder数据文件夹进行分析</p>
            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                📁 选择AMRFinder文件夹
            </button>
            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                🔍 测试文件夹选择
            </button>
            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                📂 强制加载所有文件
            </button>
            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">选择包含528个TSV文件的amrfinder_del文件夹</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSamples">0</div>
                    <div class="stat-label">总样本数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalGenes">0</div>
                    <div class="stat-label">耐药基因种类</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalAntibiotics">0</div>
                    <div class="stat-label">抗生素类型</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="timeSpan">0</div>
                    <div class="stat-label">监测月数</div>
                </div>
            </div>

            <div class="chart-grid">
                <!-- 月度详情查看器 -->
                <div class="chart-container">
                    <h3 class="chart-title">📅 月度流行情况详情</h3>
                                <div class="controls">
                <div class="control-group">
                    <label>选择月份:</label>
                    <select id="monthSelector" style="min-width: 150px;">
                        <option value="">请选择月份</option>
                    </select>
                </div>
                <div class="control-group">
                    <button onclick="toggleExportSection()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px;">
                        📋 数据导出
                    </button>
                </div>
            </div>
                    <div id="monthlyDetails" style="display: none;">
                        <div class="two-column" style="margin-top: 20px;">
                            <div class="alert-card" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #856404; margin: 0 0 10px 0;">⚠️ 高流行耐药基因</h4>
                                <div id="highRiskGenes"></div>
                            </div>
                            <div class="alert-card" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #721c24; margin: 0 0 10px 0;">🚫 避免使用的抗生素</h4>
                                <div id="avoidAntibiotics"></div>
                            </div>
                        </div>
                        <div class="two-column" style="margin-top: 20px;">
                            <div class="chart-wrapper" style="height: 300px;">
                                <canvas id="monthlyGeneChart"></canvas>
                            </div>
                            <div class="chart-wrapper" style="height: 300px;">
                                <canvas id="monthlyAntibioticChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">月度耐药基因流行趋势</h3>
                    <div class="controls">
                        <div class="control-group">
                            <label>选择基因:</label>
                            <select id="geneFilter" multiple style="min-width: 200px;">
                                <option value="all">显示所有基因</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>显示前:</label>
                            <select id="topGenesCount">
                                <option value="10">10个</option>
                                <option value="20" selected>20个</option>
                                <option value="50">50个</option>
                                <option value="all">全部</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="geneChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">月度抗生素耐药表型流行趋势</h3>
                    <div class="controls">
                        <div class="control-group">
                            <label>选择抗生素:</label>
                            <select id="antibioticFilter" multiple style="min-width: 200px;">
                                <option value="all">显示所有抗生素</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>显示前:</label>
                            <select id="topAntibioticsCount">
                                <option value="10" selected>10个</option>
                                <option value="20">20个</option>
                                <option value="all">全部</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="antibioticChart"></canvas>
                    </div>
                </div>

                <div class="two-column">
                    <div class="chart-container">
                        <h3 class="chart-title">基因-抗生素关联热力图</h3>
                        <div class="chart-wrapper">
                            <canvas id="heatmapChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">月度样本数量统计</h3>
                        <div class="chart-wrapper">
                            <canvas id="sampleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据导出和报告生成 -->
        <div id="exportSection" class="chart-container" style="display: none;">
            <h3 class="chart-title">📋 数据导出与报告生成</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px;">📊 数据导出</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="exportData('csv')" style="padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            📄 导出CSV数据
                        </button>
                        <button onclick="exportData('excel')" style="padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            📊 导出Excel报表
                        </button>
                        <button onclick="exportData('json')" style="padding: 10px; background: #6f42c1; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            📋 导出JSON数据
                        </button>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px;">📑 报告生成</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="generateReport('summary')" style="padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            📝 生成分析摘要
                        </button>
                        <button onclick="generateReport('detailed')" style="padding: 10px; background: #fd7e14; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            📊 生成详细报告
                        </button>
                        <button onclick="generateReport('medical')" style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            🏥 生成医疗建议
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="toggleExportSection()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 20px; cursor: pointer;">
                    隐藏导出面板
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let allData = [];
        let monthlyData = {};
        let geneChart, antibioticChart, heatmapChart, sampleChart;

        // 颜色生成器
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137.508) % 360;
                colors.push(`hsla(${hue}, 70%, 60%, 0.8)`);
            }
            return colors;
        }

        // 解析文件名获取日期和菌株信息
        function parseFileName(fileName) {
            const match = fileName.match(/^(\d{4}-\d{2}-\d{2})-(.+)\.tsv$/);
            if (match) {
                return {
                    date: match[1],
                    strain: match[2],
                    month: match[1].substring(0, 7) // YYYY-MM格式
                };
            }
            return null;
        }

        // 读取真实的TSV文件数据
        async function loadRealData() {
            const data = [];
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;

            return new Promise((resolve, reject) => {
                fileInput.addEventListener('change', async (event) => {
                    console.log('文件选择事件触发，总文件数:', event.target.files.length);
                    
                    // 列出所有文件进行调试
                    const allFiles = Array.from(event.target.files);
                    console.log('所有文件列表:', allFiles.map(f => f.name).slice(0, 10));
                    
                    // 更详细的文件扩展名检查
                    console.log('文件扩展名分析:');
                    const extensionMap = {};
                    allFiles.forEach(file => {
                        const name = file.name.toLowerCase();
                        const parts = name.split('.');
                        const ext = parts.length > 1 ? '.' + parts[parts.length - 1] : '无扩展名';
                        extensionMap[ext] = (extensionMap[ext] || 0) + 1;
                    });
                    console.log('扩展名统计:', extensionMap);
                    
                    // 支持多种TSV格式检查
                    const files = allFiles.filter(file => {
                        const name = file.name.toLowerCase();
                        return name.endsWith('.tsv') || 
                               name.endsWith('.TSV') || 
                               name.includes('.tsv') ||
                               (name.includes('tsv') && name.includes('-'));
                    });
                    console.log('TSV文件数:', files.length);
                    console.log('TSV文件示例:', files.slice(0, 5).map(f => f.name));
                    
                    if (files.length === 0) {
                        console.error('未找到TSV文件，所有文件:', allFiles.map(f => f.name).slice(0, 20));
                        reject(new Error(`未找到TSV文件。共选择了 ${allFiles.length} 个文件，但没有.tsv扩展名的文件。请确保选择了包含TSV文件的正确文件夹。`));
                        return;
                    }

                    console.log(`找到 ${files.length} 个TSV文件`);
                    let processedFiles = 0;
                    let validFiles = 0;
                    let filteredGenesCount = 0; // 统计被过滤的基因数量（oqx和fosA）
                    const totalFiles = files.length;

                    for (const file of files) {
                        try {
                            const fileInfo = parseFileName(file.name);
                            if (!fileInfo) {
                                console.warn(`跳过文件名格式不正确的文件: ${file.name}`);
                                processedFiles++;
                                continue;
                            }

                            const text = await file.text();
                            const lines = text.split('\n');
                            
                            // 用于当前文件的去重
                            const fileGenes = new Set();
                            const fileAntibiotics = new Set();
                            const fileCombinations = new Set();
                            
                            // 跳过标题行
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const columns = line.split('\t');
                                if (columns.length >= 12) {
                                    const geneSymbol = columns[5]; // Gene symbol列
                                    const subclass = columns[11];  // Subclass列
                                    
                                    if (geneSymbol && subclass && geneSymbol !== 'NA' && subclass !== 'NA') {
                                        // 记录所有基因，包括oqx和fosA（用于完整分析）
                                        // 但可以标记这些基因用于特殊处理
                                        if (geneSymbol.toLowerCase().includes('oqx') || 
                                            geneSymbol.toLowerCase().includes('fosa')) {
                                            filteredGenesCount++;
                                            // 不再跳过这些基因，而是包含在分析中
                                        }
                                        
                                        // 添加到当前文件的集合中（自动去重）
                                        fileGenes.add(geneSymbol);
                                        fileAntibiotics.add(subclass);
                                        fileCombinations.add(`${geneSymbol}|||${subclass}`);
                                    }
                                }
                            }
                            
                            // 将去重后的数据添加到总数据中
                            let genesFoundInFile = 0;
                            fileCombinations.forEach(combination => {
                                // 使用安全的分隔符分割
                                const [gene, antibiotic] = combination.split('|||');
                                
                                data.push({
                                    fileName: file.name,
                                    date: fileInfo.date,
                                    month: fileInfo.month,
                                    strain: fileInfo.strain,
                                    gene: gene,
                                    antibiotic: antibiotic
                                });
                                genesFoundInFile++;
                            });
                            
                            if (genesFoundInFile > 0) {
                                validFiles++;
                            }
                            
                            processedFiles++;
                            // 更新进度
                            const progress = Math.round((processedFiles / totalFiles) * 100);
                            document.getElementById('loading').innerHTML = `
                                <p>正在处理文件: ${processedFiles}/${totalFiles} (${progress}%)</p>
                                <p>已找到 ${validFiles} 个有效文件，共 ${data.length} 条基因记录</p>
                                <p>包含 ${filteredGenesCount} 条oqx/fosA基因记录</p>
                            `;
                            
                        } catch (error) {
                            console.warn(`处理文件 ${file.name} 时出错:`, error);
                            processedFiles++;
                        }
                    }

                    console.log(`处理完成: ${validFiles} 个有效文件，共 ${data.length} 条基因记录，包含 ${filteredGenesCount} 条oqx/fosA基因记录`);
                    
                    if (data.length === 0) {
                        reject(new Error(`处理了 ${processedFiles} 个文件，但未找到有效的基因数据。请检查TSV文件格式是否正确。`));
                    } else {
                        resolve(data);
                    }
                });

                fileInput.click();
            });
        }

        // 生成更多演示数据来模拟真实的528个文件
        function generateMoreDemoData() {
            const genePool = [
                'fosA', 'oqxA', 'oqxB', 'oqxB25', 'blaSHV-11', 'blaTEM-1', 'blaCTX-M-14', 
                'blaKPC-2', 'tet(A)', 'tet(C)', 'tet(D)', 'catA1', 'sul1', 'sul2', 
                'aph(6)-Id', 'aph(3\')-Ia', 'aac(6\')-Ib3', 'aac(3)-IId', 'qnrB52', 
                'mph(A)', 'dfrA5', 'dfrA12', 'aadA2', 'qacE', 'ramR_A19V', 'parC_S80I',
                'gyrA_D87A', 'gyrA_S83F', 'ompK35_E132K', 'cmlA1'
            ];
            
            const antibioticPool = [
                'FOSFOMYCIN', 'PHENICOL/QUINOLONE', 'BETA-LACTAM', 'CEPHALOSPORIN', 
                'CARBAPENEM', 'TETRACYCLINE', 'CHLORAMPHENICOL', 'SULFONAMIDE', 
                'STREPTOMYCIN', 'KANAMYCIN', 'AMIKACIN/KANAMYCIN/TOBRAMYCIN', 
                'GENTAMICIN', 'QUINOLONE', 'MACROLIDE', 'TRIMETHOPRIM', 
                'QUATERNARY AMMONIUM', 'TIGECYCLINE', 'AZITHROMYCIN/ERYTHROMYCIN/SPIRAMYCIN/TELITHROMYCIN'
            ];

            const geneAntibioticMap = {
                'fosA': 'FOSFOMYCIN',
                'oqxA': 'PHENICOL/QUINOLONE',
                'oqxB': 'PHENICOL/QUINOLONE',
                'oqxB25': 'PHENICOL/QUINOLONE',
                'blaSHV-11': 'BETA-LACTAM',
                'blaTEM-1': 'BETA-LACTAM',
                'blaCTX-M-14': 'CEPHALOSPORIN',
                'blaKPC-2': 'CARBAPENEM',
                'tet(A)': 'TETRACYCLINE',
                'tet(C)': 'TETRACYCLINE',
                'tet(D)': 'TETRACYCLINE',
                'catA1': 'CHLORAMPHENICOL',
                'sul1': 'SULFONAMIDE',
                'sul2': 'SULFONAMIDE',
                'aph(6)-Id': 'STREPTOMYCIN',
                'aph(3\')-Ia': 'KANAMYCIN',
                'aac(6\')-Ib3': 'AMIKACIN/KANAMYCIN/TOBRAMYCIN',
                'aac(3)-IId': 'GENTAMICIN',
                'qnrB52': 'QUINOLONE',
                'mph(A)': 'MACROLIDE',
                'dfrA5': 'TRIMETHOPRIM',
                'dfrA12': 'TRIMETHOPRIM',
                'aadA2': 'STREPTOMYCIN',
                'qacE': 'QUATERNARY AMMONIUM',
                'ramR_A19V': 'TIGECYCLINE',
                'parC_S80I': 'QUINOLONE',
                'gyrA_D87A': 'QUINOLONE',
                'gyrA_S83F': 'QUINOLONE',
                'ompK35_E132K': 'CARBAPENEM',
                'cmlA1': 'CHLORAMPHENICOL'
            };

            const strainPrefixes = ['E1', 'C1', 'C4', 'C5', 'C6'];
            const generatedFiles = [];
            
            // 生成总共528个样本，分布在2016-2023年期间
            const totalSamples = 528;
            const totalMonths = 8 * 12; // 2016-2023年共96个月
            let samplesGenerated = 0;
            
            // 为每个月分配样本数量，有些月份可能没有样本
            const monthlyDistribution = [];
            for (let year = 2016; year <= 2023; year++) {
                for (let month = 1; month <= 12; month++) {
                    // 随机决定这个月是否有样本（80%概率有样本）
                    if (Math.random() < 0.8 && samplesGenerated < totalSamples) {
                        // 随机分配1-12个样本给这个月
                        const maxSamples = Math.min(12, totalSamples - samplesGenerated);
                        const samplesThisMonth = Math.floor(Math.random() * maxSamples) + 1;
                        monthlyDistribution.push({
                            year: year,
                            month: month,
                            samples: samplesThisMonth
                        });
                        samplesGenerated += samplesThisMonth;
                    } else {
                        // 这个月没有样本
                        monthlyDistribution.push({
                            year: year,
                            month: month,
                            samples: 0
                        });
                    }
                }
            }
            
            // 如果还没达到528个样本，随机给一些月份增加样本
            while (samplesGenerated < totalSamples) {
                const randomMonth = monthlyDistribution[Math.floor(Math.random() * monthlyDistribution.length)];
                if (randomMonth.samples > 0 && randomMonth.samples < 15) {
                    randomMonth.samples++;
                    samplesGenerated++;
                }
            }
            
            // 根据分配生成样本文件
            monthlyDistribution.forEach(monthData => {
                for (let sample = 0; sample < monthData.samples; sample++) {
                    const day = Math.floor(Math.random() * 28) + 1;
                    const strainPrefix = strainPrefixes[Math.floor(Math.random() * strainPrefixes.length)];
                    const strainNumber = Math.floor(Math.random() * 200) + 1;
                    
                    const fileName = `${monthData.year}-${monthData.month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}-${strainPrefix}-${strainNumber}.tsv`;
                    
                    // 每个样本随机包含3-8个基因
                    const numGenes = Math.floor(Math.random() * 6) + 3;
                    const selectedGenes = [];
                    const usedGenes = new Set();
                    
                    for (let g = 0; g < numGenes; g++) {
                        let gene;
                        do {
                            gene = genePool[Math.floor(Math.random() * genePool.length)];
                        } while (usedGenes.has(gene));
                        
                        usedGenes.add(gene);
                        selectedGenes.push({
                            gene: gene,
                            antibiotic: geneAntibioticMap[gene]
                        });
                    }
                    
                    generatedFiles.push({
                        name: fileName,
                        genes: selectedGenes
                    });
                }
            });
            
            return generatedFiles;
        }

        // 使用内置数据作为演示（如果用户没有选择文件夹）
        async function loadDemoData() {
            // 生成大量演示数据来模拟真实的528个文件
            const demoFiles = generateMoreDemoData();
            console.log(`生成了 ${demoFiles.length} 个演示文件`);
            
            const data = [];
            demoFiles.forEach(fileData => {
                const fileInfo = parseFileName(fileData.name);
                if (fileInfo) {
                    fileData.genes.forEach(geneInfo => {
                        data.push({
                            fileName: fileData.name,
                            date: fileInfo.date,
                            month: fileInfo.month,
                            strain: fileInfo.strain,
                            gene: geneInfo.gene,
                            antibiotic: geneInfo.antibiotic
                        });
                    });
                }
            });

            return data;
        }

        // 主数据加载函数
        async function loadData() {
            // 首先尝试使用演示数据
            try {
                return await loadDemoData();
            } catch (error) {
                console.error('加载演示数据失败:', error);
                throw error;
            }
        }

        // 处理月度数据
        function processMonthlyData(data) {
            const monthly = {};
            
            // 获取所有月份范围
            const allMonths = [...new Set(data.map(d => d.month))].sort();
            const startMonth = allMonths[0];
            const endMonth = allMonths[allMonths.length - 1];
            
            // 生成完整的月份列表
            const completeMonths = [];
            let current = new Date(startMonth + '-01');
            const end = new Date(endMonth + '-01');
            
            while (current <= end) {
                const monthStr = current.toISOString().substring(0, 7);
                completeMonths.push(monthStr);
                current.setMonth(current.getMonth() + 1);
            }
            
            // 初始化所有月份
            completeMonths.forEach(month => {
                monthly[month] = {
                    samples: new Set(),
                    genesPerSample: {}, // 记录每个样本的基因
                    antibioticsPerSample: {}, // 记录每个样本的抗生素
                    genes: {},
                    antibiotics: {},
                    totalSamples: 0
                };
            });
            
            // 填充数据 - 按样本去重统计
            data.forEach(record => {
                const month = record.month;
                if (monthly[month]) {
                    monthly[month].samples.add(record.fileName);
                    
                    // 为每个样本记录基因和抗生素（已去重）
                    if (!monthly[month].genesPerSample[record.fileName]) {
                        monthly[month].genesPerSample[record.fileName] = new Set();
                    }
                    if (!monthly[month].antibioticsPerSample[record.fileName]) {
                        monthly[month].antibioticsPerSample[record.fileName] = new Set();
                    }
                    
                    monthly[month].genesPerSample[record.fileName].add(record.gene);
                    monthly[month].antibioticsPerSample[record.fileName].add(record.antibiotic);
                }
            });
            
            // 统计每个基因和抗生素在多少个样本中出现
            Object.keys(monthly).forEach(month => {
                monthly[month].totalSamples = monthly[month].samples.size;
                
                // 统计基因出现在多少个样本中
                Object.values(monthly[month].genesPerSample).forEach(geneSet => {
                    geneSet.forEach(gene => {
                        if (!monthly[month].genes[gene]) {
                            monthly[month].genes[gene] = 0;
                        }
                        monthly[month].genes[gene]++;
                    });
                });
                
                // 统计抗生素出现在多少个样本中
                Object.values(monthly[month].antibioticsPerSample).forEach(antibioticSet => {
                    antibioticSet.forEach(antibiotic => {
                        if (!monthly[month].antibiotics[antibiotic]) {
                            monthly[month].antibiotics[antibiotic] = 0;
                        }
                        monthly[month].antibiotics[antibiotic]++;
                    });
                });
            });
            
            return monthly;
        }

        // 更新统计信息
        function updateStats(data, monthlyData) {
            const totalSamples = new Set(data.map(d => d.fileName)).size;
            const totalGenes = new Set(data.map(d => d.gene)).size;
            const totalAntibiotics = new Set(data.map(d => d.antibiotic)).size;
            const timeSpan = Object.keys(monthlyData).length;
            
            document.getElementById('totalSamples').textContent = totalSamples;
            document.getElementById('totalGenes').textContent = totalGenes;
            document.getElementById('totalAntibiotics').textContent = totalAntibiotics;
            document.getElementById('timeSpan').textContent = timeSpan;
        }

        // 更新基因过滤器选项
        function updateGeneFilter(data) {
            const geneSelect = document.getElementById('geneFilter');
            const allGenes = [...new Set(data.map(d => d.gene))].sort();
            
            // 清空现有选项，保留"显示所有基因"选项
            geneSelect.innerHTML = '<option value="all">显示所有基因</option>';
            
            allGenes.forEach(gene => {
                const option = document.createElement('option');
                option.value = gene;
                option.textContent = gene;
                geneSelect.appendChild(option);
            });
        }

        // 创建基因流行趋势图
        function createGeneChart(monthlyData) {
            const ctx = document.getElementById('geneChart').getContext('2d');
            
            // 获取选择的基因过滤器
            const geneFilter = document.getElementById('geneFilter').value;
            const topCount = document.getElementById('topGenesCount').value;
            
            // 获取所有基因并按总出现次数排序
            const geneStats = {};
            Object.values(monthlyData).forEach(month => {
                Object.entries(month.genes).forEach(([gene, count]) => {
                    geneStats[gene] = (geneStats[gene] || 0) + count;
                });
            });
            
            let sortedGenes = Object.entries(geneStats)
                .sort((a, b) => b[1] - a[1])
                .map(([gene]) => gene);
            
            // 应用基因过滤器
            if (geneFilter !== 'all') {
                const selectedGenes = Array.from(document.getElementById('geneFilter').selectedOptions)
                    .map(option => option.value)
                    .filter(value => value !== 'all');
                if (selectedGenes.length > 0) {
                    sortedGenes = sortedGenes.filter(gene => selectedGenes.includes(gene));
                }
            }
            
            // 应用数量限制
            if (topCount !== 'all') {
                sortedGenes = sortedGenes.slice(0, parseInt(topCount));
            }
            
            const months = Object.keys(monthlyData).sort();
            const colors = generateColors(sortedGenes.length);
            
            const datasets = sortedGenes.map((gene, index) => ({
                label: gene,
                data: months.map(month => {
                    const count = monthlyData[month].genes[gene] || 0;
                    const totalSamples = monthlyData[month].totalSamples || 1;
                    return totalSamples > 0 ? parseFloat(((count / totalSamples) * 100).toFixed(1)) : 0;
                }),
                borderColor: colors[index],
                backgroundColor: colors[index].replace('0.8', '0.3'),
                fill: false,
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6
            }));
            
            if (geneChart) {
                geneChart.destroy();
            }
            
            geneChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '耐药基因月度流行率 (%)',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return '月份: ' + context[0].label;
                                },
                                label: function(context) {
                                    const month = context.label;
                                    const gene = context.dataset.label;
                                    const rate = context.parsed.y;
                                    const count = monthlyData[month].genes[gene] || 0;
                                    const total = monthlyData[month].totalSamples;
                                    return `${gene}: ${rate}% (${count}/${total})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '流行率 (%)',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // 更新抗生素过滤器选项
        function updateAntibioticFilter(data) {
            const antibioticSelect = document.getElementById('antibioticFilter');
            const allAntibiotics = [...new Set(data.map(d => d.antibiotic))].sort();
            
            // 清空现有选项，保留"显示所有抗生素"选项
            antibioticSelect.innerHTML = '<option value="all">显示所有抗生素</option>';
            
            allAntibiotics.forEach(antibiotic => {
                const option = document.createElement('option');
                option.value = antibiotic;
                option.textContent = antibiotic;
                antibioticSelect.appendChild(option);
            });
        }

        // 创建抗生素流行趋势图
        function createAntibioticChart(monthlyData) {
            const ctx = document.getElementById('antibioticChart').getContext('2d');
            
            // 获取选择的抗生素过滤器
            const antibioticFilter = document.getElementById('antibioticFilter').value;
            const topCount = document.getElementById('topAntibioticsCount').value;
            
            // 获取所有抗生素并按总出现次数排序
            const antibioticStats = {};
            Object.values(monthlyData).forEach(month => {
                Object.entries(month.antibiotics).forEach(([antibiotic, count]) => {
                    antibioticStats[antibiotic] = (antibioticStats[antibiotic] || 0) + count;
                });
            });
            
            let sortedAntibiotics = Object.entries(antibioticStats)
                .sort((a, b) => b[1] - a[1])
                .map(([antibiotic]) => antibiotic);
            
            // 应用抗生素过滤器
            if (antibioticFilter !== 'all') {
                const selectedAntibiotics = Array.from(document.getElementById('antibioticFilter').selectedOptions)
                    .map(option => option.value)
                    .filter(value => value !== 'all');
                if (selectedAntibiotics.length > 0) {
                    sortedAntibiotics = sortedAntibiotics.filter(antibiotic => selectedAntibiotics.includes(antibiotic));
                }
            }
            
            // 应用数量限制
            if (topCount !== 'all') {
                sortedAntibiotics = sortedAntibiotics.slice(0, parseInt(topCount));
            }
            
            const months = Object.keys(monthlyData).sort();
            const colors = generateColors(sortedAntibiotics.length);
            
            const datasets = sortedAntibiotics.map((antibiotic, index) => ({
                label: antibiotic,
                data: months.map(month => {
                    const count = monthlyData[month].antibiotics[antibiotic] || 0;
                    const totalSamples = monthlyData[month].totalSamples || 1;
                    return totalSamples > 0 ? parseFloat(((count / totalSamples) * 100).toFixed(1)) : 0;
                }),
                borderColor: colors[index],
                backgroundColor: colors[index].replace('0.8', '0.3'),
                fill: false,
                tension: 0.1,
                pointRadius: 4,
                pointHoverRadius: 6
            }));
            
            if (antibioticChart) {
                antibioticChart.destroy();
            }
            
            antibioticChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '抗生素耐药表型月度流行率 (%)',
                            font: { size: 16 }
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return '月份: ' + context[0].label;
                                },
                                label: function(context) {
                                    const month = context.label;
                                    const antibiotic = context.dataset.label;
                                    const rate = context.parsed.y;
                                    const count = monthlyData[month].antibiotics[antibiotic] || 0;
                                    const total = monthlyData[month].totalSamples;
                                    return `${antibiotic}: ${rate}% (${count}/${total})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '流行率 (%)',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份',
                                font: { size: 12 }
                            },
                            grid: { alpha: 0.3 }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // 创建样本数量统计图
        function createSampleChart(monthlyData) {
            const ctx = document.getElementById('sampleChart').getContext('2d');
            
            const months = Object.keys(monthlyData).sort();
            const sampleCounts = months.map(month => monthlyData[month].totalSamples);
            
            if (sampleChart) {
                sampleChart.destroy();
            }
            
            sampleChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '样本数量',
                        data: sampleCounts,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '样本数量'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份'
                            }
                        }
                    }
                }
            });
        }

        // 创建热力图（简化版）
        function createHeatmapChart(data) {
            const ctx = document.getElementById('heatmapChart').getContext('2d');
            
            // 计算基因-抗生素关联
            const associations = {};
            data.forEach(record => {
                const key = `${record.gene}-${record.antibiotic}`;
                associations[key] = (associations[key] || 0) + 1;
            });
            
            // 获取前10个最常见的关联
            const topAssociations = Object.entries(associations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (heatmapChart) {
                heatmapChart.destroy();
            }
            
            heatmapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topAssociations.map(([key]) => key.replace('-', ' → ')),
                    datasets: [{
                        label: '出现次数',
                        data: topAssociations.map(([, count]) => count),
                        backgroundColor: generateColors(topAssociations.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '出现次数'
                            }
                        }
                    }
                }
            });
        }

        // 显示分析结果
        function showAnalysis(data) {
            allData = data;
            monthlyData = processMonthlyData(data);
            
            // 更新过滤器选项
            updateGeneFilter(data);
            updateAntibioticFilter(data);
            updateMonthSelector(monthlyData);
            
            // 更新统计信息
            updateStats(data, monthlyData);
            
            // 创建图表
            createGeneChart(monthlyData);
            createAntibioticChart(monthlyData);
            createSampleChart(monthlyData);
            createHeatmapChart(data);
            
            // 添加事件监听器
            setupEventListeners();
            
            // 显示仪表板
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // 更新月份选择器
        function updateMonthSelector(monthlyData) {
            const monthSelector = document.getElementById('monthSelector');
            const months = Object.keys(monthlyData).sort();
            
            // 清空现有选项
            monthSelector.innerHTML = '<option value="">请选择月份</option>';
            
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                const sampleCount = monthlyData[month].totalSamples;
                option.textContent = `${month} (${sampleCount}个样本)`;
                monthSelector.appendChild(option);
            });
        }

        // 显示月度详情
        function showMonthlyDetails(month) {
            if (!month || !monthlyData[month]) {
                document.getElementById('monthlyDetails').style.display = 'none';
                return;
            }

            const monthData = monthlyData[month];
            document.getElementById('monthlyDetails').style.display = 'block';

            // 显示高风险基因
            const geneEntries = Object.entries(monthData.genes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let highRiskGenesHtml = '';
            if (geneEntries.length > 0) {
                geneEntries.forEach(([gene, count]) => {
                    const rate = ((count / monthData.totalSamples) * 100).toFixed(1);
                    highRiskGenesHtml += `<div style="margin: 5px 0;"><strong>${gene}</strong>: ${rate}% (${count}/${monthData.totalSamples})</div>`;
                });
            } else {
                highRiskGenesHtml = '<div style="color: #28a745;">本月无耐药基因检出</div>';
            }
            document.getElementById('highRiskGenes').innerHTML = highRiskGenesHtml;

            // 显示需要避免的抗生素
            const antibioticEntries = Object.entries(monthData.antibiotics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let avoidAntibioticsHtml = '';
            if (antibioticEntries.length > 0) {
                avoidAntibioticsHtml += '<div style="margin-bottom: 10px; font-size: 14px; color: #721c24;"><strong>建议避免使用以下抗生素：</strong></div>';
                antibioticEntries.forEach(([antibiotic, count]) => {
                    const rate = ((count / monthData.totalSamples) * 100).toFixed(1);
                    let riskLevel = '中等风险';
                    let riskColor = '#ffc107';
                    if (rate >= 70) {
                        riskLevel = '高风险';
                        riskColor = '#dc3545';
                    } else if (rate >= 40) {
                        riskLevel = '中高风险';
                        riskColor = '#fd7e14';
                    } else if (rate < 20) {
                        riskLevel = '低风险';
                        riskColor = '#28a745';
                    }
                    avoidAntibioticsHtml += `
                        <div style="margin: 8px 0; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${antibiotic}</strong>
                                <span style="color: ${riskColor}; font-weight: bold;">${riskLevel}</span>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">耐药率: ${rate}% (${count}/${monthData.totalSamples}个样本)</div>
                        </div>
                    `;
                });
            } else {
                avoidAntibioticsHtml = '<div style="color: #28a745;">本月无抗生素耐药检出</div>';
            }
            document.getElementById('avoidAntibiotics').innerHTML = avoidAntibioticsHtml;

            // 创建月度基因图表
            createMonthlyGeneChart(month, monthData);
            createMonthlyAntibioticChart(month, monthData);
        }

        // 创建月度基因图表
        function createMonthlyGeneChart(month, monthData) {
            const ctx = document.getElementById('monthlyGeneChart').getContext('2d');
            
            const geneEntries = Object.entries(monthData.genes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (window.monthlyGeneChart) {
                window.monthlyGeneChart.destroy();
            }
            
            window.monthlyGeneChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: geneEntries.map(([gene]) => gene),
                    datasets: [{
                        data: geneEntries.map(([, count]) => count),
                        backgroundColor: generateColors(geneEntries.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${month} 耐药基因分布`
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // 创建月度抗生素图表
        function createMonthlyAntibioticChart(month, monthData) {
            const ctx = document.getElementById('monthlyAntibioticChart').getContext('2d');
            
            const antibioticEntries = Object.entries(monthData.antibiotics)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            if (window.monthlyAntibioticChart) {
                window.monthlyAntibioticChart.destroy();
            }
            
            window.monthlyAntibioticChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: antibioticEntries.map(([antibiotic]) => antibiotic),
                    datasets: [{
                        label: '耐药率 (%)',
                        data: antibioticEntries.map(([, count]) => 
                            ((count / monthData.totalSamples) * 100).toFixed(1)
                        ),
                        backgroundColor: antibioticEntries.map(([, count]) => {
                            const rate = (count / monthData.totalSamples) * 100;
                            if (rate >= 70) return '#dc3545';
                            if (rate >= 40) return '#fd7e14';
                            if (rate >= 20) return '#ffc107';
                            return '#28a745';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${month} 抗生素耐药率`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '耐药率 (%)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 月份选择器事件
            document.getElementById('monthSelector').addEventListener('change', (e) => {
                showMonthlyDetails(e.target.value);
            });
            
            // 基因图表控件事件
            document.getElementById('geneFilter').addEventListener('change', () => {
                createGeneChart(monthlyData);
            });
            
            document.getElementById('topGenesCount').addEventListener('change', () => {
                createGeneChart(monthlyData);
            });
            
            // 抗生素图表控件事件
            document.getElementById('antibioticFilter').addEventListener('change', () => {
                createAntibioticChart(monthlyData);
            });
            
            document.getElementById('topAntibioticsCount').addEventListener('change', () => {
                createAntibioticChart(monthlyData);
            });
        }

        // 初始化应用
        async function initApp() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                
                // 设置测试按钮事件
                document.getElementById('testFolderSelection').addEventListener('click', async () => {
                    try {
                        document.getElementById('loading').innerHTML = '<p>正在测试文件夹选择功能...</p>';
                        await testFolderSelection();
                    } catch (error) {
                        console.error('测试失败:', error);
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = '测试失败: ' + error.message;
                    }
                });
                
                // 设置强制加载按钮事件
                document.getElementById('loadAllFiles').addEventListener('click', async () => {
                    try {
                        document.getElementById('loading').innerHTML = '<p>正在强制读取所有文件，请稍候...</p>';
                        const realData = await loadAllFiles();
                        if (realData.length > 0) {
                            allData = realData;
                            processData();
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('dashboard').style.display = 'block';
                        } else {
                            throw new Error('未找到有效数据');
                        }
                    } catch (error) {
                        console.error('加载失败:', error);
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = '加载失败: ' + error.message;
                        
                        // 重置界面
                        document.getElementById('loading').innerHTML = `
                            <p>请选择您的AMRFinder数据文件夹进行分析</p>
                            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                📁 选择AMRFinder文件夹
                            </button>
                            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                🔍 测试文件夹选择
                            </button>
                            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                📂 强制加载所有文件
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">选择包含528个TSV文件的amrfinder_del文件夹</p>
                        `;
                        // 重新绑定按钮事件
                        setTimeout(() => {
                            const loadButton = document.getElementById('loadRealData');
                            const testButton = document.getElementById('testFolderSelection');
                            const allButton = document.getElementById('loadAllFiles');
                            
                            if (loadButton) {
                                loadButton.addEventListener('click', arguments.callee);
                            }
                            
                            if (testButton) {
                                testButton.addEventListener('click', async () => {
                                    try {
                                        document.getElementById('loading').innerHTML = '<p>正在测试文件夹选择功能...</p>';
                                        await testFolderSelection();
                                    } catch (error) {
                                        console.error('测试失败:', error);
                                        document.getElementById('error').style.display = 'block';
                                        document.getElementById('error').textContent = '测试失败: ' + error.message;
                                    }
                                });
                            }
                            
                            if (allButton) {
                                allButton.addEventListener('click', arguments.callee);
                            }
                        }, 100);
                    }
                });
                
                // 设置按钮事件
                document.getElementById('loadRealData').addEventListener('click', async () => {
                    try {
                        document.getElementById('loading').innerHTML = '<p>正在读取TSV文件，请稍候...</p>';
                        const realData = await loadRealData();
                        if (realData.length > 0) {
                            allData = realData;
                            showAnalysis(allData);
                        } else {
                            throw new Error('未找到有效的TSV数据，请确保选择了包含TSV文件的文件夹');
                        }
                    } catch (error) {
                        console.error('加载数据失败:', error);
                        document.getElementById('error').style.display = 'block';
                        document.getElementById('error').textContent = '加载数据失败: ' + error.message + '。请重新选择正确的文件夹。';
                        // 重置加载界面
                        document.getElementById('loading').innerHTML = `
                            <p>请选择您的AMRFinder数据文件夹进行分析</p>
                            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                📁 选择AMRFinder文件夹
                            </button>
                            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                🔍 测试文件夹选择
                            </button>
                            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                📂 强制加载所有文件
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">选择包含528个TSV文件的amrfinder_del文件夹</p>
                        `;
                        // 重新绑定按钮事件
                        setTimeout(() => {
                            const loadButton = document.getElementById('loadRealData');
                            const testButton = document.getElementById('testFolderSelection');
                            const allButton = document.getElementById('loadAllFiles');
                            
                            if (loadButton) {
                                loadButton.addEventListener('click', arguments.callee);
                            }
                            
                            if (testButton) {
                                testButton.addEventListener('click', async () => {
                                    try {
                                        document.getElementById('loading').innerHTML = '<p>正在测试文件夹选择功能...</p>';
                                        await testFolderSelection();
                                    } catch (error) {
                                        console.error('测试失败:', error);
                                        document.getElementById('error').style.display = 'block';
                                        document.getElementById('error').textContent = '测试失败: ' + error.message;
                                    }
                                });
                            }
                            
                            if (allButton) {
                                allButton.addEventListener('click', async () => {
                                    try {
                                        document.getElementById('loading').innerHTML = '<p>正在强制读取所有文件，请稍候...</p>';
                                        const realData = await loadAllFiles();
                                        if (realData.length > 0) {
                                            allData = realData;
                                            processData();
                                            document.getElementById('loading').style.display = 'none';
                                            document.getElementById('dashboard').style.display = 'block';
                                        } else {
                                            throw new Error('未找到有效数据');
                                        }
                                    } catch (error) {
                                        console.error('加载失败:', error);
                                        document.getElementById('error').style.display = 'block';
                                        document.getElementById('error').textContent = '加载失败: ' + error.message;
                                    }
                                });
                            }
                        }, 100);
                    }
                });
                
            } catch (error) {
                console.error('初始化失败:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = '初始化失败: ' + error.message;
            }
        }

        // 数据导出功能
        function exportData(format) {
            if (!allData || allData.length === 0) {
                alert('没有可导出的数据，请先进行分析');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportCSV(timestamp);
                    break;
                case 'excel':
                    alert('Excel导出功能开发中，请使用CSV格式');
                    break;
                case 'json':
                    exportJSON(timestamp);
                    break;
            }
        }
        
        // 导出CSV格式
        function exportCSV(timestamp) {
            let csvContent = 'Date,Month,Strain,Gene,Antibiotic\n';
            
            allData.forEach(record => {
                csvContent += `${record.date},${record.month},${record.strain},${record.gene},${record.antibiotic}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `amr_trend_analysis_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 导出JSON格式
        function exportJSON(timestamp) {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalSamples: new Set(allData.map(d => d.fileName)).size,
                    totalGenes: new Set(allData.map(d => d.gene)).size,
                    totalAntibiotics: new Set(allData.map(d => d.antibiotic)).size,
                    timeSpan: Object.keys(monthlyData).length
                },
                rawData: allData,
                monthlyStatistics: monthlyData
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `amr_analysis_complete_${timestamp}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 生成报告
        function generateReport(type) {
            if (!allData || allData.length === 0) {
                alert('没有可分析的数据，请先进行分析');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[0];
            
            switch(type) {
                case 'summary':
                    generateSummaryReport(timestamp);
                    break;
                case 'detailed':
                    generateDetailedReport(timestamp);
                    break;
                case 'medical':
                    generateMedicalReport(timestamp);
                    break;
            }
        }
        
        // 生成摘要报告
        function generateSummaryReport(timestamp) {
            const totalSamples = new Set(allData.map(d => d.fileName)).size;
            const totalGenes = new Set(allData.map(d => d.gene)).size;
            const totalAntibiotics = new Set(allData.map(d => d.antibiotic)).size;
            const timeSpan = Object.keys(monthlyData).length;
            
            // 获取最常见的基因和抗生素
            const geneFreq = {};
            const antibioticFreq = {};
            
            allData.forEach(record => {
                geneFreq[record.gene] = (geneFreq[record.gene] || 0) + 1;
                antibioticFreq[record.antibiotic] = (antibioticFreq[record.antibiotic] || 0) + 1;
            });
            
            const topGenes = Object.entries(geneFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topAntibiotics = Object.entries(antibioticFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const report = `
耐药基因流行趋势分析摘要报告
生成时间: ${new Date().toLocaleString()}
分析时间段: ${timeSpan}个月

=== 基本统计 ===
• 总样本数: ${totalSamples}
• 耐药基因种类: ${totalGenes}
• 抗生素类型: ${totalAntibiotics}
• 监测时长: ${timeSpan}个月

=== 主要发现 ===
• 最常见的耐药基因:
${topGenes.map(([gene, count]) => `  - ${gene}: ${count}次检出`).join('\n')}

• 最常见的抗生素耐药:
${topAntibiotics.map(([antibiotic, count]) => `  - ${antibiotic}: ${count}次检出`).join('\n')}

=== 建议 ===
• 重点监控高频耐药基因
• 谨慎使用高耐药率抗生素
• 持续监测耐药趋势变化

报告生成: 耐药基因分析平台
`;
            
            downloadTextFile(report, `amr_summary_report_${timestamp}.txt`);
        }
        
        // 生成详细报告
        function generateDetailedReport(timestamp) {
            const report = `
耐药基因流行趋势详细分析报告
=================================

生成时间: ${new Date().toLocaleString()}
数据来源: AMRFinder分析结果
分析样本: ${new Set(allData.map(d => d.fileName)).size}个

1. 数据概览
-----------
总基因记录数: ${allData.length}
独特基因种类: ${new Set(allData.map(d => d.gene)).size}
抗生素类别: ${new Set(allData.map(d => d.antibiotic)).size}
监测时间跨度: ${Object.keys(monthlyData).length}个月

2. 月度统计详情
--------------
${Object.entries(monthlyData).map(([month, data]) => 
    `${month}: ${data.totalSamples}个样本, ${Object.keys(data.genes).length}种基因`
).join('\n')}

3. 基因分布分析
--------------
${Object.entries(
    allData.reduce((acc, record) => {
        acc[record.gene] = (acc[record.gene] || 0) + 1;
        return acc;
    }, {})
).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([gene, count]) => 
    `${gene}: ${count}次 (${((count/allData.length)*100).toFixed(1)}%)`
).join('\n')}

4. 抗生素耐药分析
---------------
${Object.entries(
    allData.reduce((acc, record) => {
        acc[record.antibiotic] = (acc[record.antibiotic] || 0) + 1;
        return acc;
    }, {})
).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([antibiotic, count]) => 
    `${antibiotic}: ${count}次 (${((count/allData.length)*100).toFixed(1)}%)`
).join('\n')}

报告生成: 耐药基因分析平台
版本: 2.0.0
`;
            
            downloadTextFile(report, `amr_detailed_report_${timestamp}.txt`);
        }
        
        // 生成医疗建议报告
        function generateMedicalReport(timestamp) {
            // 分析高风险抗生素
            const antibioticFreq = {};
            allData.forEach(record => {
                antibioticFreq[record.antibiotic] = (antibioticFreq[record.antibiotic] || 0) + 1;
            });
            
            const highRiskAntibiotics = Object.entries(antibioticFreq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const report = `
耐药基因分析医疗建议报告
====================

生成时间: ${new Date().toLocaleString()}
基于数据: ${allData.length}条基因记录分析

🚨 高风险抗生素使用建议
---------------------
以下抗生素类别检出高耐药率，建议谨慎使用：

${highRiskAntibiotics.map(([antibiotic, count], index) => {
    const percentage = ((count/allData.length)*100).toFixed(1);
    let riskLevel = '中等风险';
    if (percentage > 15) riskLevel = '高风险';
    else if (percentage < 5) riskLevel = '低风险';
    
    return `${index + 1}. ${antibiotic}
   检出率: ${percentage}%
   风险等级: ${riskLevel}
   建议: ${percentage > 15 ? '避免首选使用，需要药敏试验指导' : 
          percentage > 5 ? '谨慎使用，建议药敏试验' : '可考虑使用'}`;
}).join('\n\n')}

💊 临床用药建议
--------------
1. 经验性治疗应避免使用高耐药率抗生素
2. 重症感染建议联合用药
3. 定期监测本地耐药流行情况
4. 加强抗生素管理和感控措施

📊 监测建议
----------
1. 持续监测耐药趋势变化
2. 重点关注新发耐药基因
3. 建立本地耐药数据库
4. 定期更新治疗指南

⚠️ 免责声明
----------
本报告仅供参考，具体用药请遵循临床医师指导和药敏试验结果。

报告生成: 耐药基因分析平台
技术支持: AMRFinder数据库
`;
            
            downloadTextFile(report, `amr_medical_advice_${timestamp}.txt`);
        }
        
        // 下载文本文件
        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 强制加载所有文件（忽略扩展名检查）
        async function loadAllFiles() {
            const data = [];
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;

            return new Promise((resolve, reject) => {
                fileInput.addEventListener('change', async (event) => {
                    const allFiles = Array.from(event.target.files);
                    console.log(`强制加载模式: 找到 ${allFiles.length} 个文件`);
                    
                    // 尝试处理所有文件，不管扩展名
                    let processedFiles = 0;
                    let validFiles = 0;
                    let filteredGenesCount = 0;
                    const totalFiles = allFiles.length;

                    for (const file of allFiles) {
                        try {
                            // 只处理看起来像TSV文件的文件（包含日期格式的文件名）
                            const fileInfo = parseFileName(file.name);
                            if (!fileInfo && !file.name.match(/\d{4}-\d{2}-\d{2}/)) {
                                processedFiles++;
                                continue;
                            }

                            const text = await file.text();
                            const lines = text.split('\n');
                            
                            // 检查是否像TSV文件（有制表符分隔的列）
                            let hasTabSeparatedData = false;
                            for (let i = 0; i < Math.min(5, lines.length); i++) {
                                if (lines[i].includes('\t') && lines[i].split('\t').length > 5) {
                                    hasTabSeparatedData = true;
                                    break;
                                }
                            }
                            
                            if (!hasTabSeparatedData) {
                                processedFiles++;
                                continue;
                            }
                            
                            // 用于当前文件的去重
                            const fileGenes = new Set();
                            const fileAntibiotics = new Set();
                            const fileCombinations = new Set();
                            
                            // 跳过标题行
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const columns = line.split('\t');
                                if (columns.length >= 12) {
                                    const geneSymbol = columns[5]; // Gene symbol列
                                    const subclass = columns[11];  // Subclass列
                                    
                                    if (geneSymbol && subclass && geneSymbol !== 'NA' && subclass !== 'NA') {
                                        // 记录所有基因，包括oqx和fosA（用于完整分析）
                                        if (geneSymbol.toLowerCase().includes('oqx') || 
                                            geneSymbol.toLowerCase().includes('fosa')) {
                                            filteredGenesCount++;
                                        }
                                        
                                        // 添加到当前文件的集合中（自动去重）
                                        fileGenes.add(geneSymbol);
                                        fileAntibiotics.add(subclass);
                                        fileCombinations.add(`${geneSymbol}|||${subclass}`);
                                    }
                                }
                            }
                            
                            // 将去重后的数据添加到总数据中
                            let genesFoundInFile = 0;
                            const fileInfoToUse = fileInfo || {
                                date: file.name.match(/(\d{4}-\d{2}-\d{2})/)?.[1] || '2023-01-01',
                                strain: file.name.replace(/\.\w+$/, '').replace(/^\d{4}-\d{2}-\d{2}-?/, '') || 'unknown',
                                month: (file.name.match(/(\d{4}-\d{2})/)?.[1] || '2023-01') // YYYY-MM格式
                            };
                            
                            fileCombinations.forEach(combination => {
                                const [geneSymbol, subclass] = combination.split('|||');
                                data.push({
                                    fileName: file.name,
                                    date: fileInfoToUse.date,
                                    month: fileInfoToUse.month,
                                    strain: fileInfoToUse.strain,
                                    geneSymbol: geneSymbol,
                                    subclass: subclass
                                });
                                genesFoundInFile++;
                            });
                            
                            if (genesFoundInFile > 0) {
                                validFiles++;
                            }
                            
                            processedFiles++;
                            // 更新进度
                            const progress = Math.round((processedFiles / totalFiles) * 100);
                            document.getElementById('loading').innerHTML = `
                                <p>正在强制处理文件: ${processedFiles}/${totalFiles} (${progress}%)</p>
                                <p>已找到 ${validFiles} 个有效文件，共 ${data.length} 条基因记录</p>
                                <p>包含 ${filteredGenesCount} 条oqx/fosA基因记录</p>
                            `;
                            
                        } catch (error) {
                            console.warn(`处理文件 ${file.name} 时出错:`, error);
                            processedFiles++;
                        }
                    }

                    console.log(`强制加载完成: ${validFiles} 个有效文件，共 ${data.length} 条基因记录，包含 ${filteredGenesCount} 条oqx/fosA基因记录`);
                    
                    if (data.length === 0) {
                        reject(new Error(`处理了 ${processedFiles} 个文件，但未找到有效的基因数据。请检查文件格式是否正确。`));
                    } else {
                        resolve(data);
                    }
                });

                fileInput.click();
            });
        }
        
        // 测试文件夹选择功能
        async function testFolderSelection() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;

            return new Promise((resolve, reject) => {
                fileInput.addEventListener('change', async (event) => {
                    try {
                        const allFiles = Array.from(event.target.files);
                        
                        // 详细的扩展名分析
                        const extensionMap = {};
                        allFiles.forEach(file => {
                            const name = file.name.toLowerCase();
                            const parts = name.split('.');
                            const ext = parts.length > 1 ? '.' + parts[parts.length - 1] : '无扩展名';
                            extensionMap[ext] = (extensionMap[ext] || 0) + 1;
                        });
                        
                        // 使用同样的TSV检测逻辑
                        const tsvFiles = allFiles.filter(file => {
                            const name = file.name.toLowerCase();
                            return name.endsWith('.tsv') || 
                                   name.endsWith('.TSV') || 
                                   name.includes('.tsv') ||
                                   (name.includes('tsv') && name.includes('-'));
                        });
                        
                        console.log('测试结果:');
                        console.log('- 总文件数:', allFiles.length);
                        console.log('- TSV文件数:', tsvFiles.length);
                        console.log('- 前10个文件:', allFiles.slice(0, 10).map(f => f.name));
                        console.log('- 前10个TSV文件:', tsvFiles.slice(0, 10).map(f => f.name));
                        
                        let message = `测试完成！\n\n`;
                        message += `📁 总文件数: ${allFiles.length}\n`;
                        message += `📄 TSV文件数: ${tsvFiles.length}\n\n`;
                        message += `📊 文件扩展名统计:\n`;
                        Object.entries(extensionMap).forEach(([ext, count]) => {
                            message += `  ${ext}: ${count}个\n`;
                        });
                        message += `\n`;
                        
                        if (tsvFiles.length > 0) {
                            message += `✅ 文件夹选择功能正常！\n`;
                            message += `前几个TSV文件:\n`;
                            message += tsvFiles.slice(0, 5).map(f => `• ${f.name}`).join('\n');
                            
                            if (tsvFiles.length > 5) {
                                message += `\n... 还有 ${tsvFiles.length - 5} 个文件`;
                            }
                        } else {
                            message += `❌ 未找到TSV文件\n`;
                            message += `请确保选择了正确的文件夹。\n\n`;
                            message += `文件夹中的文件类型:\n`;
                            const extensions = [...new Set(allFiles.map(f => {
                                const ext = f.name.split('.').pop();
                                return ext ? `.${ext}` : '无扩展名';
                            }))];
                            message += extensions.slice(0, 10).join(', ');
                        }
                        
                        alert(message);
                        
                        // 重置加载界面
                        document.getElementById('loading').innerHTML = `
                            <p>请选择您的AMRFinder数据文件夹进行分析</p>
                            <button id="loadRealData" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                📁 选择AMRFinder文件夹
                            </button>
                            <button id="testFolderSelection" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                🔍 测试文件夹选择
                            </button>
                            <button id="loadAllFiles" style="margin-top: 10px; margin-left: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                                📂 强制加载所有文件
                            </button>
                            <p style="margin-top: 10px; font-size: 14px; opacity: 0.8;">选择包含528个TSV文件的amrfinder_del文件夹</p>
                        `;
                        
                        resolve(tsvFiles.length);
                        
                    } catch (error) {
                        reject(error);
                    }
                });

                fileInput.click();
            });
        }
        
        // 切换导出面板显示
        function toggleExportSection() {
            const exportSection = document.getElementById('exportSection');
            if (exportSection.style.display === 'none') {
                exportSection.style.display = 'block';
                exportSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                exportSection.style.display = 'none';
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
